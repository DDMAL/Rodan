# FROM postgres:latest
FROM postgres:9.6
EXPOSE 5432

RUN apt-get update \
  # && apt-get install -y postgresql-plpython-${PG_MAJOR} python-pip \
  && apt-get install -y postgresql-plpython-9.6 python3-pip \
  && rm -rf /var/lib/apt/lists/*

# Installing the postgresql-plpython overrides the postgresql.conf.sample file generated by the postgres Dockerfile,
# which then causes the postgres.conf to not have the listen_addresses='*' setting, which is required in order to
# connect to the database from another machine. Overcome this by removing the postgresql.conf.sample created by
# postgresql-plpython and re-linking the Dockerfile's postgresql.conf.sample.
RUN rm /usr/share/postgresql/${PG_MAJOR}/postgresql.conf.sample \
  && ln -sv /usr/share/postgresql/postgresql.conf.sample /usr/share/postgresql/$PG_MAJOR/

RUN pip install redis

COPY ./postgres/maintenance /usr/local/bin/maintenance
RUN chmod +x /usr/local/bin/maintenance/*
RUN mv /usr/local/bin/maintenance/* /usr/local/bin \
  && rmdir /usr/local/bin/maintenance \
  && mkdir /backups

ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["postgres"]
