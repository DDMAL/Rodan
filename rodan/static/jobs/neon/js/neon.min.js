Toe={Model:{},Ctrl:{},View:{}};(function(a){a.arraysEqual=function(b,c){if(b.length!=c.length)return!1;var d=!0;a.each(b,function(a,b){if(b!=c[a])return d=!1});return d}})(jQuery);(function(a){a.truncateFloat=function(a){return 0<a?Math.floor(a):Math.ceil(a)}})(jQuery);Toe.validBoundingBox=function(a){return a[0]<=a[2]&&a[1]<=a[3]};Toe.neumaticChroma="abcdefg".split("");Toe.Model.Clef=function(a,b){this.shape=a.toLowerCase();this.name=Toe.Model.Clef.Type[this.shape];if(void 0==this.name)throw Error("Clef: unknown clef shape");var c=null;"c"==a?c=0:"f"==a&&(c=2);this.props={staffPos:c,interact:!0};$.extend(this.props,b);this.zone={};this.staff=null};Toe.Model.Clef.Type={c:"Doh Clef",f:"Fah Clef"};Toe.Model.Clef.prototype.constructor=Toe.Model.Clef;Toe.Model.Clef.prototype.setID=function(a){this.id=a};
Toe.Model.Clef.prototype.setStaff=function(a){if(!(a instanceof Toe.Model.Staff))throw Error("Clef: invalid staff reference");this.staff=a};Toe.Model.Clef.prototype.setShape=function(a){this.shape=a.toLowerCase();this.name=Toe.Model.Clef.Type[this.shape];if(void 0==this.name)throw Error("Clef: unknown clef shape");this.staff.updatePitchedElements({clef:this,custos:!1});$(this).trigger("vUpdateShape",[this])};
Toe.Model.Clef.prototype.setStaffPosition=function(a){this.props.staffPos!=a&&(this.props.staffPos=a,this.staff.updatePitchedElements({clef:this,custos:!1}),$(this).trigger("vUpdateStaffPosition",[this]))};Toe.Model.Clef.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Clef: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};Toe.Model.Clef.prototype.selectDrawing=function(){$(this).trigger("vSelectDrawing")};Toe.Ctrl.ClefController=function(a,b){$(a).bind("mUpdateBoundingBox",function(b,d){var e=d.left-d.currentWidth/2,f=d.top-d.currentHeight/2;a.setBoundingBox([e,f,e+d.currentWidth,f+d.currentHeight])});$(a).bind("vRenderClef",function(a,d){b.renderClef(d)});$(a).bind("vUpdateShape",function(a,d){b.updateShape(d)});$(a).bind("vUpdateStaffPosition",function(a,d){b.updateStaffPosition(d)});$(a).bind("vSelectDrawing",function(a){b.selectDrawing()})};Toe.Ctrl.ClefController.prototype.constructor=Toe.Ctrl.ClefController;Toe.View.ClefView=function(a){this.rendEng=a;this.drawing=null};Toe.View.ClefView.prototype.constructor=Toe.View.ClefView;
Toe.View.ClefView.prototype.drawClef=function(a){if(!this.rendEng)throw Error("Clef: Invalid render context");var b=a.staff,c=null;switch(a.shape){case "c":c="c_clef";break;case "f":c="f_clef"}var c=this.rendEng.getGlyph(c),d=a.zone.ulx+c.centre[0],b=b.zone.uly-a.props.staffPos*b.delta_y/2;"f"==a.shape&&(b+=0.34*c.centre[1]);b=c.clone().set({left:d,top:b});this.drawing=this.rendEng.draw({fixed:[],modify:[b]},{selectable:a.props.interact,group:!0,eleRef:a})[0];$(a).trigger("mUpdateBoundingBox",this.drawing)};
Toe.View.ClefView.prototype.renderClef=function(a){this.drawClef(a)};Toe.View.ClefView.prototype.updateShape=function(a){if(this.drawing)this.rendEng.canvas.remove(this.drawing);else throw Error("Clef: update method called, but there exists no drawing to update.");this.drawClef(a);this.selectDrawing();this.rendEng.repaint()};
Toe.View.ClefView.prototype.updateStaffPosition=function(a){if(!this.drawing)throw Error("Clef: update method called, but there exists no drawing to update.");var b=a.staff.zone.uly-a.props.staffPos*a.staff.delta_y/2;"f"==a.shape&&(b+=0.34*this.drawing.currentHeight/2);this.drawing.top=b;this.rendEng.repaint();$(a).trigger("mUpdateBoundingBox",this.drawing)};Toe.View.ClefView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Model.Custos=function(a,b,c){this.props={interact:!0};$.extend(this.props,c);this.pname=a;this.oct=b;this.rootStaffPos=null;this.zone={};this.staff=this.id=null};Toe.Model.Custos.prototype.constructor=Toe.Model.Custos;Toe.Model.Custos.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Division: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};
Toe.Model.Custos.prototype.setID=function(a){this.id=a};Toe.Model.Custos.prototype.setStaff=function(a){if(!(a instanceof Toe.Model.Staff))throw Error("Custos: invalid staff reference");this.staff=a};Toe.Model.Custos.prototype.setRootNote=function(a,b){this.pname=a;this.oct=b};
Toe.Model.Custos.prototype.setRootStaffPos=function(a){this.rootStaffPos!=a&&(this.rootStaffPos=a,a=this.staff.getActingClefByEle(this),a=this.staff.calcPitchFromStaffPos(this.rootStaffPos,a),this.setRootNote(a.pname,a.oct),$(this).trigger("vUpdateStaffPosition",[this]))};Toe.Model.Custos.prototype.selectDrawing=function(){$(this).trigger("vSelectDrawing")};Toe.Model.Custos.prototype.eraseDrawing=function(){$(this).trigger("vEraseDrawing")};Toe.Ctrl.CustosController=function(a,b){$(a).bind("mUpdateBoundingBox",function(b,d){var e=d.left-d.currentWidth/2,f=d.top-d.currentHeight/2;a.setBoundingBox([e,f,e+d.currentWidth,f+d.currentHeight])});$(a).bind("vRenderCustos",function(a,d){b.renderCustos(d)});$(a).bind("vUpdateStaffPosition",function(a,d){b.updateStaffPosition(d)});$(a).bind("vEraseDrawing",function(a){b.eraseDrawing()});$(a).bind("vSelectDrawing",function(a){b.selectDrawing()})};
Toe.Ctrl.CustosController.prototype.constructor=Toe.Ctrl.CustosController;Toe.View.CustosView=function(a){this.rendEng=a;this.ledgerLines=this.drawing=null};Toe.View.CustosView.prototype.constructor=Toe.View.CustosView;
Toe.View.CustosView.prototype.drawLedgerLines=function(a,b,c,d){c*=0.75;var e=[],f=2*(1-d.props.numLines);if(0<a)for(f=0;f<=a;f+=2){var g=d.zone.uly-f*d.delta_y/2;e.push(this.rendEng.createLine([b-c,g,b+c,g]))}else if(a<f)for(;f>=a;f-=2)g=d.zone.uly-f*d.delta_y/2,e.push(this.rendEng.createLine([b-c,g,b+c,g]));this.ledgerLines=this.rendEng.draw({fixed:e,modify:[]},{group:!0,selectable:!1})[0]};
Toe.View.CustosView.prototype.renderCustos=function(a){if(!this.rendEng)throw Error("Custos: Invalid render context");var b=a.staff,c=this.rendEng.getGlyph("custos"),d=b.zone.uly-a.rootStaffPos*b.delta_y/2,e=a.zone.ulx+c.centre[0],d=c.clone().set({left:e,top:d-c.centre[1]/2});this.drawLedgerLines(a.rootStaffPos,e,4*c.centre[0],b);this.drawing=this.rendEng.draw({fixed:[],modify:[d]},{selectable:a.props.interact,group:!0,lockMovementX:!0,lockMovementY:!0,eleRef:a})[0]};
Toe.View.CustosView.prototype.updateStaffPosition=function(a){if(!this.drawing)throw Error("Custos: update method called, but there exists no drawing to update.");this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);var b=a.staff;this.drawing.top=b.zone.uly-a.rootStaffPos*b.delta_y/2-this.drawing.currentHeight/4;this.drawLedgerLines(a.rootStaffPos,this.drawing.left,1.5*this.drawing.currentWidth,b);this.rendEng.repaint();$(a).trigger("mUpdateBoundingBox",this.drawing)};
Toe.View.CustosView.prototype.eraseDrawing=function(){this.drawing&&this.rendEng.canvas.remove(this.drawing);this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);this.rendEng.repaint()};Toe.View.CustosView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Model.Division=function(a,b){this.key=a.toLowerCase();this.type=Toe.Model.Division.Type[this.key];if(void 0==this.type)throw Error("Division: undefined division type");this.props={interact:!0};$.extend(this.props,b);this.zone={};this.staff=this.id=null};Toe.Model.Division.prototype.constructor=Toe.Model.Division;
Toe.Model.Division.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Division: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};Toe.Model.Division.prototype.setID=function(a){this.id=a};Toe.Model.Division.prototype.setStaff=function(a){if(!(a instanceof Toe.Model.Staff))throw Error("Division: invalid staff reference");this.staff=a};
Toe.Model.Division.Type={div_small:"Small Division",div_minor:"Minor Division",div_major:"Major Division",div_final:"Final Division"};Toe.Model.Division.prototype.selectDrawing=function(){$(this).trigger("vSelectDrawing")};Toe.Ctrl.DivisionController=function(a,b){$(a).bind("vRenderDivision",function(a,d){b.renderDivision(d)});$(a).bind("vSelectDrawing",function(a){b.selectDrawing()})};Toe.Ctrl.DivisionController.prototype.constructor=Toe.Ctrl.DivisionController;Toe.View.DivisionView=function(a){this.rendEng=a};Toe.View.DivisionView.prototype.constructor=Toe.View.DivisionView;
Toe.View.DivisionView.prototype.renderDivision=function(a){if(!this.rendEng)throw Error("Division: Invalid render context");var b=a.staff,c={fixed:[],modify:[]},d=a.zone.ulx,e={strokeWidth:4};switch(a.type){case Toe.Model.Division.Type.div_small:var f=b.zone.uly-b.delta_y/2,b=b.zone.uly+b.delta_y/2;c.fixed.push(this.rendEng.createLine([d,f,d,b],e));break;case Toe.Model.Division.Type.div_minor:f=b.zone.uly+b.delta_y/2;b=f+2*b.delta_y;c.fixed.push(this.rendEng.createLine([d,f,d,b],e));break;case Toe.Model.Division.Type.div_major:f=
b.zone.uly;b=b.zone.lry;c.fixed.push(this.rendEng.createLine([d,f,d,b],e));break;case Toe.Model.Division.Type.div_final:f=b.zone.uly,b=b.zone.lry,c.fixed.push(this.rendEng.createLine([d,f,d,b],e)),d=a.zone.lrx,c.fixed.push(this.rendEng.createLine([d,f,d,b],e))}this.drawing=this.rendEng.draw(c,{group:!0,selectable:a.props.interact,eleRef:a})[0]};Toe.View.DivisionView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Model.Glyph=function(a,b){this.key=a;this.obj=b;this.centre=[this.obj.width/2,this.obj.height/2]};Toe.Model.Glyph.prototype.constructor=Toe.Glyph;Toe.Model.Glyph.prototype.clone=function(){return this.obj.clone()};Toe.View.GUI=function(a,b,c,d,e,f){var g={sldr_bgImgOpacity:!0,sldr_glyphOpacity:!0,initGlyphOpacity:1,initBgImgOpacity:0.6,initMode:"edit"};$.extend(g,f);this.rendEng=d;this.page=e;this.apiprefix=a;this.meipath=b;this.dwgLib=c;this.clefDwg=this.divisionDwg=this.punctDwg=null;a=d.getGlyph("punctum").clone();this.punctWidth=a.width*d.getGlobalScale();this.punctHeight=a.height*d.getGlobalScale();this.objMoving=!1;gui=this;this.setupNavBar();this.setupSideBar("#gui-sidebar",g);this.bindHotkeys();$("#btn_"+
g.initMode).trigger("click")};Toe.View.GUI.prototype.constructor=Toe.View.GUI;
Toe.View.GUI.prototype.setupNavBar=function(){var a=this;$("#nav_file_dropdown").length&&($("#nav_file_dropdown").append('<li><a id="nav_file_dropdown_revert" href="#">Revert</a></li><li class="divider"></li><li><a id="nav_file_dropdown_getmei" href="#">Get MEI</a></li><li><a id="nav_file_dropdown_getimg" href="#">Get Score Image</a></li>'),$("#nav_file_dropdown_revert").tooltip({animation:!0,placement:"right",title:"Revert the current MEI file to the original version. Warning: this will revert all changes made in the editor.",delay:100}),
$("#nav_file_dropdown_revert").click(function(){$.get(a.apiprefix+"/revert",function(a){window.location.reload()}).error(function(){$("#alert > p").text("Server failed to restore backup MEI file.");$("#alert").animate({opacity:1},100)})}),$("#nav_file_dropdown_getmei").tooltip({animation:!0,placement:"right",title:"View the MEI file of the document being edited.",delay:100}),$("#nav_file_dropdown_getmei").attr("href",a.meipath),$("#nav_file_dropdown_getimg").tooltip({animation:!0,placement:"right",
title:"Download an image of the document being edited.",delay:100}),$("#nav_file_dropdown_getimg").click(function(){fabric.Canvas.supports("toDataURL")?window.open(a.rendEng.canvas.toDataURL("png")):$("#alert > p").text("The browser you are using does not support this feature.")}))};
Toe.View.GUI.prototype.setupSideBar=function(a,b){var c=this;if(b.sldr_bgImgOpacity||b.sldr_glyphOpacity)$(a).prepend('<span id="sidebar-app"><li class="nav-header">Appearance</li>\n</span>'),b.sldr_bgImgOpacity&&($("#sidebar-app").append('<li>\n<label for="sldr_bgImgOpacity"><b>Image Opacity</b>:</label>\n<input id="sldr_bgImgOpacity" style="width: 95%;" type="range" name="bgImgOpacity" min="0.0" max="1.0" step="0.05" value="'+b.initBgImgOpacity+'" />\n</li>'),$("#sldr_bgImgOpacity").bind("change",
function(){c.rendEng.canvas.backgroundImageOpacity=$(this).val();c.rendEng.repaint()})),b.sldr_glyphOpacity&&($("#sidebar-app").append('<li>\n<label for="sldr_glyphOpacity"><b>Glyph Opacity</b>:</label>\n<input id="sldr_glyphOpacity" style="width: 95%;" type="range" name="glyphOpacity" min="0.0" max="1.0" step="0.05" value="'+b.initGlyphOpacity+'" />\n</li>'),$("#sldr_glyphOpacity").bind("change",function(){var a=$(this).val();c.rendEng.canvas.forEachObject(function(b){b.setOpacity(a)});c.rendEng.repaint()}));
$("#btn_edit").bind("click.edit",{gui:c,parentDivId:a},this.handleEdit);$("#btn_insert").bind("click.insert",{gui:c,parentDivId:a},this.handleInsert)};
Toe.View.GUI.prototype.bindHotkeys=function(){Mousetrap.bind(["e","Ctrl+e","Command+e"],function(){$("#btn_edit").click();return!1});Mousetrap.bind(["i","Ctrl+i","Command+i"],function(){$("#btn_insert").click();return!1});Mousetrap.bind(["del","backspace"],function(){$("#btn_delete").trigger("click.edit",{gui:gui},gui.handleDelete);return!1});Mousetrap.bind(["n","Ctrl+n","Command+n"],function(){$("#btn_neumify").trigger("click.edit",{gui:gui},gui.handleNeumify);return!1});Mousetrap.bind(["u","Ctrl+u",
"Command+u"],function(){$("#btn_ungroup").trigger("click.edit",{gui:gui},gui.handleUngroup);return!1})};
Toe.View.GUI.prototype.handleEdit=function(a){var b=a.data.gui;a=a.data.parentDivId;b.rendEng.canvas.selection=!0;b.rendEng.canvas.HOVER_CURSOR="pointer";$("#sidebar-insert").remove();b.rendEng.unObserve("mouse:move");b.rendEng.unObserve("mouse:up");b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.divisionDwg&&b.rendEng.canvas.remove(b.divisionDwg);b.clefDwg&&b.rendEng.canvas.remove(b.clefDwg);b.rendEng.repaint();0==$("#sidebar-edit").length&&$(a).append('<span id="sidebar-edit"><br/><li class="divider"></li><li class="nav-header">Edit</li>\n<li>\n<button id="btn_delete" class="btn"><i class="icon-remove"></i> Delete</button>\n</li>\n<li>\n<div class="btn-group">\n<button id="btn_neumify" class="btn"><i class="icon-magnet"></i> Neumify</button>\n<button class="btn dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>\n<ul class="dropdown-menu"><li><a id="btn_neumify_liquescence">liquescence</a></li></ul></li>\n<li><button id="btn_ungroup" class="btn"><i class="icon-share"></i> Ungroup</button></li>\n</div>\n</span>');
$("#btn_delete").toggleClass("disabled",!0);$("#btn_neumify").toggleClass("disabled",!0);$("#btn_neumify_liquescence").toggleClass("disabled",!0);$("#btn_ungroup").toggleClass("disabled",!0);b.rendEng.canvas.observe("mouse:down",function(a){b.downCoords=b.rendEng.canvas.getPointer(a.e)});b.rendEng.canvas.observe("object:moving",function(a){b.objMoving=!0});b.rendEng.canvas.observe("selection:created",function(a){a=a.target;a.hasControls=!1;a.borderColor="rgba(102,153,255,1.0)";var b=0,e=0,f=null;
$.each(a.getObjects(),function(a,c){c.borderColor="rgba(0,0,0,0)";c.eleRef instanceof Toe.Model.Neume&&(f||(f=c.eleRef.staff),e++,c.eleRef.staff==f&&b++)});$("#btn_delete").toggleClass("disabled",!1);2>b?($("#btn_neumify").toggleClass("disabled",!0),$("#btn_neumify_liquescence").toggleClass("disabled",!0)):($("#btn_neumify").toggleClass("disabled",!1),$("#btn_neumify_liquescence").toggleClass("disabled",!1));0<e?$("#btn_ungroup").toggleClass("disabled",!1):$("#btn_ungroup").toggleClass("disabled",
!0)});b.rendEng.canvas.observe("object:selected",function(a){$("#btn_delete").toggleClass("disabled",!1);a=b.rendEng.canvas.getActiveObject().eleRef;a instanceof Toe.Model.Neume?($("#info > p").html("Selected: "+a.name+"<br/> Pitche(s): "+$.map(a.components,function(a){return a.pname.toUpperCase()+a.oct}).join(", ")),$("#info").animate({opacity:1},100),$("#btn_ungroup").toggleClass("disabled",!1),$("#menu_editclef").remove(),"punctum"==a.typeid||"cavum"==a.typeid||"virga"==a.typeid?(0==$("#menu_editpunctum").length&&
$("#sidebar-edit").append('<span id="menu_editpunctum"><br/><li class="nav-header">Ornamentation</li>\n<li><div class="btn-group" data-toggle="buttons-checkbox">\n<button id="edit_chk_dot" class="btn">&#149; Dot</button>\n<button id="edit_chk_horizepisema" class="btn"><i class="icon-resize-horizontal"></i> Episema</button>\n<button id="edit_chk_vertepisema" class="btn"><i class="icon-resize-vertical"></i> Episema</button>\n</div></li>\n<br/><li class="nav-header">Attributes</li>\n<li><div class="btn-group"><a class="btn dropdown-toggle" data-toggle="dropdown">\nHead shape <span class="caret"></span></a><ul class="dropdown-menu">\n<li><a id="head_punctum">punctum</a></li>\n<li><a id="head_punctum_inclinatum">punctum inclinatum</a></li>\n<li><a id="head_punctum_inclinatum_parvum">punctum inclinatum parvum</a></li>\n<li><a id="head_cavum">cavum</a></li>\n<li><a id="head_virga">virga</a></li>\n<li><a id="head_quilisma">quilisma</a></li>\n</ul></div></span>'),
a.components[0].hasOrnament("dot")?$("#edit_chk_dot").toggleClass("active",!0):$("#edit_chk_dot").toggleClass("active",!1),$("#edit_chk_dot").unbind("click"),$("#edit_chk_dot").bind("click.edit",{gui:b,punctum:a},b.handleDotToggle),$("#head_punctum").unbind("click"),$("#head_cavum").unbind("click"),$("#head_virga").unbind("click"),$("#head_quilisma").unbind("click"),$("#head_punctum_inclinatum").unbind("click"),$("#head_punctum_inclinatum_parvum").unbind("click"),$("#head_punctum").bind("click.edit",
{gui:b,punctum:a,shape:"punctum"},b.handleHeadShapeChange),$("#head_cavum").bind("click.edit",{gui:b,punctum:a,shape:"cavum"},b.handleHeadShapeChange),$("#head_virga").bind("click.edit",{gui:b,punctum:a,shape:"virga"},b.handleHeadShapeChange),$("#head_quilisma").bind("click.edit",{gui:b,punctum:a,shape:"quilisma"},b.handleHeadShapeChange),$("#head_punctum_inclinatum").bind("click.edit",{gui:b,punctum:a,shape:"punctum_inclinatum"},b.handleHeadShapeChange),$("#head_punctum_inclinatum_parvum").bind("click.edit",
{gui:b,punctum:a,shape:"punctum_inclinatum_parvum"},b.handleHeadShapeChange)):$("#menu_editpunctum").remove()):a instanceof Toe.Model.Clef?($("#info > p").text("Selected: "+a.name),$("#info").animate({opacity:1},100),0==$("#menu_editclef").length&&$("#sidebar-edit").append('<span id="menu_editclef"><br/><li class="nav-header">Clef</li>\n<li><div class="btn-group" data-toggle="buttons-radio">\n<button id="edit_rad_c" class="btn">C</button>\n<button id="edit_rad_f" class="btn">F</button>\n</div></li></span>'),
"c"==a.shape?$("#edit_rad_c").toggleClass("active",!0):$("#edit_rad_f").toggleClass("active",!0),$("#edit_rad_c").unbind("click"),$("#edit_rad_f").unbind("click"),$("#edit_rad_c").bind("click.edit",{gui:b,clef:a,shape:"c"},b.handleClefShapeChange),$("#edit_rad_f").bind("click.edit",{gui:b,clef:a,shape:"f"},b.handleClefShapeChange)):(a instanceof Toe.Model.Division?($("#info > p").text("Selected: "+a.type),$("#info").animate({opacity:1},100)):a instanceof Toe.Model.Custos&&($("#info > p").html("Selected: Custos <br/> Pitch: "+
a.pname.toUpperCase()+a.oct),$("#info").animate({opacity:1},100)),$("#menu_editpunctum").remove(),$("#menu_editclef").remove())});b.rendEng.canvas.observe("selection:cleared",function(a){$("#info").animate({opacity:0},100);$("#menu_editpunctum").remove();$("#menu_editclef").remove();$("#btn_delete").toggleClass("disabled",!0);$("#btn_neumify").toggleClass("disabled",!0);$("#btn_neumify_liquescence").toggleClass("disabled",!0);$("#btn_ungroup").toggleClass("disabled",!0)});b.rendEng.canvas.observe("mouse:up",
function(a){a=b.rendEng.canvas.getPointer(a.e);var d=b.downCoords.x-a.x,e=b.downCoords.y-a.y;if(b.objMoving){var f=b.rendEng.canvas.getActiveObject();f||(f=b.rendEng.canvas.getActiveGroup());if(f){var g=[];f.eleRef?g.push(f):$.each(f.objects,function(a,b){g.push(b)});$.each(g,function(a,c){var m=c.eleRef;if(m instanceof Toe.Model.Clef){var h=c.left,k=c.top;1<g.length&&(h=f.left+c.left,k=f.top+c.top);h=m.staff.ohSnap({x:h,y:k},null,{ignoreEle:m});h=-Math.round((h.y-m.staff.zone.uly)/(m.staff.delta_y/
2));m.setStaffPosition(h);var p=m.staff.getPitchedElements({neumes:!0,custos:!1});0<p.length&&m.staff.getActingClefByEle(p[0])==m&&(h=b.page.getPreviousStaff(m.staff))&&b.handleUpdatePrevCustos(p[0].components[0].pname,p[0].components[0].oct,h);var h=$.map(m.staff.getPitchedElements({clef:m}),function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,function(a,b){c.push({pname:b.pname,oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var e=b.getOutputBoundingBox([a.zone.ulx,
a.zone.uly,a.zone.lrx,a.zone.lry]);$.post(b.apiprefix+"/move/custos",{id:a.id,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3]}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}}),k=m.staff.props.numLines+m.props.staffPos/2,p=b.getOutputBoundingBox([m.zone.ulx,m.zone.uly,m.zone.lrx,m.zone.lry]),r={id:m.id,line:k,ulx:p[0],uly:p[1],lrx:p[2],lry:p[3],pitchInfo:h};$.post(b.apiprefix+"/move/clef",{data:JSON.stringify(r)}).error(function(){$("#alert > p").text("Server failed to move clef. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)})}else if(m instanceof Toe.Model.Neume){h=c.left;k=c.top;1<g.length&&(h=f.left+c.left,k=f.top+c.top);var q={x:h,y:m.staff.zone.uly-m.rootStaffPos*m.staff.delta_y/2-e},s=b.page.getClosestStaff(q),t=s.ohSnap(q,c.currentWidth,{ignoreEle:m}),h=Math.round((s.zone.uly-t.y)/(s.delta_y/2)),p=t.x-c.currentWidth/2,k=k-c.currentHeight/2-(q.y-t.y),p=[p,k,p+c.currentWidth,k+c.currentHeight];m.setBoundingBox(p);q=m.rootStaffPos;$.each(m.components,function(a,b){var c=s.calcPitchFromCoords({x:t.x,
y:t.y-s.delta_y/2*b.pitchDiff});b.setPitchInfo(c.pname,c.oct)});$(m).trigger("vEraseDrawing");m.staff.removeElementByRef(m);k=s.addNeume(m);1==g.length&&$(m).trigger("vSelectDrawing");p=b.getOutputBoundingBox([m.zone.ulx,m.zone.uly,m.zone.lrx,m.zone.lry]);r={id:m.id,ulx:p[0],uly:p[1],lrx:p[2],lry:p[3]};q!=h?(r.pitchInfo=[],$.each(m.components,function(a,b){r.pitchInfo.push({pname:b.pname,oct:b.oct})}),m==s.elements[1]&&(h=b.page.getPreviousStaff(s))&&b.handleUpdatePrevCustos(m.components[0].pname,
m.components[0].oct,h)):r.pitchInfo=null;k+1<s.elements.length?r.beforeid=s.elements[k+1].id:(h=b.page.getNextStaff(s),r.beforeid=h.id);$.post(b.apiprefix+"/move/neume",{data:JSON.stringify(r)}).error(function(){$("#alert > p").text("Server failed to move neume. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}else if(m instanceof Toe.Model.Division){h=c.left;k=c.top;1<g.length&&(h+=f.left,k+=f.top);q={x:h,y:k};h=b.page.getClosestStaff(q);t=h.ohSnap(q,c.currentWidth,
{x:!0,y:!1});switch(m.type){case Toe.Model.Division.Type.div_small:t.y=h.zone.uly;break;case Toe.Model.Division.Type.div_minor:t.y=h.zone.uly+(h.zone.lry-h.zone.uly)/2;break;case Toe.Model.Division.Type.div_major:t.y=h.zone.uly+(h.zone.lry-h.zone.uly)/2;break;case Toe.Model.Division.Type.div_final:t.y=h.zone.uly+(h.zone.lry-h.zone.uly)/2}m.staff.removeElementByRef(m);b.rendEng.canvas.remove(c);b.rendEng.repaint();p=t.x-c.currentWidth/2;k=t.y-c.currentHeight/2;p=[p,k,p+c.currentWidth,k+c.currentHeight];
m.setBoundingBox(p);p=h.addDivision(m);1==g.length&&m.selectDrawing();k=null;p+1<h.elements.length?k=h.elements[p+1].id:(h=b.page.getNextStaff(h),k=h.id);p=b.getOutputBoundingBox([m.zone.ulx,m.zone.uly,m.zone.lrx,m.zone.lry]);$.post(b.apiprefix+"/move/division",{id:m.id,ulx:p[0],uly:p[1],lrx:p[2],lry:p[3],beforeid:k}).error(function(){$("#alert > p").text("Server failed to move division. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}else m instanceof Toe.Model.Custos&&
(h=c.left,k=c.top,1<g.length&&(c.left=h+d,c.top=k+e))});1<g.length&&b.rendEng.canvas.discardActiveGroup();b.rendEng.repaint()}b.objMoving=!1}});$("#btn_delete").unbind("click");$("#btn_neumify").unbind("click");$("#btn_ungroup").unbind("click");$("#btn_delete").bind("click.edit",{gui:b},b.handleDelete);$("#btn_neumify").bind("click.edit",{gui:b},b.handleNeumify);$("#btn_neumify_liquescence").bind("click.edit",{gui:b,modifier:"alt"},b.handleNeumify);$("#btn_ungroup").bind("click.edit",{gui:b},b.handleUngroup)};
Toe.View.GUI.prototype.handleDotToggle=function(a){var b=a.data.gui,c=a.data.punctum;if(a=c.components[0].hasOrnament("dot"))c.components[0].removeOrnament("dot");else{var d=new Toe.Model.Ornament("dot",{form:"aug"});c.components[0].addOrnament(d)}c.syncDrawing();d=b.getOutputBoundingBox([c.zone.ulx,c.zone.uly,c.zone.lrx,c.zone.lry]);c={id:c.id,dotform:"aug",ulx:d[0],uly:d[1],lrx:d[2],lry:d[3]};a?$.post(b.apiprefix+"/delete/dot",c).error(function(){$("#alert > p").text("Server failed to remove dot from the punctum. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)}):$.post(b.apiprefix+"/insert/dot",c).error(function(){$("#alert > p").text("Server failed to add a dot to the punctum. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});$(this).toggleClass("active")};
Toe.View.GUI.prototype.handleHeadShapeChange=function(a){var b=a.data.gui,c=a.data.shape;a=a.data.punctum;a.components[0].setHeadShape(c);"virga"==c?(a.name="Virga",a.typeid="virga"):"cavum"==c&&(a.name="Cavum",a.typeid="cavum");a.syncDrawing();var d=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);$.post(b.apiprefix+"/update/neume/headshape",{id:a.id,shape:c,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3]}).error(function(){$("#alert > p").text("Server failed to change note head shape. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)})};
Toe.View.GUI.prototype.handleClefShapeChange=function(a){var b=a.data.gui,c=a.data.clef;a=a.data.shape;if(c.shape!=a){c.setShape(a);var d=c.staff.getPitchedElements({neumes:!0,custos:!1});if(0<d.length&&c.staff.getActingClefByEle(d[0])==c){var e=b.page.getPreviousStaff(c.staff);e&&b.handleUpdatePrevCustos(d[0].components[0].pname,d[0].components[0].oct,e)}d=$.map(c.staff.getPitchedElements({clef:c}),function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,function(a,b){c.push({pname:b.pname,
oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var e=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);$.post(b.apiprefix+"/move/custos",{id:a.id,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3]}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}});e=b.getOutputBoundingBox([c.zone.ulx,c.zone.uly,c.zone.lrx,c.zone.lry]);$.post(b.apiprefix+"/update/clef/shape",{data:JSON.stringify({id:c.id,
shape:a,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3],pitchInfo:d})}).error(function(){$("#alert > p").text("Server failed to update clef shape. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});$(this).toggleClass("active")}};
Toe.View.GUI.prototype.handleDelete=function(a){var b=a.data.gui;toDelete={clefs:[],nids:[],dids:[],cids:[]};var c=function(a){var c=a.eleRef,e=c.staff,d=e.getPreviousClef(c),f=e.getPitchedElements(c);e.removeElementByRef(c);e.updatePitchedElements(d);e=$.map(f,function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,function(a,b){c.push({pname:b.pname,oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var e=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,
a.zone.lry]);$.post(b.apiprefix+"/move/custos",{id:a.id,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3]}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}});toDelete.clefs.push({id:c.id,pitchInfo:e});b.rendEng.canvas.remove(a);b.rendEng.canvas.discardActiveObject()},d=function(a){a=a.eleRef;var c=a.staff.getPitchedElements({neumes:!0,custos:!1});a.staff.removeElementByRef(a);toDelete.nids.push(a.id);b.rendEng.canvas.discardActiveObject();
if(1==c.length){var e=b.page.getPreviousStaff(a.staff);e&&e.custos&&(e.custos.eraseDrawing(),e.removeElementByRef(e.custos),$.post(b.apiprefix+"/delete/custos",{ids:e.custos.id}).error(function(){$("#alert > p").text("Server failed to delete custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)}),e.custos=null)}else if(a==c[0]&&(e=b.page.getPreviousStaff(a.staff))&&e.custos){a=e.custos;var d=c[1],c=d.components[0].pname,d=d.components[0].oct,f=e.getActingClefByEle(a),
e=e.calcStaffPosFromPitch(c,d,f);a.pname=c;a.oct=d;a.setRootStaffPos(e);e=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);$.post(b.apiprefix+"/move/custos",{id:a.id,pname:c,oct:d,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3]}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}},e=function(a){var c=a.eleRef;c.staff.removeElementByRef(c);toDelete.dids.push(c.id);b.rendEng.canvas.remove(a);
b.rendEng.canvas.discardActiveObject()},f=function(a){var c=a.eleRef;c.staff.removeElementByRef(c);c.staff.custos=null;toDelete.cids.push(c.id);b.rendEng.canvas.remove(a);b.rendEng.canvas.discardActiveObject()};if(a=b.rendEng.canvas.getActiveObject())a.eleRef instanceof Toe.Model.Clef&&a.eleRef.staff.elements[0]!=a.eleRef?c(a):a.eleRef instanceof Toe.Model.Neume?d(a):a.eleRef instanceof Toe.Model.Division?e(a):a.eleRef instanceof Toe.Model.Custos&&f(a),b.rendEng.repaint();else if(a=b.rendEng.canvas.getActiveGroup())$.each(a.getObjects(),
function(a,b){b.eleRef instanceof Toe.Model.Clef&&b.eleRef.staff.elements[0]!=b.eleRef?c(b):b.eleRef instanceof Toe.Model.Neume?d(b):b.eleRef instanceof Toe.Model.Division?e(b):b.eleRef instanceof Toe.Model.Custos&&f(b)}),b.rendEng.canvas.discardActiveGroup(),b.rendEng.repaint();0<toDelete.clefs.length&&$.post(b.apiprefix+"/delete/clef",{data:JSON.stringify(toDelete.clefs)}).error(function(){$("#alert > p").text("Server failed to delete clef. Client and server are not synchronized.");$("#alert").animate({opacity:1},
100)});0<toDelete.nids.length&&$.post(b.apiprefix+"/delete/neume",{ids:toDelete.nids.join(",")}).error(function(){$("#alert > p").text("Server failed to delete neume. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});0<toDelete.dids.length&&$.post(b.apiprefix+"/delete/division",{ids:toDelete.dids.join(",")}).error(function(){$("#alert > p").text("Server failed to delete division. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});0<toDelete.cids.length&&
$.post(b.apiprefix+"/delete/custos",{ids:toDelete.cids.join(",")}).error(function(){$("#alert > p").text("Server failed to delete custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})};
Toe.View.GUI.prototype.handleNeumify=function(a){var b=a.data.gui;a=a.data.modifier;var c=b.rendEng.canvas.getActiveGroup();if(c){var d=[],e=null;$.each(c.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.Neume&&(e||(e=b.eleRef.staff),b.eleRef.staff==e&&d.push(b))});if(!(2>d.length)){d.sort(function(a,b){return a.eleRef.zone.ulx-b.eleRef.zone.ulx});var f=new Toe.Model.Neume({modifier:a});numPunct=0;var g=[],n=Number.MAX_VALUE,l=Number.MAX_VALUE,m=Number.MIN_VALUE;$.each(d,function(a,d){$.merge(f.components,
d.eleRef.components);numPunct+=d.eleRef.components.length;g.push(d.eleRef.id);var h=c.top+d.top;n=Math.min(n,c.left+d.left-d.currentHeight/2);l=Math.min(l,h-d.currentHeight/2);m=Math.max(m,h+d.currentHeight/2);e.removeElementByRef(d.eleRef);b.rendEng.canvas.remove(d)});f.setBoundingBox([n,l,n+numPunct*b.punctWidth,m]);a=new Toe.View.NeumeView(b.rendEng,b.dwgLib);new Toe.Ctrl.NeumeController(f,a);e.addNeume(f);a=b.getOutputBoundingBox([f.zone.ulx,f.zone.uly,f.zone.lrx,f.zone.lry]);var h=f.typeid,k=
$.map(f.components,function(a){return a.props.type});a=JSON.stringify({nids:g.join(","),typeid:h,headShapes:k,ulx:a[0],uly:a[1],lrx:a[2],lry:a[3]});$.post(b.apiprefix+"/neumify",{data:a},function(a){f.id=JSON.parse(a).id}).error(function(){$("#alert > p").text("Server failed to neumify selected neumes. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});b.rendEng.canvas.discardActiveGroup();$(f).trigger("vSelectDrawing");b.rendEng.repaint()}}};
Toe.View.GUI.prototype.handleUngroup=function(a){var b=a.data.gui,c=[];(a=b.rendEng.canvas.getActiveObject())?a.eleRef instanceof Toe.Model.Neume&&1<a.eleRef.components.length&&c.push(a):(a=b.rendEng.canvas.getActiveGroup())&&$.each(a.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.Neume&&1<b.eleRef.components.length&&c.push(b)});var d=[],e=[],f=[];$.each(c,function(a,c){d.push(c.eleRef.id);var l=[],m=c.eleRef.zone.ulx;c.eleRef.staff.removeElementByRef(c.eleRef);b.rendEng.canvas.remove(c);
$.each(c.eleRef.components,function(a,e){var d=new Toe.Model.Neume;d.components.push(e);var g=c.eleRef.staff.zone.uly-(c.eleRef.rootStaffPos+e.pitchDiff)*c.eleRef.staff.delta_y/2-b.punctHeight/2;d.setBoundingBox([m+a*b.punctWidth,g,m+(a+1)*b.punctWidth,g+b.punctHeight]);g=new Toe.View.NeumeView(b.rendEng,b.dwgLib);new Toe.Ctrl.NeumeController(d,g);c.eleRef.staff.addNeume(d);g=b.getOutputBoundingBox([d.zone.ulx,d.zone.uly,d.zone.lrx,d.zone.lry]);l.push({ulx:g[0],uly:g[1],lrx:g[2],lry:g[3]});f.push(d)});
e.push(l)});a=JSON.stringify({nids:d.join(","),bbs:e});$.post(b.apiprefix+"/ungroup",{data:a},function(a){var b=JSON.parse(a).nids,b=$.map(b,function(a){return a});$.each(f,function(a,c){c.id=b[a]})}).error(function(){$("#alert > p").text("Server failed to ungroup selected neumes. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});b.rendEng.canvas.discardActiveObject();b.rendEng.canvas.discardActiveGroup();b.rendEng.repaint()};
Toe.View.GUI.prototype.handleInsert=function(a){var b=a.data.gui;a=a.data.parentDivId;b.rendEng.canvas.selection=!1;b.rendEng.canvas.deactivateAll();b.rendEng.canvas.HOVER_CURSOR=null;$("#sidebar-edit").remove();$("#btn_delete").unbind("click.edit");$("#btn_neumify").unbind("click.edit");b.rendEng.unObserve("mouse:down");b.rendEng.unObserve("mouse:up");b.rendEng.unObserve("object:moving");b.rendEng.unObserve("object:selected");b.rendEng.unObserve("selection:cleared");0==$("#sidebar-insert").length&&
$(a).append('<span id="sidebar-insert"><br/><li class="divider"></li><li class="nav-header">Insert</li>\n<li><div class="btn-group" data-toggle="buttons-radio"><button id="rad_punctum" class="btn"><i class="icon-bookmark icon-black"></i> Punctum</button>\n<button id="rad_division" class="btn"><b>||</b> Division</button>\n<button id="rad_clef" class="btn">Clef</button>\n</div>\n</li>\n</span>');$("#rad_punctum").unbind("click");$("#rad_division").unbind("click");$("#rad_clef").unbind("click");$("#rad_punctum").bind("click.insert",
{gui:b},b.handleInsertPunctum);$("#rad_division").bind("click.insert",{gui:b},b.handleInsertDivision);$("#rad_clef").bind("click.insert",{gui:b},b.handleInsertClef);$("#rad_punctum").trigger("click")};
Toe.View.GUI.prototype.handleInsertPunctum=function(a){var b=a.data.gui;b.rendEng.unObserve("mouse:move");b.rendEng.unObserve("mouse:up");$("#menu_insertdivision").remove();$("#menu_insertclef").remove();b.divisionDwg&&b.rendEng.canvas.remove(b.divisionDwg);b.clefDwg&&b.rendEng.canvas.remove(b.clefDwg);0==$("#menu_insertpunctum").length&&$("#sidebar-insert").append('<span id="menu_insertpunctum"><br/><li class="nav-header">Ornamentation</li>\n<li><div class="btn-group" data-toggle="buttons-checkbox">\n<button id="chk_dot" class="btn">&#149; Dot</button>\n<button id="chk_horizepisema" class="btn"><i class="icon-resize-horizontal"></i> Episema</button>\n<button id="chk_vertepisema" class="btn"><i class="icon-resize-vertical"></i> Episema</button>\n</div></li></span>');
var c=!1,d=function(a){var d={modify:[],fixed:[]},g=null,n=b.rendEng.getGlyph("punctum");a?g={left:-50,top:-50}:(g={left:b.punctDwg.left,top:b.punctDwg.top},c&&(a=b.rendEng.getGlyph("dot").clone().set({left:g.left+b.punctWidth,top:g.top,opacity:0.6}),d.modify.push(a)));g=n.clone().set({left:g.left,top:g.top,opacity:0.6});d.modify.push(g);b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.punctDwg=b.rendEng.draw(d,{group:!0,selectable:!1,repaint:!0})[0]};d(!0);b.rendEng.canvas.observe("mouse:move",
function(a){a=b.rendEng.canvas.getPointer(a.e);b.punctDwg.left=a.x-b.punctDwg.currentWidth/4;b.punctDwg.top=a.y-b.punctDwg.currentHeight/4;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(a){var d={x:b.punctDwg.left,y:b.punctDwg.top};a=b.page.getClosestStaff(d);var g=new Toe.Model.Neume,d=a.ohSnap(d,b.punctDwg.currentWidth),n=d.x-b.punctDwg.currentWidth/2,l=d.y-b.punctDwg.currentHeight/2;g.setBoundingBox([n,l,n+b.punctDwg.currentWidth,l+b.punctDwg.currentHeight]);var d=a.calcPitchFromCoords(d),
n=d.pname,l=d.oct,d={pname:n,oct:l},m=[];c&&(m.push(new Toe.Model.Ornament("dot",{form:"aug"})),d.dotform="aug");g.addComponent("punctum",n,l,{ornaments:m});m=new Toe.View.NeumeView(b.rendEng,b.dwgLib);new Toe.Ctrl.NeumeController(g,m);m=a.addNeume(g);if(1==m){var h=b.page.getPreviousStaff(a);h&&b.handleUpdatePrevCustos(n,l,h)}n=b.getOutputBoundingBox([g.zone.ulx,g.zone.uly,g.zone.lrx,g.zone.lry]);d.ulx=n[0];d.uly=n[1];d.lrx=n[2];d.lry=n[3];if(m+1<a.elements.length)d.beforeid=a.elements[m+1].id;else if(a=
b.page.getNextStaff(a))d.beforeid=a.id;$.post(b.apiprefix+"/insert/neume",d,function(a){g.id=JSON.parse(a).id}).error(function(){$("#alert > p").text("Server failed to insert neume. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})});$("#chk_dot").bind("click.insert",function(){c=c?!1:!0;d(!1)})};
Toe.View.GUI.prototype.handleInsertDivision=function(a){var b=a.data.gui;b.rendEng.unObserve("mouse:move");b.rendEng.unObserve("mouse:up");b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.clefDwg&&b.rendEng.canvas.remove(b.clefDwg);$("#menu_insertpunctum").remove();$("#menu_insertclef").remove();0==$("#menu_insertdivision").length&&$("#sidebar-insert").append('<span id="menu_insertdivision"><br/>\n<li class="nav-header">Division Type</li>\n<li><div class="btn-group" data-toggle="buttons-radio">\n<button id="rad_small" class="btn">Small</button>\n<button id="rad_minor" class="btn">Minor</button>\n<button id="rad_major" class="btn">Major</button>\n<button id="rad_final" class="btn">Final</button>\n</div>\n</li>\n</span>');
var c=null,d=null;b.rendEng.canvas.observe("mouse:move",function(a){a=b.rendEng.canvas.getPointer(a.e);d=b.page.getClosestStaff(a);var f={strokeWidth:4,opacity:0.6};switch(c){case "div_small":a.y=d.zone.uly;if(!b.divisionDwg){var g=d.zone.uly-d.delta_y/2,n=d.zone.uly+d.delta_y/2,l=a.x;b.divisionDwg=b.rendEng.createLine([l,g,l,n],f);b.rendEng.draw({fixed:[b.divisionDwg],modify:[]},{selectable:!1,opacity:0.6})}break;case "div_minor":a.y=d.zone.uly+(d.zone.lry-d.zone.uly)/2;b.divisionDwg||(g=d.zone.uly+
d.delta_y/2,n=g+2*d.delta_y,l=a.x,b.divisionDwg=b.rendEng.createLine([l,g,l,n],f),b.rendEng.draw({fixed:[b.divisionDwg],modify:[]},{selectable:!1,opacity:0.6}));break;case "div_major":a.y=d.zone.uly+(d.zone.lry-d.zone.uly)/2;b.divisionDwg||(g=d.zone.uly,n=d.zone.lry,l=a.x,b.divisionDwg=b.rendEng.createLine([l,g,l,n],f),b.rendEng.draw({fixed:[b.divisionDwg],modify:[]},{selectable:!1,opacity:0.6}));break;case "div_final":if(a.y=d.zone.uly+(d.zone.lry-d.zone.uly)/2,!b.divisionDwg){var g=d.zone.uly,n=
d.zone.lry,l=a.x,m=a.x+b.punctWidth,l=b.rendEng.createLine([l,g,l,n],f),f=b.rendEng.createLine([m,g,m,n],f);b.divisionDwg=b.rendEng.draw({fixed:[l,f],modify:[]},{group:!0,selectable:!1,opacity:0.6})[0]}}f=a.x-b.divisionDwg.currentWidth/2;g=a.x+b.divisionDwg.currentWidth/2;d.elements[0]instanceof Toe.Model.Clef&&f<=d.elements[0].zone.lrx?a.x=d.elements[0].zone.lrx+b.divisionDwg.currentWidth/2+1:f<=d.zone.ulx&&(a.x=d.zone.ulx+b.divisionDwg.currentWidth/2+1);d.custos&&g>=d.custos.zone.ulx?a.x=d.custos.zone.ulx-
b.divisionDwg.currentWidth/2-3:g>=d.zone.lrx&&(a.x=d.zone.lrx-b.divisionDwg.currentWidth/2-3);b.divisionDwg.left=a.x;b.divisionDwg.top=a.y;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(a){var f=d.ohSnap({x:b.divisionDwg.left,y:b.divisionDwg.top},b.divisionDwg.currentWidth),g=new Toe.Model.Division(c);a=f.x-b.divisionDwg.currentWidth/2;f=f.y-b.divisionDwg.currentHeight/2;f=[a,f,a+b.divisionDwg.currentWidth,f+b.divisionDwg.currentHeight];g.setBoundingBox(f);a=new Toe.View.DivisionView(b.rendEng);
new Toe.Ctrl.DivisionController(g,a);a=d.addDivision(g);f=b.getOutputBoundingBox(f);f={type:g.key.slice(4),ulx:f[0],uly:f[1],lrx:f[2],lry:f[3]};a+1<d.elements.length?f.beforeid=d.elements[a+1].id:(a=b.page.getNextStaff(d),f.beforeid=a.id);$.post(b.apiprefix+"/insert/division",f,function(a){g.id=JSON.parse(a).id}).error(function(){$("#alert > p").text("Server failed to insert division. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})});$("#rad_small").bind("click.insert",
function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);c="div_small"});$("#rad_minor").bind("click.insert",function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);c="div_minor"});$("#rad_major").bind("click.insert",function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);c="div_major"});$("#rad_final").bind("click.insert",function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);c=
"div_final"});$("#rad_small").trigger("click")};
Toe.View.GUI.prototype.handleInsertClef=function(a){var b=a.data.gui;b.rendEng.unObserve("mouse:move");b.rendEng.unObserve("mouse:up");b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.divisionDwg&&b.rendEng.canvas.remove(b.divisionDwg);$("#menu_insertpunctum").remove();$("#menu_insertdivision").remove();0==$("#menu_insertclef").length&&$("#sidebar-insert").append('<span id="menu_insertclef"><br/>\n<li class="nav-header">Clef Type</li>\n<li><div class="btn-group" data-toggle="buttons-radio">\n<button id="rad_doh" class="btn">C</button>\n<button id="rad_fah" class="btn">F</button>\n</div>\n</li>\n</span>');var c=
null;b.rendEng.canvas.observe("mouse:move",function(a){a=b.rendEng.canvas.getPointer(a.e);var e=0,f=0;"c"==c?e=b.clefDwg.currentWidth/4:(e=b.clefDwg.currentWidth/8,f=b.clefDwg.currentHeight/8);b.clefDwg.left=a.x-e;b.clefDwg.top=a.y+f;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(a){var e={x:b.clefDwg.left,y:b.clefDwg.top};"f"==c&&(e.x-=b.clefDwg.currentWidth/8,e.y-=b.clefDwg.currentHeight/8);a=b.page.getClosestStaff(e);var f=a.ohSnap(e,b.clefDwg.currentWidth),e=Math.round((a.zone.uly-
f.y)/(a.delta_y/2)),g=new Toe.Model.Clef(c,{staffPos:e}),n=f.x-b.clefDwg.currentWidth/2,f=f.y-b.clefDwg.currentHeight/2;g.setBoundingBox([n,f,n+b.clefDwg.currentWidth,f+b.clefDwg.currentHeight]);n=new Toe.View.ClefView(b.rendEng);new Toe.Ctrl.ClefController(g,n);n=a.addClef(g);e=a.props.numLines+e/2;f=b.getOutputBoundingBox([g.zone.ulx,g.zone.uly,g.zone.lrx,g.zone.lry]);e={shape:c,line:e,ulx:f[0],uly:f[1],lrx:f[2],lry:f[3]};n+1<a.elements.length?e.beforeid=a.elements[n+1].id:(n=b.page.getNextStaff(a),
e.beforeid=n.id);n=a.getPitchedElements({neumes:!0,custos:!1});0<n.length&&a.getActingClefByEle(n[0])==g&&(f=b.page.getPreviousStaff(a))&&b.handleUpdatePrevCustos(n[0].components[0].pname,n[0].components[0].oct,f);e.pitchInfo=$.map(a.getPitchedElements({clef:g}),function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,function(a,b){c.push({pname:b.pname,oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var d=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,
a.zone.lry]);$.post(b.apiprefix+"/move/custos",{id:a.id,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3]}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}});$.post(b.apiprefix+"/insert/clef",{data:JSON.stringify(e)},function(a){g.id=JSON.parse(a).id}).error(function(){$("#alert > p").text("Server failed to insert clef. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})});$("#rad_doh").unbind("click");
$("#rad_fah").unbind("click");$("#rad_doh").bind("click.insert",function(){if(!$(this).hasClass("active")){var a={left:-50,top:-50};b.clefDwg&&(b.rendEng.canvas.remove(b.clefDwg),a={left:b.clefDwg.left,top:b.clefDwg.top});a=b.rendEng.getGlyph("c_clef").clone().set($.extend(a,{opacity:0.6}));b.clefDwg=b.rendEng.draw({fixed:[],modify:[a]},{opacity:0.6,selectable:!1,repaint:!0})[0];c="c"}});$("#rad_fah").bind("click.insert",function(){if(!$(this).hasClass("active")){var a={left:-50,top:-50};b.clefDwg&&
(b.rendEng.canvas.remove(b.clefDwg),a={left:b.clefDwg.left,top:b.clefDwg.top});a=b.rendEng.getGlyph("f_clef").clone().set($.extend(a,{opacity:0.6}));b.clefDwg=b.rendEng.draw({fixed:[],modify:[a]},{opacity:0.6,selectable:!1,repaint:!0})[0];c="f"}});$("#rad_doh").trigger("click")};
Toe.View.GUI.prototype.handleUpdatePrevCustos=function(a,b,c){var d=c.custos;if(d){d.setRootNote(a,b);var e=c.getActingClefByEle(d);d.setRootStaffPos(c.calcStaffPosFromPitch(a,b,e));e=this.getOutputBoundingBox([d.zone.ulx,d.zone.uly,d.zone.lrx,d.zone.lry]);$.post(this.apiprefix+"/move/custos",{id:d.id,pname:a,oct:b,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3]}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}else{var f=
new Toe.Model.Custos(a,b),d=c.zone.lrx-gui.punctWidth/2,e=c.zone.uly;f.setBoundingBox([d,e,d+gui.punctWidth,e+gui.punctHeight]);d=new Toe.View.CustosView(gui.rendEng);new Toe.Ctrl.CustosController(f,d);c.setCustos(f);e=this.getOutputBoundingBox([f.zone.ulx,f.zone.uly,f.zone.lrx,f.zone.lry]);a={id:f.id,pname:a,oct:b,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3]};if(c=gui.page.getNextStaff(c))a.beforeid=c.id;$.post(this.apiprefix+"/insert/custos",a,function(a){f.id=JSON.parse(a).id}).error(function(){$("#alert > p").text("Server failed to insert custos. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)})}};Toe.View.GUI.prototype.getOutputBoundingBox=function(a){gui=this;return $.map(a,function(a){return Math.round(a/gui.page.scale)})};Toe.Model.NeumeComponent=function(a,b,c){this.props={type:"punctum",ornaments:[],interact:!0};$.extend(this.props,c);this.setHeadShape(this.props.type);this.setPitchInfo(a,b);this.pitchDiff=null};Toe.Model.NeumeComponent.prototype.constructor=Toe.Model.NeumeComponent;Toe.Model.NeumeComponent.Type={punctum:"Punctum",virga:"Virga",cavum:"Cavum",punctum_inclinatum:"Punctum Inclinatum",punctum_inclinatum_parvum:"Punctum Inclinatum Parva",quilisma:"Quilisma"};
Toe.Model.NeumeComponent.prototype.setHeadShape=function(a){this.props.type=a.toLowerCase();this.props.name=Toe.Model.NeumeComponent.Type[this.props.type];if(void 0==this.props.name)throw Error("NeumeComponent: undefined head shape");};Toe.Model.NeumeComponent.prototype.setPitchDifference=function(a){this.pitchDiff=a};Toe.Model.NeumeComponent.prototype.setPitchInfo=function(a,b){this.pname=a;this.oct=b};
Toe.Model.NeumeComponent.prototype.hasOrnament=function(a){return $.grep(this.props.ornaments,function(b){return b.key==a.toLowerCase()}).length};Toe.Model.NeumeComponent.prototype.addOrnament=function(a){if(!(a instanceof Toe.Model.Ornament))throw Error("NeumeComponent: Invalid ornament");this.hasOrnament(a.key)||this.props.ornaments.push(a)};Toe.Model.NeumeComponent.prototype.removeOrnament=function(a){this.props.ornaments=$.grep(this.props.ornaments,function(b){return b.key==a.toLowerCase()},!0)};(function(a){var b=function(b,d){var e=a(b),f,g,n,l=a.extend({},{debug:!1,glyphpath:"",meipath:"",bgimgpath:"",bgimgopacity:0.6,apiprefix:"",origwidth:null,origheight:null,dwgLib:"liber",width:1E3},d);a.extend(l,{canvasid:"neon-canvas"});var m=function(b){function c(d){var e=parseInt(a(d).attr("ulx")),f=parseInt(a(d).attr("uly")),g=parseInt(a(d).attr("lrx"));d=parseInt(a(d).attr("lry"));return a.map([e,f,g,d],function(a){return Math.round(b.scale*a)})}var d=a(f).find("surface")[0],e=a("clef, sb",
f),h=[];a(e).each(function(b,c){a(c).is("sb")&&h.push(b)});var k=a("neume, sb",f),m=[];a(k).each(function(b,c){a(c).is("sb")&&m.push(b)});var n=a("division, sb",f),p=[];a(n).each(function(b,c){a(c).is("sb")&&p.push(b)});var r=a("custos, sb",f),x=[];a(r).each(function(b,c){a(c).is("sb")&&x.push(b)});a("sb",f).each(function(u,y){l.debug&&console.log("system "+(u+1));var v=a(y).attr("systemref"),v=a(a(f).find("system[xml\\:id="+v+"]")[0]).attr("facs"),v=a(d).find("zone[xml\\:id="+v+"]")[0],v=c(v);l.debug&&
g.outlineBoundingBox(v,{fill:"blue"});var w=new Toe.Model.Staff(v);w.setID(a(y).attr("xml:id"));0==u&&g.calcScaleFromStaff(w,{overwrite:!0});v=new Toe.View.StaffView(g);new Toe.Ctrl.StaffController(w,v);b.addStaff(w);a(e).slice(h[u]+1,h[u+1]).each(function(b,e){var f=a(e).attr("shape"),h=parseInt(a(e).attr("line")),h=2*-(w.props.numLines-h),k=a(e).attr("facs"),k=a(d).find("zone[xml\\:id="+k+"]")[0],k=c(k);l.debug&&g.outlineBoundingBox(k,{fill:"red"});f=new Toe.Model.Clef(f,{staffPos:h});f.setID(a(e).attr("xml:id"));
f.setBoundingBox(k);h=new Toe.View.ClefView(g);new Toe.Ctrl.ClefController(f,h);w.addClef(f);l.debug&&console.log("clef: "+f.name)});a(k).slice(m[u]+1,m[u+1]).each(function(b,e){var f=new Toe.Model.Neume,h=a(d).find("zone[xml\\:id="+a(e).attr("facs")+"]")[0],h=c(h);l.debug&&g.outlineBoundingBox(h,{fill:"green"});f.neumeFromMei(e,h);h=new Toe.View.NeumeView(g,l.dwgLib);new Toe.Ctrl.NeumeController(f,h);w.addNeume(f);l.debug&&console.log("neume: "+f.name)});a(n).slice(p[u]+1,p[u+1]).each(function(b,
e){var f=a(d).find("zone[xml\\:id="+a(e).attr("facs")+"]")[0],h=c(f);l.debug&&g.outlineBoundingBox(h,{fill:"yellow"});var f="div_"+a(e).attr("form"),k=new Toe.Model.Division(f);k.setBoundingBox(h);k.setID(a(e).attr("xml:id"));h=new Toe.View.DivisionView(g);new Toe.Ctrl.DivisionController(k,h);w.addDivision(k);l.debug&&console.log("division: "+f)});a(r).slice(x[u]+1,x[u+1]).each(function(b,e){var f=a(d).find("zone[xml\\:id="+a(e).attr("facs")+"]")[0],f=c(f);l.debug&&g.outlineBoundingBox(f,{fill:"purple"});
var h=a(e).attr("pname"),k=parseInt(a(e).attr("oct")),h=new Toe.Model.Custos(h,k);h.setBoundingBox(f);h.setID(a(e).attr("xml:id"));f=new Toe.View.CustosView(g);new Toe.Ctrl.CustosController(h,f);w.setCustos(h);l.debug&&console.log("custos")})});g.repaint()},h=function(b){console.log("loading SVG glyphs ...");return a.get(l.glyphpath,function(c){var d={};a(c).find("svg").each(function(b,c){var e=a("<lol>").append(a(c).clone()).remove().html();fabric.loadSVGFromString(e,function(b,e){var f=a(c).attr("id"),
g=fabric.util.groupSVGElements(b,e);d[f]=new Toe.Model.Glyph(f,g)})});b.setGlyphs(d)})},k=function(){console.log("loading background image ...");var b=a.Deferred();!l.bgimgpath||l.origwidth||l.origheight?b.resolve():fabric.Image.fromURL(l.bgimgpath,function(a){l.origwidth=a.width;l.origheight=a.height;b.resolve()});return b.promise()},p=function(){var b=a.Deferred();l.meipath?a.get(l.meipath,function(a){console.log("loading MEI file ...");f=a;b.resolve()}):b.resolve();return b.promise()},r=function(){var b=
new Toe.Model.Page,c=a("<canvas>").attr("id",l.canvasid),d=[l.origwidth,l.origheight];l.bgimgpath||(d=b.calcDimensions(a(f).find("zone")));b.setPageScale(l.width/d[0]);b.setDimensions(Math.round(d[0]),Math.round(d[1]));c.attr("width",b.width);c.attr("height",b.height);c.attr("style","border: 4px black solid;");e.prepend(c);c={renderOnAddition:!1};l.bgimgpath&&a.extend(c,{backgroundImage:l.bgimgpath,backgroundImageOpacity:l.bgimgopacity,backgroundImageStretch:!0});g.setCanvas(new fabric.Canvas(l.canvasid,
c));if(l.debug){var h=a("<div>").attr("id","fps");h.attr("style","color: red; font-size: 200%");e.prepend(h);g.canvas.onFpsUpdate=function(b){a(h).html("FPS: "+b)}}c=new Toe.View.PageView(g);new Toe.Ctrl.PageController(b,c);f&&m(b);new Toe.View.GUI(l.apiprefix,l.meipath,l.dwgLib,g,b,{sldr_bgImgOpacity:l.bgimgpath,initBgImgOpacity:l.bgimgopacity});console.log("Neon.js ready ("+(new Date-n)+"ms)")};(function(){n=new Date;g=new Toe.View.RenderEngine;a.when(h(g),p(),k()).then(r,function(){console.log("Failure to load the mei file, glyphs, or background image")})})()};
a.fn.neon=function(c){return this.each(function(){var d=a(this);if(!d.data("neon")){var e=new b(this,c);d.data("neon",e)}})}})(jQuery);function SearchTree(){this.rootNode=null;this.numNodes=0}function SearchTreeNode(a){this.payload=a;this.children={};this.numChildren=0}
SearchTree.prototype={setRootNode:function(a){this.rootNode=a},insert:function(a,b){if(!this.rootNode)if(a.length)this.setRootNode(new SearchTreeNode(null)),this.numNodes++;else{this.setRootNode(new SearchTreeNode(b));this.numNodes++;return}this.rootNode.insert(a,b)},remove:function(a){this.rootNode.remove(a)},destroyTree:function(){this.rootNode=null;this.numNodes=0},search:function(a,b){for(var c=this.rootNode,d=0;d<a.length;d++){var e=a[d];if(e in c.children)c=c.children[e];else return b?{result:c.payload,
prefix:!0}:null}return{result:c.payload,prefix:!1}},stringify:function(){return JSON.stringify(this)},populateFromJSON:function(a){a=JSON.parse(a);this.rootNode=a.rootNode;this.numNodes=a.numNodes}};
SearchTreeNode.prototype={insert:function(a,b){var c=a.splice(0,1);a.length?(c in this.children||(this.children[c]=new SearchTreeNode(null),this.numChildren++),this.children[c].insert(a,b)):c in this.children?this.children[c].payload=b:(this.children[c]=new SearchTreeNode(b),this.numChildren++)},remove:function(a){var b=a.splice(0,1);a.length?b in this.children&&this.children[b].remove(a):b in this.children&&(this.children[b].numChildren?this.children[b].payload=null:(delete this.children[b],this.numChildren--))}};var drawSalzinnesNeume=function(a){if(!this.rendEng)throw Error("Neume: Invalid render context");this.ledgerLines&&this.rendEng.canvas.remove(this.ledgerLines);for(var b=this.calcNoteYPos(a),c=a.staff,d=this,e=[],f=0;f<a.components.length;f++){var g=null;switch(a.components[f].props.name){case Toe.Model.NeumeComponent.Type.punctum:g="punctum";break;case Toe.Model.NeumeComponent.Type.virga:g="punctum";break;case Toe.Model.NeumeComponent.Type.cavum:g="whitepunct";break;case Toe.Model.NeumeComponent.Type.punctum_inclinatum:g=
"diamond";break;case Toe.Model.NeumeComponent.Type.punctum_inclinatum_parvum:g="diamond_small";break;case Toe.Model.NeumeComponent.Type.quilisma:g="quilisma"}e.push(this.rendEng.getGlyph(g))}var n=this.rendEng.getGlyph("dot"),l={fixed:[],modify:[]};switch(a.typeid){case "punctum":case "cavum":var m=a.zone.ulx+e[0].centre[0],g=e[0].clone().set({left:m,top:b[0]});l.modify.push(g);if(a.components[0].hasOrnament("dot")){var h=this.bestDotPlacements(c,b,0);l.modify.push(n.clone().set({left:g.left+2*e[0].centre[0],
top:h[0]}))}this.drawLedgerLines([a.rootStaffPos],[m],2*e[0].centre[0],c);break;case "distropha":case "tristropha":var k=[];k.push(a.zone.ulx+e[0].centre[0]);for(m=0;m<a.components.length;m++)g=e[m].clone().set({left:k[m],top:b[m]}),l.modify.push(g),k.push(k[m]+3*e[m].centre[0]);$.each(a.components,function(a,e){if(e.hasOrnament("dot")){var f=d.bestDotPlacements(c,b,a);0<f.length&&l.modify.push(n.clone().set({left:k[k.length-1],top:f[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+
b.pitchDiff}),k,2*e[0].centre[0],c);break;case "virga":m=a.zone.ulx+e[0].centre[0];g=e[0].clone().set({left:m,top:b[0]});l.modify.push(g);a.components[0].hasOrnament("dot")&&(h=this.bestDotPlacements(c,b,0),l.modify.push(n.clone().set({left:g.left+2*e[0].centre[0],top:h[0]})));h=g.left+e[0].centre[0]-1;f=this.rendEng.createLine([h,b[0],h,b[0]+1.5*c.delta_y],{strokeWidth:2,interact:!0});l.fixed.push(f);this.drawLedgerLines([a.rootStaffPos],[m],2*e[0].centre[0],c);break;case "bivirga":case "trivirga":k=
[];k.push(a.zone.ulx+e[0].centre[0]);for(m=0;m<a.components.length;m++)g=e[m].clone().set({left:k[m],top:b[m]}),l.modify.push(g),h=g.left+e[m].centre[0]-1,f=this.rendEng.createLine([h,b[m],h,b[m]+1.5*c.delta_y],{strokeWidth:2,interact:!0}),l.fixed.push(f),k.push(k[m]+3*e[m].centre[0]);$.each(a.components,function(a,e){if(e.hasOrnament("dot")){var f=d.bestDotPlacements(c,b,a);0<f.length&&l.modify.push(n.clone().set({left:k[k.length-1],top:f[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+
b.pitchDiff}),k,2*e[0].centre[0],c);break;case "clivis":k=[];k.push(a.zone.ulx+e[0].centre[0]);var p=e[0].clone().set({left:k[0],top:b[0]});l.modify.push(p);h=p.left+e[0].centre[0]-1;f=this.rendEng.createLine([h,b[0],h,b[1]],{strokeWidth:2,interact:!0});l.fixed.push(f);k.push(k[0]+2*e[1].centre[0]);var r=e[1].clone().set({left:k[1],top:b[1]});l.modify.push(r);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&l.modify.push(n.clone().set({left:r.left+
2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "cephalicus":k=[];m=this.rendEng.getGlyph("cephalicus");k.push(a.zone.ulx+m.centre[0]);p=m.clone().set({left:k[0],top:b[0]-m.centre[1]/2});l.modify.push(p);g=k[0]-m.centre[0]+1;f=this.rendEng.createLine([g,b[0],g,a.zone.lry],{strokeWidth:2,interact:!0});l.fixed.push(f);h=p.left+m.centre[0]-2;f=this.rendEng.createLine([h,b[0],h,b[1]],{strokeWidth:2,
interact:!0});l.fixed.push(f);g=this.rendEng.getGlyph("liques_up");k.push(k[0]+m.centre[0]-g.centre[0]);r=g.clone().set({left:k[1],top:b[1]-g.centre[1]/2});l.modify.push(r);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&l.modify.push(n.clone().set({left:r.left+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "climacus.1":case "climacus.2":case "climacus.3":case "climacus.4":k=
[];k.push(a.zone.ulx+e[0].centre[0]);m=e[0].centre[0];g=e[0].clone().set({left:k[0],top:b[0]});l.modify.push(g);h=g.left+e[0].centre[0]-1;f=this.rendEng.createLine([h,b[0],h,b[0]+1.5*c.delta_y],{strokeWidth:2,interact:!0});l.fixed.push(f);for(g=1;g<a.components.length;g++)k.push(k[g-1]+2*e[g-1].centre[0]-1),1==g&&(k[1]+=m),h=e[g].clone().set({left:k[g],top:b[g]}),l.modify.push(h);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&l.modify.push(n.clone().set({left:k[a]+
2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "torculus":k=[];k.push(a.zone.ulx+e[0].centre[0]);k.push(k[0]+2*e[0].centre[0]-1);k.push(k[1]+2*e[1].centre[0]-1);p=e[0].clone().set({left:k[0],top:b[0]});l.modify.push(p);h=p.left+e[0].centre[0]-1;f=this.rendEng.createLine([h,b[0],h,b[1]],{strokeWidth:2,interact:!0});l.fixed.push(f);r=e[1].clone().set({left:k[1],top:b[1]});l.modify.push(r);h=r.left+
e[1].centre[0]-1;f=this.rendEng.createLine([h,b[1],h,b[2]],{strokeWidth:2,interact:!0});l.fixed.push(f);g=e[2].clone().set({left:k[2],top:b[2]});l.modify.push(g);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&l.modify.push(n.clone().set({left:k[a]+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "torculus.resupinus.1":case "torculus.resupinus.2":case "torculus.resupinus.3":case "torculus.resupinus.4":k=
[];k.push(a.zone.ulx+e[0].centre[0]);p=e[0].clone().set({left:k[0],top:b[0]});l.modify.push(p);var h=this.rendEng.getGlyph("porrect_1"),q=h.clone().set({left:k[0]+e[0].centre[0]+h.centre[0]-1,top:b[1]+h.centre[1]/2});l.modify.push(q);var g=q.left-h.centre[0],f=b[0],s=q.top+h.centre[1],f=this.rendEng.createLine([g,b[1],g,f],{strokeWidth:2,interact:!0});l.fixed.push(f);"torculus.resupinus.1"==a.typeid?k.push(q.left+h.centre[0]-e[3].centre[0]):k.push(q.left+h.centre[0]+e[3].centre[0]);g=e[3].clone().set({left:k[1],
top:b[3]});l.modify.push(g);h=q.left+h.centre[0]-1;f=this.rendEng.createLine([h,b[3],h,b[2]],{strokeWidth:2,interact:!0});l.fixed.push(f);"torculus.resupinus.2"==a.typeid&&(h=g.left+e[3].centre[0]-1,f=this.rendEng.createLine([h,b[4],h,b[3]],{strokeWidth:2,interact:!0}),l.fixed.push(f));for(g=4;g<a.components.length;g++)k.push(k[k.length-1]+2*e[g].centre[0]-1),h=e[g].clone().set({left:k[k.length-1],top:b[g]}),l.modify.push(h);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,
b,a);0<g.length&&l.modify.push(n.clone().set({left:k[a]+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "podatus":k=[];k.push(a.zone.ulx+e[0].centre[0]);p=e[0].clone().set({left:k[0],top:b[0]});l.modify.push(p);k.push(k[0]+2*e[1].centre[0]);r=e[1].clone().set({left:k[1],top:b[1]});l.modify.push(r);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&
l.modify.push(n.clone().set({left:p.left+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "epiphonus":k=[];m=this.rendEng.getGlyph("podatus_ep");k.push(a.zone.ulx+m.centre[0]);p=m.clone().set({left:k[0],top:b[0]});l.modify.push(p);h=p.left+m.centre[0]-2;f=this.rendEng.createLine([h,b[0],h,b[1]],{strokeWidth:2,interact:!0});l.fixed.push(f);g=this.rendEng.getGlyph("liques_down");k.push(k[0]+m.centre[0]-
g.centre[0]);r=g.clone().set({left:k[1],top:b[1]+g.centre[1]/2});l.modify.push(r);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&l.modify.push(n.clone().set({left:p.left+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "porrectus":m=a.components[0].pitchDiff+a.components[1].pitchDiff;h=null;switch(m){case -1:h=this.rendEng.getGlyph("porrect_1");
break;case -2:h=this.rendEng.getGlyph("porrect_2");break;case -3:h=this.rendEng.getGlyph("porrect_3");break;case -4:h=this.rendEng.getGlyph("porrect_4");break;default:h=this.rendEng.getGlyph("porrect_4")}q=h.clone().set({left:a.zone.ulx+h.centre[0],top:b[0]+h.centre[1]/2});l.modify.push(q);g=q.left-h.centre[0]+1;f=a.zone.lry;s=q.top+h.centre[1];a.zone.lry<q.top+s&&(f=s);f=this.rendEng.createLine([g,b[0],g,f],{strokeWidth:2,interact:!0});l.fixed.push(f);k=q.left+h.centre[0]-e[2].centre[0];g=e[2].clone().set({left:k,
top:b[2]});h=g.left+e[2].centre[0]-1;f=this.rendEng.createLine([h,b[2],h,b[1]],{strokeWidth:2,interact:!0});l.fixed.push(f);l.modify.push(g);a.components[2].hasOrnament("dot")&&(h=this.bestDotPlacements(c,b,2),0<h.length&&l.modify.push(n.clone().set({left:g.left+2*e[2].centre[0],top:h[0]})));this.drawLedgerLines([a.rootStaffPos+a.components[2].pitchDiff],[k],2*e[2].centre[0],c);break;case "porrectus.flexus":h=this.rendEng.getGlyph("porrect_1");q=h.clone().set({left:a.zone.ulx+h.centre[0],top:b[0]+
h.centre[1]/2});l.modify.push(q);g=q.left-h.centre[0]+1;f=a.zone.lry;s=q.top+h.centre[1];a.zone.lry<q.top+s&&(f=s);f=this.rendEng.createLine([g,b[0],g,f],{strokeWidth:2,interact:!0});l.fixed.push(f);k=[];k.push(q.left+h.centre[0]+e[2].centre[0]);g=e[2].clone().set({left:k[0],top:b[2]});h=k[0]-e[2].centre[0]-1;f=this.rendEng.createLine([h,b[2],h,b[1]],{strokeWidth:2,interact:!0});l.fixed.push(f);l.modify.push(g);for(g=3;g<a.components.length;g++)k.push(k[k.length-1]+2*e[g].centre[0]-1),h=e[g].clone().set({left:k[k.length-
1],top:b[g]}),l.modify.push(h);for(g=2;g<a.components.length;g++)a.components[g].hasOrnament("dot")&&(h=d.bestDotPlacements(c,b,m),0<h.length&&l.modify.push(n.clone().set({left:p.left+2*e[1].centre[0],top:h[0]})));break;case "scandicus.1":case "scandicus.2":case "scandicus.3":case "scandicus.4":m=a.components.length;q=a.zone.ulx-e[0].centre[0];k=[];for(g=0;g<m-1;g+=2)for(yoffset=0,1==Math.abs(a.components[g+1].pitchDiff-a.components[g].pitchDiff)&&(yoffset=1),q+=2*e[g].centre[0]-1,k.push(q),h=e[g].clone().set({left:k[g],
top:b[g]-e[g].centre[1]/2+yoffset}),l.modify.push(h),k.push(k[g]+2*e[g+1].centre[0]),r=e[g+1].clone().set({left:k[g+1],top:b[g+1]-yoffset}),l.modify.push(r),f=g;f<g+2;f++)a.components[f].hasOrnament("dot")&&(h=this.bestDotPlacements(c,b,f),0<h.length&&l.modify.push(n.clone().set({left:r.left+2*e[f].centre[0],top:h[0]})));1==a.components.length%2&&(q+=2*e[m-1].centre[0]-1,k.push(q),g=e[m-1].clone().set({left:q,top:b[m-1]}),l.modify.push(g),a.components[m-1].hasOrnament("dot")&&(h=this.bestDotPlacements(c,
b,m-1),0<h.length&&l.modify.push(n.clone().set({left:g.left+2*e[m-1].centre[0],top:h[0]}))));this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "scandicus.flexus.1":k=[];k.push(a.zone.ulx+e[0].centre[0]);p=e[0].clone().set({left:k[0],top:b[0]});l.modify.push(p);h=p.left+e[0].centre[0];f=this.rendEng.createLine([h,b[0],h,b[1]],{strokeWidth:2,interact:!0});l.fixed.push(f);k.push(k[0]+2*e[1].centre[0]);r=e[1].clone().set({left:k[1],
top:b[1]});l.modify.push(r);for(f=0;2>f;f++)a.components[f].hasOrnament("dot")&&(h=this.bestDotPlacements(c,b,f),0<h.length&&l.modify.push(n.clone().set({left:k[f]+2*e[f].centre[0],top:h[0]})));k.push(k[1]+2*e[2].centre[0]);g=e[2].clone().set({left:k[2],top:b[2]});l.modify.push(g);h=k[2]+e[2].centre[0]-1;f=this.rendEng.createLine([h,b[2],h,b[3]],{strokeWidth:2,interact:!0});l.fixed.push(f);k.push(k[2]+2*e[3].centre[0]);g=e[3].clone().set({left:k[3],top:b[3]});l.modify.push(g);for(f=2;f<a.components.length;f++)a.components[f].hasOrnament("dot")&&
(h=d.bestDotPlacements(c,b,m),0<h.length&&l.modify.push(n.clone().set({left:r.left+2*e[1].centre[0],top:h[0]})));this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c)}this.drawing=this.rendEng.draw(l,{group:!0,selectable:a.props.interact,eleRef:a})[0];$(a).trigger("mUpdateBoundingBox",this.drawing)};Toe.Model.Neume=function(a){this.zone={};this.props={modifier:null,interact:!0};$.extend(this.props,a);this.props.modifier=Toe.Model.Neume.Modifier[this.props.modifier];void 0==this.props.modifier&&(this.props.modifier=null);this.staff=this.id=this.rootStaffPos=this.neumePrefix=this.typeid=this.name=null;this.components=[]};Toe.Model.Neume.prototype.constructor=Toe.Model.Neume;Toe.Model.Neume.Modifier={alt:"liquescence",shift:"variant 2",ctrl:"variant 3",ctrl_shift:"variant 4"};
Toe.Model.Neume.SearchTree=new SearchTree;Toe.Model.Neume.SearchTree.populateFromJSON('{"rootNode":{"payload":{"typeid":"punctum","name":"Punctum"},"children":{"0":{"payload":{"typeid":"distropha","name":"Distropha"},"children":{"0":{"payload":{"typeid":"tristropha","name":"Tristropha"},"children":{},"numChildren":0}},"numChildren":1},"1":{"payload":{"typeid":"podatus","name":"Podatus"},"children":{"1":{"payload":{"typeid":"scandicus.1","name":"Scandicus"},"children":{"1":{"payload":{"typeid":"scandicus.2","name":"Scandicus"},"children":{"1":{"payload":{"typeid":"scandicus.3","name":"Scandicus"},"children":{"1":{"payload":{"typeid":"scandicus.4","name":"Scandicus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"scandicus.flexus.3","name":"Scandicus Flexus"},"children":{},"numChildren":0}},"numChildren":2},"-1":{"payload":{"typeid":"scandicus.flexus.2","name":"Scandicus Flexus"},"children":{},"numChildren":0}},"numChildren":2},"-1":{"payload":{"typeid":"scandicus.flexus.1","name":"Scandicus Flexus"},"children":{"-1":{"payload":{"typeid":"scandicus.subpunctis.1","name":"Scandicus Subpunctis"},"children":{"-1":{"payload":{"typeid":"scandicus.subpunctis.2","name":"Scandicus Subpunctis"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":1}},"numChildren":2},"-1":{"payload":{"typeid":"torculus","name":"Torculus"},"children":{"1":{"payload":{"typeid":"torculus.resupinus.1","name":"Torculus Resupinus"},"children":{"-1":{"payload":{"typeid":"torculus.resupinus.2","name":"Torculus Resupinus"},"children":{"-1":{"payload":{"typeid":"torculus.resupinus.3","name":"Torculus Resupinus"},"children":{"-1":{"payload":{"typeid":"torculus.resupinus.4","name":"Torculus Resupinus"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":1}},"numChildren":1},"-1":{"payload":{"typeid":"podatus.subpunctis.1","name":"Podatus Subpunctis"},"children":{"1":{"payload":{"typeid":"podatus.subpunctis.resupinus.1","name":"Podatus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"podatus.subpunctis.2","name":"Podatus Subpunctis"},"children":{"1":{"payload":{"typeid":"podatus.subpunctis.resupinus.2","name":"Podatus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"podatus.subpunctis.3","name":"Podatus Subpunctis"},"children":{"1":{"payload":{"typeid":"podatus.subpunctis.resupinus.3","name":"Podatus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"podatus.subpunctis.4","name":"Podatus Subpunctis"},"children":{},"numChildren":0}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":2},"-1":{"payload":{"typeid":"clivis","name":"Clivis"},"children":{"1":{"payload":{"typeid":"porrectus","name":"Porrectus"},"children":{"1":{"payload":{"typeid":"compound.2","name":"Compound"},"children":{"-1":{"payload":{"typeid":"compound.1","name":"Compound"},"children":{},"numChildren":0}},"numChildren":1},"-1":{"payload":{"typeid":"porrectus.flexus","name":"Porrectus Flexus"},"children":{"-1":{"payload":{"typeid":"porrectus.subpunctis.1","name":"Porrectus Subpunctis"},"children":{"1":{"payload":{"typeid":"porrectus.subpunctis.resupinus.1","name":"Porrectus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"porrectus.subpunctis.2","name":"Porrectus Subpunctis"},"children":{"1":{"payload":{"typeid":"porrectus.subpunctis.resupinus.2","name":"Porrectus Subpunctis Resupinus"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":2}},"numChildren":1}},"numChildren":2},"-1":{"payload":{"typeid":"climacus.1","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.1","name":"Climacus Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"climacus.2","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.2","name":"Climacus Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"climacus.3","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.3","name":"Climacus Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"climacus.4","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.4","name":"Climacus Resupinus"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":3},"numNodes":1}');
Toe.Model.Neume.prototype.setID=function(a){this.id=a};Toe.Model.Neume.prototype.setStaff=function(a){if(!(a instanceof Toe.Model.Staff))throw Error("Neume: invalid staff reference");this.staff=a};Toe.Model.Neume.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Neume: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};
Toe.Model.Neume.prototype.getRootPitchInfo=function(){var a=null,b=null;0<this.components.length&&(a=this.components[0].pname,b=this.components[0].oct);return{pname:a,oct:b}};Toe.Model.Neume.prototype.getPitchInfo=function(){var a=[];$.each(this.components,function(b,c){a.push({pname:c.pname,oct:c.oct})});return a};
Toe.Model.Neume.prototype.setRootStaffPos=function(a){if(this.rootStaffPos!=a){this.rootStaffPos=a;var b=this.staff.getActingClefByEle(this);this.staff.calcPitchFromStaffPos(this.rootStaffPos,b);var c=this;$.each(this.components,function(a,e){var f=c.staff.calcPitchFromStaffPos(c.rootStaffPos+e.pitchDiff,b);e.setPitchInfo(f.pname,f.oct)});this.syncDrawing()}};
Toe.Model.Neume.prototype.neumeFromMei=function(a,b){if("neume"!=a.nodeName.toLowerCase())throw Error("neumeFromMei: invalid neume data");this.id=$(a).attr("xml:id");var c=$(a).attr("name").toLowerCase();"epiphonus"==c?(c="podatus",this.props.modifier=Toe.Model.Neume.Modifier.alt):"cephalicus"==c&&(c="clivis",this.props.modifier=Toe.Model.Neume.Modifier.alt);this.setBoundingBox(b);var d=this;$(a).find("note").each(function(a,b){var g=$(b).attr("pname"),n=parseInt($(b).attr("oct")),l="punctum";"true"==
$(this).parent().attr("inclinatum")?l="true"==$(this).parent().attr("deminutus")?"punctum_inclinatum_parvum":"punctum_inclinatum":"true"==$(this).parent().attr("quilisma")?l="quilisma":"virga"==c||"bivirga"==c||"trivirga"==c?l="virga":"cavum"==c&&(l="cavum");var m=[],h=$("> dot",this).attr("form");h&&m.push(new Toe.Model.Ornament("dot",{form:h}));d.addComponent(l,g,n,{ornaments:m})});return this};
Toe.Model.Neume.prototype.addComponent=function(a,b,c,d){opts={ncInd:this.components.length,ornaments:[]};$.extend(opts,d);a=new Toe.Model.NeumeComponent(b,c,{type:a,ornaments:opts.ornaments});this.components.splice(opts.ncInd,0,a)};Toe.Model.Neume.prototype.getDifferences=function(){for(var a=[],b=1;b<this.components.length;b++)a.push(this.components[b].pitchDiff);return a};
Toe.Model.Neume.prototype.diffToMelodicMove=function(){var a=this.getDifferences(),b=0;return a=$.map(a,function(a,d){var e=0;a>b?e=1:a<b&&(e=-1);b=a;return e})};
Toe.Model.Neume.prototype.deriveName=function(a){var b={enforceHeadShapes:!0};$.extend(b,a);if(0==this.components.length)return"unknown";a=this.diffToMelodicMove();a=Toe.Model.Neume.SearchTree.search(a,!0);a.prefix?(this.neumePrefix=a.result.typeid,this.name="Compound",this.typeid="compound"):(this.neumePrefix=null,this.name=a.result.name,this.typeid=a.result.typeid);"punctum"==this.typeid&&"virga"==this.components[0].props.type?(this.name="Virga",this.typeid="virga"):"distropha"==this.typeid&&"virga"==
this.components[0].props.type?(this.name="Bivirga",this.typeid="bivirga"):"tristropha"==this.typeid&&"virga"==this.components[0].props.type?(this.name="Trivirga",this.typeid="trivirga"):"Punctum"==this.name&&"cavum"==this.components[0].props.type?(this.name="Cavum",this.typeid="cavum"):"Podatus"==this.name&&this.props.modifier==Toe.Model.Neume.Modifier.alt?(this.name="Epiphonus",this.typeid="epiphonus"):"Clivis"==this.name&&this.props.modifier==Toe.Model.Neume.Modifier.alt&&(this.name="Cephalicus",
this.typeid="cephalicus");b.enforceHeadShapes&&this.enforceHeadShapes();return this.name};
Toe.Model.Neume.prototype.enforceHeadShapes=function(){switch(this.typeid){case "climacus.1":case "climacus.2":case "climacus.3":case "climacus.4":for(var a=1;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "climacus.resupinus.1":case "climacus.resupinus.2":case "climacus.resupinus.3":case "climacus.resupinus.4":for(a=1;a<this.components.length-1;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "podatus.subpunctis.1":case "podatus.subpunctis.2":case "podatus.subpunctis.3":case "podatus.subpunctis.4":for(a=
2;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "podatus.subpunctis.resupinus.1":case "podatus.subpunctis.resupinus.2":case "podatus.subpunctis.resupinus.3":for(a=2;a<this.components.length-1;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "scandicus.subpunctis.1":case "scandicus.subpunctis.2":for(a=3;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "porrectus.subpunctis.1":case "porrectus.subpunctis.2":for(a=
3;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "porrectus.subpunctis.resupinus.1":case "porrectus.subpunctis.resupinus.2":for(a=3;a<this.components.length-1;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "torculus.resupinus.3":case "torculus.resupinus.4":for(a=4;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum")}};
Toe.Model.Neume.prototype.syncDrawing=function(){this.deriveName();$(this).trigger("vUpdateDrawing",[this])};Toe.Ctrl.NeumeController=function(a,b){$(a).bind("mUpdateBoundingBox",function(b,d){var e=d.left-d.currentWidth/2,f=d.top-d.currentHeight/2;a.setBoundingBox([e,f,e+d.currentWidth,f+d.currentHeight])});$(a).bind("vRenderNeume",function(a,d){d.typeid||d.deriveName();b.render(d)});$(a).bind("vUpdateDrawing",function(a,d){b.updateDrawing(d)});$(a).bind("vEraseDrawing",function(a){b.eraseDrawing()});$(a).bind("vSelectDrawing",function(a){b.selectDrawing()})};
Toe.Ctrl.NeumeController.prototype.constructor=Toe.Ctrl.NeumeController;Toe.View.NeumeView=function(a,b){this.rendEng=a;if("liber"==b)Toe.View.NeumeView.prototype.drawNeume=drawLiberNeume;else if("salzinnes"==b)Toe.View.NeumeView.prototype.drawNeume=drawSalzinnesNeume;else throw"Invalid Drawing Library";this.ledgerLines=this.drawing=null};Toe.View.NeumeView.prototype.constructor=Toe.View.NeumeView;
Toe.View.NeumeView.prototype.calcNoteYPos=function(a){var b=a.staff,c=[];c.push(b.zone.uly-a.rootStaffPos*b.delta_y/2);for(var d=1;d<a.components.length;d++)c.push(c[0]+-a.components[d].pitchDiff*b.delta_y/2);return c};
Toe.View.NeumeView.prototype.bestDotPlacements=function(a,b,c){var d=[],e=a.zone.uly+a.delta_y/2,f=ypos=b[c],g=Math.round(2*(f-e)/a.delta_y);0==g%2&&d.push(f);var n=ypos-a.delta_y/2,g=Math.round(2*(n-e)/a.delta_y),f=!1;if(0<=c-1&&ypos-a.delta_y/2==b[c-1]||c+1<b.length&&ypos-a.delta_y/2==b[c+1])f=!0;0!=g%2||f||d.push(n);n=ypos+a.delta_y/2;g=Math.round(2*(n-e)/a.delta_y);f=!1;if(c+1<b.length&&ypos+a.delta_y/2==b[c+1]||0<=c-1&&ypos+a.delta_y/2==b[c-1])f=!0;0!=g%2||f||d.push(n);return d};
Toe.View.NeumeView.prototype.drawLedgerLines=function(a,b,c,d){c*=0.75;var e=this,f=[],g=2*(1-d.props.numLines);$.each(a,function(a,l){if(0<l)for(var m=0;m<=l;m+=2){var h=d.zone.uly-m*d.delta_y/2;f.push(e.rendEng.createLine([b[a]-c,h,b[a]+c,h]))}else if(l<g)for(m=g;m>=l;m-=2)h=d.zone.uly-m*d.delta_y/2,f.push(e.rendEng.createLine([b[a]-c,h,b[a]+c,h]))});this.ledgerLines=this.rendEng.draw({fixed:f,modify:[]},{group:!0,selectable:!1})[0]};Toe.View.NeumeView.prototype.render=function(a){this.drawNeume(a)};
Toe.View.NeumeView.prototype.updateDrawing=function(a){this.drawing&&this.rendEng.canvas.remove(this.drawing);this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);this.drawNeume(a);this.selectDrawing();this.rendEng.repaint()};Toe.View.NeumeView.prototype.eraseDrawing=function(){this.drawing&&this.rendEng.canvas.remove(this.drawing);this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);this.rendEng.repaint()};
Toe.View.NeumeView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Model.Ornament=function(a,b){this.key=a.toLowerCase();this.type=Toe.Model.Ornament.Type[this.key];if(void 0==this.type)throw Error("Ornament: undefined ornament type");oForm="episema"==a?"horizontal":"dot"==a?"aug":null;this.props={form:oForm,interact:!1};$.extend(this.props,b)};Toe.Model.Ornament.prototype.constructor=Toe.Model.Ornament;Toe.Model.Ornament.Type={episema:"Episema",dot:"Dot"};Toe.Model.Page=function(){this.staves=[];this.scale=1};Toe.Model.Page.prototype.constructor=Toe.Model.Page;Toe.Model.Page.prototype.setDimensions=function(a,b){this.width=this.scale*a;this.height=this.scale*b};Toe.Model.Page.prototype.calcDimensions=function(a){var b=0,c=0;$(a).each(function(a,e){var f=parseInt($(e).attr("lrx")),g=parseInt($(e).attr("lry"));f>b&&(b=f);g>c&&(c=g)});return[b,c]};Toe.Model.Page.prototype.setPageScale=function(a){this.scale=a};
Toe.Model.Page.prototype.getClosestStaff=function(a){var b=$.map(this.staves,function(b){var d=Math.abs(a.y-(b.zone.lry-(b.zone.lry-b.zone.uly)/2));a.x<b.zone.ulx?d+=b.zone.ulx-a.x:a.x>b.zone.lrx&&(d+=a.x-b.zone.lrx);return d});sInd=$.inArray(Math.min.apply(Math,b),b);return this.staves[sInd]};Toe.Model.Page.prototype.getNextStaff=function(a){a=$.inArray(a,this.staves);return-1!=a&&a+1<this.staves.length?this.staves[a+1]:null};
Toe.Model.Page.prototype.getPreviousStaff=function(a){a=$.inArray(a,this.staves);return 0<=a-1?this.staves[a-1]:null};Toe.Model.Page.prototype.addStaff=function(a){this.staves.push(a);$(a).trigger("vRenderStaff",[a]);return this};Toe.Ctrl.PageController=function(a,b){$(b).bind("mSetDimensions.ui",function(b,d,e){a.setDimensions(d,e)});$(a).bind("vSetDimensions",function(a,d,e){b.setDimensions(d,e)})};Toe.Ctrl.PageController.prototype.constructor=Toe.Ctrl.PageController;Toe.View.PageView=function(a){this.rendEng=a};Toe.View.PageView.prototype.constructor=Toe.View.PageView;Toe.View.PageView.prototype.setDimensions=function(a,b){this.canvas.setDimensions({width:a,height:b})};Toe.View.RenderEngine=function(a){this.options={globScale:0.08};$.extend(this.options,a)};Toe.View.RenderEngine.prototype.constructor=Toe.View.RenderEngine;Toe.View.RenderEngine.prototype.setGlyphs=function(a){this.glyphs=a};Toe.View.RenderEngine.prototype.setCanvas=function(a){this.canvas=a;this.canvas.HOVER_CURSOR="pointer";this.canvas.selectionLineWidth=2;this.canvas.selectionBorderColor="black"};
Toe.View.RenderEngine.prototype.setGlobalScale=function(a){this.options.globScale=a;$.each(this.glyphs,function(b,c){c.centre=[c.centre[0]*a,c.centre[1]*a]})};Toe.View.RenderEngine.prototype.getGlobalScale=function(){return this.options.globScale};Toe.View.RenderEngine.prototype.getGlyph=function(a){return this.glyphs[a]};
Toe.View.RenderEngine.prototype.calcScaleFromStaff=function(a,b){opts={overwrite:!1};$.extend(opts,b);var c=(a.zone.lry-a.zone.uly)/(a.props.numLines-1),c=2*c-0.65*c,d=this.getGlyph("c_clef").clone().height;scale=Math.abs(c/d);opts.overwrite&&this.setGlobalScale(scale);return scale};
Toe.View.RenderEngine.prototype.createLine=function(a,b){var c={fill:"rgb(0,0,0)",strokeWidth:3,opacity:1,interact:!1};$.extend(c,b);return new fabric.Line(a,{fill:c.fill,stroke:c.fill,strokeWidth:c.strokeWidth,opacity:c.opacity,selectable:c.interact})};
Toe.View.RenderEngine.prototype.outlineBoundingBox=function(a,b){var c={fill:"rgb(0,255,0)",opacity:0.65,interact:!1};$.extend(c,b);var d=a[2]-a[0],e=a[3]-a[1];a=new fabric.Rect({width:d,height:e,left:a[0]+d/2,top:a[1]+e/2,fill:c.fill,opacity:c.opacity});d={fixed:[],modify:[]};d.fixed.push(a);this.draw(d,{selectable:c.interact,opacity:c.opacity})};
Toe.View.RenderEngine.prototype.draw=function(a,b){var c={modify:!0,repaint:!1,group:!1,selectable:!0,hasControls:!1,hasBorders:!1,lockMovementX:!1,lockMovementY:!1,opacity:1,eleRef:null};$.extend(c,b);a.modify=this.preprocess(a.modify);a=$.merge($.merge([],a.modify),a.fixed);c.group&&(a=[new fabric.Group(a)]);$.map(a,function(a,b){a.selectable=c.selectable;a.hasControls=c.hasControls;a.lockRotation=!0;a.lockScale=!0;a.lockMovementX=c.lockMovementX;a.lockMovementY=c.lockMovementY;a.borderColor="rgba(102,153,255,1.0)";
a.opacity=c.opacity;a.eleRef=c.eleRef});for(var d=0;d<a.length;d++)this.canvas.add(a[d]);c.repaint&&this.repaint();return a};Toe.View.RenderEngine.prototype.unObserve=function(a){delete this.canvas.__eventListeners[a]};Toe.View.RenderEngine.prototype.repaint=function(){this.canvas.renderAll()};
Toe.View.RenderEngine.prototype.preprocess=function(a){for(var b=0;b<a.length;b++)a[b]=a[b].scale(this.options.globScale),a[b].currentWidth*=this.options.globScale,a[b].currentHeight*=this.options.globScale;return a};Toe.Model.Staff=function(a,b){if(!Toe.validBoundingBox(a))throw Error("Staff: invalid bounding box");this.zone={};this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3];this.props={numLines:4,interact:!1};$.extend(this.props,b);this.delta_y=Math.abs(this.zone.lry-this.zone.uly)/(this.props.numLines-1);this.custos=this.id=null;this.elements=[]};Toe.Model.Staff.prototype.constructor=Toe.Model.Staff;Toe.Model.Staff.prototype.setID=function(a){this.id=a};
Toe.Model.Staff.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Staff: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3];this.delta_y=Math.abs(this.zone.lry-this.zone.uly)/(this.props.numLines-1)};
Toe.Model.Staff.prototype.getPitchedElements=function(a){var b={clef:null,neumes:!0,custos:!0};$.extend(b,a);if(b.clef){a=[];for(var c=$.inArray(b.clef,this.elements)+1;c<this.elements.length&&!(this.elements[c]instanceof Toe.Model.Clef);c++){var d=this.elements[c];(d instanceof Toe.Model.Neume&&b.neumes||d instanceof Toe.Model.Custos&&b.custos)&&a.push(d)}return a}return $.grep(this.elements,function(a){if(a instanceof Toe.Model.Neume&&b.neumes||a instanceof Toe.Model.Custos&&b.custos)return a})};
Toe.Model.Staff.prototype.calcPitchFromStaffPos=function(a,b){var c=a-b.props.staffPos,d=Toe.neumaticChroma.length,e=$.inArray(b.shape,Toe.neumaticChroma),f=(e+c)%d;0>f&&(f+=d);var g=Toe.neumaticChroma[f],n=$.inArray("c",Toe.neumaticChroma),d=$.truncateFloat(c/d);0<c&&f>=n&&f<e?d++:0>c&&(f<n||f>e)&&d--;c=4;"f"==b.shape&&(c=3);return{pname:g,oct:c+d}};
Toe.Model.Staff.prototype.calcStaffPosFromPitch=function(a,b,c){var d=4;"f"==c.shape&&(d=3);var e=Toe.neumaticChroma.length,f=$.inArray(c.shape,Toe.neumaticChroma);a=$.inArray(a,Toe.neumaticChroma);var g=$.inArray("c",Toe.neumaticChroma);b=a-f+e*(b-d);a<g&&(b+=e);return c.props.staffPos+b};Toe.Model.Staff.prototype.calcPitchFromCoords=function(a){var b=Math.round((this.zone.uly-a.y)/(this.delta_y/2));a=this.getActingClefByCoords(a);return this.calcPitchFromStaffPos(b,a)};
Toe.Model.Staff.prototype.updatePitchedElements=function(a){var b={clef:null,neumes:!0,custos:!1};$.extend(b,a);var c=this;if(b.clef){a=this.getPitchedElements({clef:b.clef});if(this.custos&&a[a.length-1]==this.custos&&!b.custos){var d=this.calcStaffPosFromPitch(this.custos.pname,this.custos.oct,b.clef);this.custos.setRootStaffPos(d);a.pop()}$.each(a,function(a,d){c.updateElePitchInfo(d,{clef:b.clef})})}else{var e=null;$.each(this.elements,function(a,d){if(d instanceof Toe.Model.Clef)e=d;else if(e&&
(d instanceof Toe.Model.Neume&&b.neumes||d==this.custos&&b.custos))c.updateElePitchInfo(d,{clef:e});else if(this.custos&&d==this.custos&&!b.custos){var n=this.calcStaffPosFromPitch(this.custos.pname,this.custos.oct,e);this.custos.setRootStaffPos(n)}})}};
Toe.Model.Staff.prototype.updateElePitchInfo=function(a,b){var c={clef:null};$.extend(c,b);c.clef||(c.clef=this.getActingClefByEle(a));var d=this;if(a instanceof Toe.Model.Neume)$.each(a.components,function(b,e){var n=d.calcPitchFromStaffPos(a.rootStaffPos+e.pitchDiff,c.clef);e.setPitchInfo(n.pname,n.oct)});else if(a instanceof Toe.Model.Custos){var e=this.calcPitchFromStaffPos(a.rootStaffPos,c.clef);a.setRootNote(e.pname,e.oct)}};Toe.Model.Staff.prototype.calcPitchDifference=function(a,b,c){};
Toe.Model.Staff.prototype.sortElements=function(){this.elements.sort(function(a,b){return a.zone.ulx-b.zone.ulx})};Toe.Model.Staff.prototype.insertElement=function(a){for(var b=this.elements.length,c=0;c<this.elements.length;c++)if(a.zone.ulx<=this.elements[c].zone.ulx){b=c;break}this.elements.splice(b,0,a);return b};
Toe.Model.Staff.prototype.removeElementByID=function(a){for(var b=this.elements.length-1;0<=b;b--)this.elements[b].id==a&&($(this.elements[b]).trigger("vEraseDrawing"),this.elements.splice(b,1))};Toe.Model.Staff.prototype.removeElementByRef=function(a){a=$.inArray(a,this.elements);0<=a&&($(this.elements[a]).trigger("vEraseDrawing"),this.elements.splice(a,1))};Toe.Model.Staff.prototype.getActingClefByEle=function(a){for(a=$.inArray(a,this.elements);0<=a;a--){var b=this.elements[a];if(b instanceof Toe.Model.Clef)return b}return null};
Toe.Model.Staff.prototype.getActingClefByCoords=function(a){for(var b=this.elements.length;0<=b;b--){var c=this.elements[b];if(c instanceof Toe.Model.Clef&&a.x>c.zone.lrx)return c}return null};Toe.Model.Staff.prototype.getPreviousClef=function(a){a=$.inArray(a,this.elements);if(0<a)for(a-=1;0<=a;a--)if(this.elements[a]instanceof Toe.Model.Clef)return this.elements[a];return null};
Toe.Model.Staff.prototype.addClef=function(a,b){if(!(a instanceof Toe.Model.Clef))throw Error("Staff: Invalid clef");var c={justPush:!1};$.extend(c,b);var d=null;c.justPush?(this.elements.push(a),d=this.elements.length-1):d=this.insertElement(a);a.setStaff(this);this.updatePitchedElements({clef:a,custos:!1});$(a).trigger("vRenderClef",[a]);return d};
Toe.Model.Staff.prototype.setCustos=function(a){if(!(a instanceof Toe.Model.Custos))throw Error("Staff: Invalid Custos");var b=this.getActingClefByCoords({x:a.zone.ulx});b&&(a.rootStaffPos=this.calcStaffPosFromPitch(a.pname,a.oct,b),0<this.elements.length&&this.elements[this.elements.length-1]instanceof Toe.Model.Custos?this.elements[this.elements.length-1]=a:this.elements.push(a),a.setStaff(this),this.custos=a,$(a).trigger("vRenderCustos",[a]));return this.elements.length-1};
Toe.Model.Staff.prototype.addNeume=function(a,b){if(!(a instanceof Toe.Model.Neume))throw Error("Staff: Invalid neume");var c={justPush:!1};$.extend(c,b);var d=this.getActingClefByCoords({x:a.zone.ulx});if(d){a.getRootPitchInfo();a.rootStaffPos=this.calcStaffPosFromPitch(a.components[0].pname,a.components[0].oct,d);a.components[0].setPitchDifference(0);for(var e=1;e<a.components.length;e++){var f=a.components[e];f.setPitchDifference(this.calcStaffPosFromPitch(f.pname,f.oct,d)-a.rootStaffPos)}d=null;
c.justPush?(this.elements.push(a),d=this.elements.length-1):d=this.insertElement(a);a.setStaff(this);$(a).trigger("vRenderNeume",[a]);return d}return null};Toe.Model.Staff.prototype.addDivision=function(a,b){if(!(a instanceof Toe.Model.Division))throw Error("Staff: invalid division");var c={justPush:!1};$.extend(c,b);var d=null;c.justPush?(this.elements.push(a),d=this.elements.length-1):d=this.insertElement(a);a.setStaff(this);$(a).trigger("vRenderDivision",[a]);return d};
Toe.Model.Staff.prototype.ohSnap=function(a,b,c){var d={ignoreEle:null,x:!0,y:!0};$.extend(d,c);if(d.y){c=this.zone.uly;var e=this.zone.uly+this.delta_y/2,f=(a.y-c)/this.delta_y,g=Math.abs(Math.round(Math.abs(f))-Math.abs(f)),n=(a.y-e)/this.delta_y,l=Math.abs(Math.round(Math.abs(n))-Math.abs(n));Math.min(g,l)==g?a.y=c+Math.round(f)*this.delta_y:a.y=e+Math.round(n)*this.delta_y}if(d.x){c=a.x-b/2;e=a.x+b/2;for(f=0;f<this.elements.length;f++)if(this.elements[f]!=d.ignoreEle&&(g=this.elements[f].zone.ulx,
n=this.elements[f].zone.lrx,!(c>=n))){a.x=c>=g&&c<n||e>=g&&e<n||g>c&&n<e?a.x<g+(n-g)/2?g-b/2:n+b/2:a.x;break}this.elements.length&&this.elements[0]instanceof Toe.Model.Clef&&c<=this.elements[0].zone.lrx?a.x=this.elements[0].zone.lrx+b/2+1:c<=this.zone.ulx&&(a.x=this.zone.ulx+b/2+1);this.custos&&d.ignoreEle!=this.custos&&e>=this.custos.zone.ulx?a.x=this.custos.zone.ulx-b/2-3:e>=this.zone.lrx&&(a.x=this.zone.lrx-b/2-3)}return a};Toe.Ctrl.StaffController=function(a,b){$(a).bind("vRenderStaff",function(a,d){b.renderStaff(d)})};Toe.Ctrl.StaffController.prototype.constructor=Toe.Ctrl.StaffController;Toe.View.StaffView=function(a){this.rendEng=a};Toe.View.StaffView.prototype.constructor=Toe.View.StaffView;Toe.View.StaffView.prototype.renderStaff=function(a){if(!this.rendEng)throw Error("Staff: Invalid render context");for(var b={fixed:[],modify:[]},c=0;c<a.props.numLines;c++){var d=a.zone.uly+c*a.delta_y;b.fixed.push(this.rendEng.createLine([a.zone.ulx,d,a.zone.lrx,d]))}this.rendEng.draw(b,{selectable:a.props.interact})};
