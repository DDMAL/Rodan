Toe={Model:{},Ctrl:{},View:{}};(function(a){a.arraysEqual=function(b,c){if(b.length!=c.length)return!1;var d=!0;a.each(b,function(a,b){if(b!=c[a])return d=!1});return d}})(jQuery);(function(a){a.truncateFloat=function(a){return 0<a?Math.floor(a):Math.ceil(a)}})(jQuery);Toe.validBoundingBox=function(a){return a[0]<=a[2]&&a[1]<=a[3]};Toe.neumaticChroma="abcdefg".split("");Toe.Model.Clef=function(a,b){this.shape=a.toLowerCase();this.name=Toe.Model.Clef.Type[this.shape];if(void 0==this.name)throw Error("Clef: unknown clef shape");var c=null;"c"==a?c=0:"f"==a&&(c=2);this.props={staffPos:c,interact:!0};$.extend(this.props,b);this.zone={};this.staff=null};Toe.Model.Clef.Type={c:"Doh Clef",f:"Fah Clef"};Toe.Model.Clef.prototype.constructor=Toe.Model.Clef;Toe.Model.Clef.prototype.setID=function(a){this.id=a};
Toe.Model.Clef.prototype.setStaff=function(a){if(!(a instanceof Toe.Model.Staff))throw Error("Clef: invalid staff reference");this.staff=a};Toe.Model.Clef.prototype.setShape=function(a){this.shape=a.toLowerCase();this.name=Toe.Model.Clef.Type[this.shape];if(void 0==this.name)throw Error("Clef: unknown clef shape");this.staff.updatePitchedElements({clef:this,custos:!1});$(this).trigger("vUpdateShape",[this])};
Toe.Model.Clef.prototype.setStaffPosition=function(a){this.props.staffPos!=a&&(this.props.staffPos=a,this.staff.updatePitchedElements({clef:this,custos:!1}),$(this).trigger("vUpdateStaffPosition",[this]))};Toe.Model.Clef.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Clef: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};Toe.Model.Clef.prototype.selectDrawing=function(){$(this).trigger("vSelectDrawing")};Toe.Ctrl.ClefController=function(a,b){$(a).bind("mUpdateBoundingBox",function(b,d){var e=d.left-d.currentWidth/2,g=d.top-d.currentHeight/2;a.setBoundingBox([e,g,e+d.currentWidth,g+d.currentHeight])});$(a).bind("vRenderClef",function(a,d){b.renderClef(d)});$(a).bind("vUpdateShape",function(a,d){b.updateShape(d)});$(a).bind("vUpdateStaffPosition",function(a,d){b.updateStaffPosition(d)});$(a).bind("vSelectDrawing",function(){b.selectDrawing()})};Toe.Ctrl.ClefController.prototype.constructor=Toe.Ctrl.ClefController;Toe.View.ClefView=function(a){this.rendEng=a;this.drawing=null};Toe.View.ClefView.prototype.constructor=Toe.View.ClefView;
Toe.View.ClefView.prototype.drawClef=function(a){if(!this.rendEng)throw Error("Clef: Invalid render context");var b=a.staff,c=null;switch(a.shape){case "c":c="c_clef";break;case "f":c="f_clef"}var c=this.rendEng.getGlyph(c),d=a.zone.ulx+c.centre[0],b=b.zone.uly-a.props.staffPos*b.delta_y/2;"f"==a.shape&&(b+=0.34*c.centre[1]);this.drawing=this.rendEng.draw({fixed:[],modify:[c.clone().set({left:d,top:b})]},{selectable:a.props.interact,eleRef:a})[0];$(a).trigger("mUpdateBoundingBox",this.drawing)};
Toe.View.ClefView.prototype.renderClef=function(a){this.drawClef(a)};Toe.View.ClefView.prototype.updateShape=function(a){if(this.drawing)this.rendEng.canvas.remove(this.drawing);else throw Error("Clef: update method called, but there exists no drawing to update.");this.drawClef(a);this.selectDrawing();this.rendEng.repaint()};
Toe.View.ClefView.prototype.updateStaffPosition=function(a){if(!this.drawing)throw Error("Clef: update method called, but there exists no drawing to update.");var b=a.staff.zone.uly-a.props.staffPos*a.staff.delta_y/2;"f"==a.shape&&(b+=0.34*this.drawing.currentHeight/2);this.drawing.top=b;this.rendEng.repaint();$(a).trigger("mUpdateBoundingBox",this.drawing)};Toe.View.ClefView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Model.Custos=function(a,b,c){this.props={interact:!1};$.extend(this.props,c);this.pname=a;this.oct=b;this.rootStaffPos=null;this.zone={};this.staff=this.id=null};Toe.Model.Custos.prototype.constructor=Toe.Model.Custos;Toe.Model.Custos.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Division: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};
Toe.Model.Custos.prototype.setID=function(a){this.id=a};Toe.Model.Custos.prototype.setStaff=function(a){if(!(a instanceof Toe.Model.Staff))throw Error("Custos: invalid staff reference");this.staff=a};Toe.Model.Custos.prototype.setRootNote=function(a,b){this.pname=a;this.oct=b};Toe.Model.Custos.prototype.setRootStaffPos=function(a){this.rootStaffPos!=a&&(this.rootStaffPos=a,$(this).trigger("vUpdateStaffPosition",[this]))};Toe.Model.Custos.prototype.selectDrawing=function(){$(this).trigger("vSelectDrawing")};
Toe.Model.Custos.prototype.eraseDrawing=function(){$(this).trigger("vEraseDrawing")};Toe.Ctrl.CustosController=function(a,b){$(a).bind("mUpdateBoundingBox",function(b,d){var e=d.left-d.currentWidth/2,g=d.top-d.currentHeight/2;a.setBoundingBox([e,g,e+d.currentWidth,g+d.currentHeight])});$(a).bind("vRenderCustos",function(a,d){b.renderCustos(d)});$(a).bind("vUpdateStaffPosition",function(a,d){b.updateStaffPosition(d)});$(a).bind("vEraseDrawing",function(){b.eraseDrawing()});$(a).bind("vSelectDrawing",function(){b.selectDrawing()})};Toe.Ctrl.CustosController.prototype.constructor=Toe.Ctrl.CustosController;Toe.View.CustosView=function(a){this.rendEng=a;this.ledgerLines=this.drawing=null};Toe.View.CustosView.prototype.constructor=Toe.View.CustosView;
Toe.View.CustosView.prototype.drawLedgerLines=function(a,b,c,d){var c=0.75*c,e=[],g=2*(1-d.props.numLines);if(0<a)for(g=0;g<=a;g+=2){var f=d.zone.uly-g*d.delta_y/2;e.push(this.rendEng.createLine([b-c,f,b+c,f]))}else if(a<g)for(;g>=a;g-=2)f=d.zone.uly-g*d.delta_y/2,e.push(this.rendEng.createLine([b-c,f,b+c,f]));this.ledgerLines=this.rendEng.draw({fixed:e,modify:[]},{group:!0,selectable:!1})[0]};
Toe.View.CustosView.prototype.renderCustos=function(a){if(!this.rendEng)throw Error("Custos: Invalid render context");var b=a.staff,c=this.rendEng.getGlyph("custos"),d=b.zone.uly-a.rootStaffPos*b.delta_y/2,e=a.zone.ulx+c.centre[0],d=c.clone().set({left:e,top:d-c.centre[1]/2});this.drawLedgerLines(a.rootStaffPos,e,4*c.centre[0],b);this.drawing=this.rendEng.draw({fixed:[],modify:[d]},{selectable:a.props.interact,eleRef:a})[0]};
Toe.View.CustosView.prototype.updateStaffPosition=function(a){if(!this.drawing)throw Error("Custos: update method called, but there exists no drawing to update.");this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);var b=a.staff;this.drawing.set({top:b.zone.uly-a.rootStaffPos*b.delta_y/2-this.drawing.currentHeight/4});this.drawLedgerLines(a.rootStaffPos,this.drawing.left,1.5*this.drawing.currentWidth,b);this.rendEng.repaint();$(a).trigger("mUpdateBoundingBox",this.drawing)};
Toe.View.CustosView.prototype.eraseDrawing=function(){this.drawing&&this.rendEng.canvas.remove(this.drawing);this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);this.rendEng.repaint()};Toe.View.CustosView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Model.Division=function(a,b){this.key=a.toLowerCase();this.type=Toe.Model.Division.Type[this.key];if(void 0==this.type)throw Error("Division: undefined division type");this.props={interact:!0};$.extend(this.props,b);this.zone={};this.staff=this.id=null};Toe.Model.Division.prototype.constructor=Toe.Model.Division;
Toe.Model.Division.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Division: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};Toe.Model.Division.prototype.setID=function(a){this.id=a};Toe.Model.Division.prototype.setStaff=function(a){if(!(a instanceof Toe.Model.Staff))throw Error("Division: invalid staff reference");this.staff=a};
Toe.Model.Division.Type={div_small:"Small Division",div_minor:"Minor Division",div_major:"Major Division",div_final:"Final Division"};Toe.Model.Division.prototype.selectDrawing=function(){$(this).trigger("vSelectDrawing")};Toe.Ctrl.DivisionController=function(a,b){$(a).bind("vRenderDivision",function(a,d){b.renderDivision(d)});$(a).bind("vSelectDrawing",function(){b.selectDrawing()})};Toe.Ctrl.DivisionController.prototype.constructor=Toe.Ctrl.DivisionController;Toe.View.DivisionView=function(a){this.rendEng=a};Toe.View.DivisionView.prototype.constructor=Toe.View.DivisionView;
Toe.View.DivisionView.prototype.renderDivision=function(a){if(!this.rendEng)throw Error("Division: Invalid render context");var b=a.staff,c={fixed:[],modify:[]},d=a.zone.ulx,e={strokeWidth:4};switch(a.type){case Toe.Model.Division.Type.div_small:var g=b.zone.uly-b.delta_y/2,b=b.zone.uly+b.delta_y/2;c.fixed.push(this.rendEng.createLine([d,g,d,b],e));break;case Toe.Model.Division.Type.div_minor:g=b.zone.uly+b.delta_y/2;b=g+2*b.delta_y;c.fixed.push(this.rendEng.createLine([d,g,d,b],e));break;case Toe.Model.Division.Type.div_major:g=
b.zone.uly;b=b.zone.lry;c.fixed.push(this.rendEng.createLine([d,g,d,b],e));break;case Toe.Model.Division.Type.div_final:g=b.zone.uly,b=b.zone.lry,c.fixed.push(this.rendEng.createLine([d,g,d,b],e)),d=a.zone.lrx,c.fixed.push(this.rendEng.createLine([d,g,d,b],e))}this.drawing=this.rendEng.draw(c,{group:!0,selectable:a.props.interact,eleRef:a})[0]};Toe.View.DivisionView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Model.Glyph=function(a,b){this.key=a;this.obj=b;this.centre=[this.obj.width/2,this.obj.height/2]};Toe.Model.Glyph.prototype.constructor=Toe.Glyph;Toe.Model.Glyph.prototype.clone=function(){return this.obj.clone()};Toe.View.GUI=function(a,b,c,d,e,g){var f={sldr_bgImgOpacity:!0,initBgImgOpacity:0.6,initMode:"edit"};$.extend(f,g);this.rendEng=c;this.page=d;this.csrf_token=e;this.prefix=a;this.fileName=b;this.clefDwg=this.divisionDwg=this.punctDwg=null;a=c.getGlyph("punctum").clone();this.punctWidth=a.width*c.getGlobalScale();this.punctHeight=a.height*c.getGlobalScale();this.objMoving=!1;gui=this;this.setupNavBar();this.setupSideBar("#gui-sidebar",f);$("#btn_"+f.initMode).trigger("click")};
Toe.View.GUI.prototype.constructor=Toe.View.GUI;Toe.View.GUI.prototype.setupNavBar=function(){};
Toe.View.GUI.prototype.setupSideBar=function(a,b){var c=this;b.sldr_bgImgOpacity&&($(a).prepend('<span id="sidebar-bg"><li class="nav-header">Background</li>\n<li>\n<label for="sldr_bgImgOpacity"><b>Image Opacity</b>:</label>\n<input id="sldr_bgImgOpacity" type="range" name="bgImgOpacity" min="0.0" max="1.0" step="0.05" value="'+b.initBgImgOpacity+'" />\n</li></span>'),$("#sldr_bgImgOpacity").bind("change",function(){c.rendEng.canvas.backgroundImageOpacity=$(this).val();c.rendEng.repaint()}));$("#btn_edit").bind("click.edit",
{gui:c,parentDivId:a},this.handleEdit);$("#btn_insert").bind("click.insert",{gui:c,parentDivId:a},this.handleInsert)};
Toe.View.GUI.prototype.handleEdit=function(a){var b=a.data.gui,a=a.data.parentDivId;$("#sidebar-insert").remove();b.rendEng.unObserve("mouse:move");b.rendEng.unObserve("mouse:up");b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.divisionDwg&&b.rendEng.canvas.remove(b.divisionDwg);b.clefDwg&&b.rendEng.canvas.remove(b.clefDwg);b.rendEng.repaint();0==$("#sidebar-edit").length&&$(a).append('<span id="sidebar-edit"><br/><li class="divider"></li><li class="nav-header">Edit</li>\n<li>\n<button id="btn_delete" class="btn"><i class="icon-remove"></i> Delete</button>\n</li>\n<li>\n<div class="btn-group">\n<button id="btn_neumify" class="btn"><i class="icon-magnet"></i> Neumify</button>\n<button class="btn dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>\n<ul class="dropdown-menu"><li><a id="btn_neumify_liquescence">liquescence</a></li></ul></li>\n<li><button id="btn_ungroup" class="btn"><i class="icon-share"></i> Ungroup</button></li>\n</div>\n</span>');b.rendEng.canvas.observe("mouse:down",
function(a){b.downCoords=b.rendEng.canvas.getPointer(a.memo.e)});b.rendEng.canvas.observe("object:moving",function(){b.objMoving=!0});b.rendEng.canvas.observe("object:selected",function(){var a=b.rendEng.canvas.getActiveObject().eleRef;a instanceof Toe.Model.Neume?($("#info > p").html("Selected: "+a.name+"<br/> Pitche(s): "+$.map(a.components,function(a){return a.pname.toUpperCase()+a.oct}).join(", ")),$("#info").animate({opacity:1},100),$("#menu_editclef").remove(),"punctum"==a.typeid||"cavum"==
a.typeid||"virga"==a.typeid?(0==$("#menu_editpunctum").length&&$("#sidebar-edit").append('<span id="menu_editpunctum"><br/><li class="nav-header">Ornamentation</li>\n<li><div class="btn-group" data-toggle="buttons-checkbox">\n<button id="edit_chk_dot" class="btn">&#149; Dot</button>\n<button id="edit_chk_horizepisema" class="btn"><i class="icon-resize-horizontal"></i> Episema</button>\n<button id="edit_chk_vertepisema" class="btn"><i class="icon-resize-vertical"></i> Episema</button>\n</div></li>\n<br/><li class="nav-header">Attributes</li>\n<li><div class="btn-group"><a class="btn dropdown-toggle" data-toggle="dropdown">\nHead shape <span class="caret"></span></a><ul class="dropdown-menu">\n<li><a id="head_punctum">punctum</a></li>\n<li><a id="head_punctum_inclinatum">punctum inclinatum</a></li>\n<li><a id="head_punctum_inclinatum_parvum">punctum inclinatum parvum</a></li>\n<li><a id="head_cavum">cavum</a></li>\n<li><a id="head_virga">virga</a></li>\n<li><a id="head_quilisma">quilisma</a></li>\n</ul></div></span>'),
a.components[0].hasOrnament("dot")?$("#edit_chk_dot").toggleClass("active",!0):$("#edit_chk_dot").toggleClass("active",!1),$("#edit_chk_dot").unbind("click"),$("#edit_chk_dot").bind("click.edit",{gui:b,punctum:a},b.handleDotToggle),$("#head_punctum").unbind("click"),$("#head_cavum").unbind("click"),$("#head_virga").unbind("click"),$("#head_quilisma").unbind("click"),$("#head_punctum_inclinatum").unbind("click"),$("#head_punctum_inclinatum_parvum").unbind("click"),$("#head_punctum").bind("click.edit",
{gui:b,punctum:a,shape:"punctum"},b.handleHeadShapeChange),$("#head_cavum").bind("click.edit",{gui:b,punctum:a,shape:"cavum"},b.handleHeadShapeChange),$("#head_virga").bind("click.edit",{gui:b,punctum:a,shape:"virga"},b.handleHeadShapeChange),$("#head_quilisma").bind("click.edit",{gui:b,punctum:a,shape:"quilisma"},b.handleHeadShapeChange),$("#head_punctum_inclinatum").bind("click.edit",{gui:b,punctum:a,shape:"punctum_inclinatum"},b.handleHeadShapeChange),$("#head_punctum_inclinatum_parvum").bind("click.edit",
{gui:b,punctum:a,shape:"punctum_inclinatum_parvum"},b.handleHeadShapeChange)):$("#menu_editpunctum").remove()):a instanceof Toe.Model.Clef?($("#info > p").text("Selected: "+a.name),$("#info").animate({opacity:1},100),0==$("#menu_editclef").length&&$("#sidebar-edit").append('<span id="menu_editclef"><br/><li class="nav-header">Clef</li>\n<li><div class="btn-group" data-toggle="buttons-radio">\n<button id="edit_rad_c" class="btn">Doh</button>\n<button id="edit_rad_f" class="btn">Fah</button>\n</div></li></span>'),
"c"==a.shape?$("#edit_rad_c").toggleClass("active",!0):$("#edit_rad_f").toggleClass("active",!0),$("#edit_rad_c").unbind("click"),$("#edit_rad_f").unbind("click"),$("#edit_rad_c").bind("click.edit",{gui:b,clef:a,shape:"c"},b.handleClefShapeChange),$("#edit_rad_f").bind("click.edit",{gui:b,clef:a,shape:"f"},b.handleClefShapeChange)):(a instanceof Toe.Model.Division?($("#info > p").text("Selected: "+a.type),$("#info").animate({opacity:1},100)):a instanceof Toe.Model.Custos&&($("#info > p").html("Selected: Custos <br/> Pitch: "+
a.pname.toUpperCase()+a.oct),$("#info").animate({opacity:1},100)),$("#menu_editpunctum").remove(),$("#menu_editclef").remove())});b.rendEng.canvas.observe("selection:cleared",function(){$("#info").animate({opacity:0},100);$("#menu_editpunctum").remove();$("#menu_editclef").remove()});b.rendEng.canvas.observe("mouse:up",function(a){var a=b.rendEng.canvas.getPointer(a.memo.e),d=b.downCoords.y-a.y;if(b.objMoving){var e=b.rendEng.canvas.getActiveObject();if(e){var g=[];e.eleRef?g.push(e):$.each(e.objects,
function(a,b){g.push(b)});$.each(g,function(a,c){var h=c.eleRef;if(h instanceof Toe.Model.Clef){var i=c.left,k=c.top;1<g.length&&(i=e.left+c.left,k=e.top+c.top);i=h.staff.ohSnap({x:i,y:k},null,{ignoreEle:h});i=-Math.round((i.y-h.staff.zone.uly)/(h.staff.delta_y/2));h.setStaffPosition(i);var j=h.staff.getPitchedElements({neumes:!0,custos:!1});0<j.length&&h.staff.getActingClefByEle(j[0])==h&&(i=b.page.getPreviousStaff(h.staff))&&b.handleUpdatePrevCustos(j[0].components[0].pname,j[0].components[0].oct,
i);var i=$.map(h.staff.getPitchedElements({clef:h}),function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,function(a,b){c.push({pname:b.pname,oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var d=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);console.log("POST: "+b.prefix+"/edit/"+b.fileName+"/move/custos");$.post(b.prefix+"/edit/"+b.fileName+"/move/custos",{id:a.id,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3],csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)})}}),k=h.staff.props.numLines+h.props.staffPos/2,j=b.getOutputBoundingBox([h.zone.ulx,h.zone.uly,h.zone.lrx,h.zone.lry]),l={id:h.id,line:k,ulx:j[0],uly:j[1],lrx:j[2],lry:j[3],pitchInfo:i};console.log("POST: "+b.prefix+"/edit/"+b.fileName+"/move/clef");$.post(b.prefix+"/edit/"+b.fileName+"/move/clef",{data:JSON.stringify(l),csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move clef. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)})}else if(h instanceof Toe.Model.Neume){i=c.left;k=c.top;1<g.length&&(i=e.left+c.left,k=e.top+c.top);var n={x:i,y:h.staff.zone.uly-h.rootStaffPos*h.staff.delta_y/2-d},o=b.page.getClosestStaff(n),p=o.ohSnap(n,c.currentWidth,{ignoreEle:h}),i=Math.round((o.zone.uly-p.y)/(o.delta_y/2)),j=p.x-c.currentWidth/2,k=k-c.currentHeight/2-(n.y-p.y),j=[j,k,j+c.currentWidth,k+c.currentHeight];h.setBoundingBox(j);n=h.rootStaffPos;$.each(h.components,function(a,b){var c=o.calcPitchFromCoords({x:p.x,
y:p.y-o.delta_y/2*b.pitchDiff});b.setPitchInfo(c.pname,c.oct)});$(h).trigger("vEraseDrawing");h.staff.removeElementByRef(h);k=o.addNeume(h);1==g.length&&$(h).trigger("vSelectDrawing");j=b.getOutputBoundingBox([h.zone.ulx,h.zone.uly,h.zone.lrx,h.zone.lry]);l={id:h.id,ulx:j[0],uly:j[1],lrx:j[2],lry:j[3]};n!=i?(l.pitchInfo=[],$.each(h.components,function(a,b){l.pitchInfo.push({pname:b.pname,oct:b.oct})}),h==o.elements[1]&&(i=b.page.getPreviousStaff(o))&&b.handleUpdatePrevCustos(h.components[0].pname,
h.components[0].oct,i)):l.pitchInfo=null;k+1<o.elements.length?l.beforeid=o.elements[k+1].id:(i=b.page.getNextStaff(o),l.beforeid=i.id);console.log("POST "+b.prefix+"/edit/"+b.fileName+"/move/neume");$.post(b.prefix+"/edit/"+b.fileName+"/move/neume",{data:JSON.stringify(l),csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move neume. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}else if(h instanceof Toe.Model.Division){i=
c.left;k=c.top;1<g.length&&(i+=e.left,k+=e.top);n={x:i,y:k};i=b.page.getClosestStaff(n);p=i.ohSnap(n,c.currentWidth,{x:!0,y:!1});switch(h.type){case Toe.Model.Division.Type.div_small:p.y=i.zone.uly;break;case Toe.Model.Division.Type.div_minor:p.y=i.zone.uly+(i.zone.lry-i.zone.uly)/2;break;case Toe.Model.Division.Type.div_major:p.y=i.zone.uly+(i.zone.lry-i.zone.uly)/2;break;case Toe.Model.Division.Type.div_final:p.y=i.zone.uly+(i.zone.lry-i.zone.uly)/2}h.staff.removeElementByRef(h);b.rendEng.canvas.remove(c);
b.rendEng.repaint();j=p.x-c.currentWidth/2;k=p.y-c.currentHeight/2;j=[j,k,j+c.currentWidth,k+c.currentHeight];h.setBoundingBox(j);j=i.addDivision(h);1==g.length&&h.selectDrawing();k=null;j+1<i.elements.length?k=i.elements[j+1].id:(i=b.page.getNextStaff(o),k=i.id);j=b.getOutputBoundingBox([h.zone.ulx,h.zone.uly,h.zone.lrx,h.zone.lry]);h={id:h.id,ulx:j[0],uly:j[1],lrx:j[2],lry:j[3],beforeid:k,csrfmiddlewaretoken:b.csrf_token};console.log("POST "+b.prefix+"/edit/"+b.fileName+"/move/division");$.post(b.prefix+
"/edit/"+b.fileName+"/move/division",h).error(function(){$("#alert > p").text("Server failed to move division. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}});1<g.length&&b.rendEng.canvas.discardActiveGroup();b.rendEng.repaint()}b.objMoving=!1}});$("#btn_delete").unbind("click");$("#btn_neumify").unbind("click");$("#btn_ungroup").unbind("click");$("#btn_delete").bind("click.edit",{gui:b},b.handleDelete);$("#btn_neumify").bind("click.edit",{gui:b},b.handleNeumify);
$("#btn_neumify_liquescence").bind("click.edit",{gui:b,modifier:"alt"},b.handleNeumify);$("#btn_ungroup").bind("click.edit",{gui:b},b.handleUngroup)};
Toe.View.GUI.prototype.handleDotToggle=function(a){var b=a.data.gui,c=a.data.punctum;if(a=c.components[0].hasOrnament("dot"))c.components[0].removeOrnament("dot");else{var d=new Toe.Model.Ornament("dot",{form:"aug"});c.components[0].addOrnament(d)}c.syncDrawing();d=b.getOutputBoundingBox([c.zone.ulx,c.zone.uly,c.zone.lrx,c.zone.lry]);c={id:c.id,dotform:"aug",ulx:d[0],uly:d[1],lrx:d[2],lry:d[3],csrfmiddlewaretoken:b.csrf_token};a?(console.log("POST "+b.prefix+"/edit/"+b.fileName+"/delete/dot"),$.post(b.prefix+
"/edit/"+b.fileName+"/delete/dot",c).error(function(){$("#alert > p").text("Server failed to remove dot from the punctum. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})):(console.log("POST "+b.prefix+"/edit/"+b.fileName+"/insert/dot"),$.post(b.prefix+"/edit/"+b.fileName+"/insert/dot",c).error(function(){$("#alert > p").text("Server failed to add a dot to the punctum. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)}));$(this).toggleClass("active")};
Toe.View.GUI.prototype.handleHeadShapeChange=function(a){var b=a.data.gui,c=a.data.shape,a=a.data.punctum;a.components[0].setHeadShape(c);"virga"==c?(a.name="Virga",a.typeid="virga"):"cavum"==c&&(a.name="Cavum",a.typeid="cavum");a.syncDrawing();var d=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]),c={id:a.id,shape:c,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3],csrfmiddlewaretoken:b.csrf_token};console.log("POST "+b.prefix+"/edit/"+b.fileName+"/update/neume/headshape");$.post(b.prefix+
"/edit/"+b.fileName+"/update/neume/headshape",c).error(function(){$("#alert > p").text("Server failed to change note head shape. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})};
Toe.View.GUI.prototype.handleClefShapeChange=function(a){var b=a.data.gui,c=a.data.clef,a=a.data.shape;if(c.shape!=a){c.setShape(a);var d=c.staff.getPitchedElements({neumes:!0,custos:!1});if(0<d.length&&c.staff.getActingClefByEle(d[0])==c){var e=b.page.getPreviousStaff(c.staff);e&&b.handleUpdatePrevCustos(d[0].components[0].pname,d[0].components[0].oct,e)}d=$.map(c.staff.getPitchedElements({clef:c}),function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,function(a,b){c.push({pname:b.pname,
oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var d=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);console.log("POST "+b.prefix+"/edit/"+b.fileName+"/move/custos");$.post(b.prefix+"/edit/"+b.fileName+"/move/custos",{id:a.id,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3],csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}});e=
b.getOutputBoundingBox([c.zone.ulx,c.zone.uly,c.zone.lrx,c.zone.lry]);c={id:c.id,shape:a,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3],pitchInfo:d,csrfmiddlewaretoken:b.csrf_token};console.log("POST "+b.prefix+"/edit/"+b.fileName+"/update/clef/shape");$.post(b.prefix+"/edit/"+b.fileName+"/update/clef/shape",{data:JSON.stringify(c),csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to update clef shape. Client and server are not synchronized.");$("#alert").animate({opacity:1},
100)});$(this).toggleClass("active")}};
Toe.View.GUI.prototype.handleDelete=function(a){var b=a.data.gui;toDelete={clefs:[],nids:[],dids:[]};var c=function(a){var c=a.eleRef,d=c.staff,e=d.getPreviousClef(c),i=d.getPitchedElements(c);d.removeElementByRef(c);d.updatePitchedElements(e);d=$.map(i,function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,function(a,b){c.push({pname:b.pname,oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var d=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,
a.zone.lry]);console.log("POST "+b.prefix+"/edit/"+b.fileName+"/move/custos");$.post(b.prefix+"/edit/"+b.fileName+"/move/custos",{id:a.id,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3],csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}});toDelete.clefs.push({id:c.id,pitchInfo:d});b.rendEng.canvas.remove(a);b.rendEng.canvas.discardActiveObject()},d=function(a){var a=a.eleRef,
c=a.staff.getPitchedElements({neumes:!0,custos:!1});a.staff.removeElementByRef(a);toDelete.nids.push(a.id);b.rendEng.canvas.discardActiveObject();if(1==c.length){var d=b.page.getPreviousStaff(a.staff);d&&d.custos&&(d.custos.eraseDrawing(),d.removeElementByRef(d.custos),console.log("POST "+b.prefix+"/edit/"+b.fileName+"/delete/custos"),$.post(b.prefix+"/edit/"+b.fileName+"/delete/custos",{id:d.custos.id,csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to delete custos. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)}),d.custos=null)}else if(a==c[0]&&(d=b.page.getPreviousStaff(a.staff))&&d.custos){var a=d.custos,e=c[1],c=e.components[0].pname,e=e.components[0].oct,i=d.getActingClefByEle(a),d=d.calcStaffPosFromPitch(c,e,i);a.pname=c;a.oct=e;a.setRootStaffPos(d);d=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);console.log("POST "+b.prefix+"/edit/"+b.fileName+"/move/custos");$.post(b.prefix+"/edit/"+b.fileName+"/move/custos",{id:a.id,pname:c,oct:e,ulx:d[0],
uly:d[1],lrx:d[2],lry:d[3],csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}},e=function(a){var c=a.eleRef;c.staff.removeElementByRef(c);toDelete.dids.push(c.id);b.rendEng.canvas.remove(a);b.rendEng.canvas.discardActiveObject()};if(a=b.rendEng.canvas.getActiveObject())a.eleRef instanceof Toe.Model.Clef&&a.eleRef.staff.elements[0]!=a.eleRef?c(a):a.eleRef instanceof
Toe.Model.Neume?d(a):a.eleRef instanceof Toe.Model.Division&&e(a),b.rendEng.repaint();else if(a=b.rendEng.canvas.getActiveGroup())$.each(a.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.Clef&&b.eleRef.staff.elements[0]!=b.eleRef?c(b):b.eleRef instanceof Toe.Model.Neume?d(b):b.eleRef instanceof Toe.Model.Division&&e(b)}),b.rendEng.canvas.discardActiveGroup(),b.rendEng.repaint();0<toDelete.clefs.length&&(console.log("POST "+b.prefix+"/edit/"+b.fileName+"/delete/clef"),$.post(b.prefix+"/edit/"+
b.fileName+"/delete/clef",{data:JSON.stringify(toDelete.clefs),csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to delete clef. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)}));0<toDelete.nids.length&&(console.log("POST "+b.prefix+"/edit/"+b.fileName+"/delete/neume"),$.post(b.prefix+"/edit/"+b.fileName+"/delete/neume",{ids:toDelete.nids.join(","),csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to delete neume. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)}));0<toDelete.dids.length&&(console.log("POST "+b.prefix+"/edit/"+b.fileName+"/delete/division"),$.post(b.prefix+"/edit/"+b.fileName+"/delete/division",{ids:toDelete.dids.join(","),csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to delete division. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)}))};
Toe.View.GUI.prototype.handleNeumify=function(a){var b=a.data.gui,a=a.data.modifier,c=b.rendEng.canvas.getActiveGroup();if(c){var d=[],e=null;$.each(c.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.Neume&&(e||(e=b.eleRef.staff),b.eleRef.staff==e&&d.push(b))});if(!(2>d.length)){d.sort(function(a,b){return a.eleRef.zone.ulx-b.eleRef.zone.ulx});var g=new Toe.Model.Neume({modifier:a});numPunct=0;var f=[],m=Number.MAX_VALUE,h=Number.MAX_VALUE,i=Number.MIN_VALUE;$.each(d,function(a,d){$.merge(g.components,
d.eleRef.components);numPunct+=d.eleRef.components.length;f.push(d.eleRef.id);var j=c.top+d.top;m=Math.min(m,c.left+d.left-d.currentHeight/2);h=Math.min(h,j-d.currentHeight/2);i=Math.max(i,j+d.currentHeight/2);e.removeElementByRef(d.eleRef);b.rendEng.canvas.remove(d)});g.setBoundingBox([m,h,m+numPunct*b.punctWidth,i]);a=new Toe.View.NeumeView(b.rendEng);new Toe.Ctrl.NeumeController(g,a);e.addNeume(g);var a=b.getOutputBoundingBox([g.zone.ulx,g.zone.uly,g.zone.lrx,g.zone.lry]),k=g.typeid,j=$.map(g.components,
function(a){return a.props.type}),a=JSON.stringify({nids:f.join(","),typeid:k,headShapes:j,ulx:a[0],uly:a[1],lrx:a[2],lry:a[3]});console.log("POST "+b.prefix+"/edit/"+b.fileName+"/neumify");$.post(b.prefix+"/edit/"+b.fileName+"/neumify",{data:a,csrfmiddlewaretoken:b.csrf_token},function(a){g.id=JSON.parse(a).id}).error(function(){$("#alert > p").text("Server failed to neumify selected neumes. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});b.rendEng.canvas.discardActiveGroup();
$(g).trigger("vSelectDrawing");b.rendEng.repaint()}}};
Toe.View.GUI.prototype.handleUngroup=function(a){var b=a.data.gui,c=[];(a=b.rendEng.canvas.getActiveObject())?a.eleRef instanceof Toe.Model.Neume&&1<a.eleRef.components.length&&c.push(a):(a=b.rendEng.canvas.getActiveGroup())&&$.each(a.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.Neume&&1<b.eleRef.components.length&&c.push(b)});var d=[],e=[],g=[];$.each(c,function(a,c){d.push(c.eleRef.id);var h=[],i=c.eleRef.zone.ulx;c.eleRef.staff.removeElementByRef(c.eleRef);b.rendEng.canvas.remove(c);
$.each(c.eleRef.components,function(a,d){var e=new Toe.Model.Neume;e.components.push(d);var f=c.eleRef.staff.zone.uly-(c.eleRef.rootStaffPos+d.pitchDiff)*c.eleRef.staff.delta_y/2-b.punctHeight/2;e.setBoundingBox([i+a*b.punctWidth,f,i+(a+1)*b.punctWidth,f+b.punctHeight]);f=new Toe.View.NeumeView(b.rendEng);new Toe.Ctrl.NeumeController(e,f);c.eleRef.staff.addNeume(e);f=b.getOutputBoundingBox([e.zone.ulx,e.zone.uly,e.zone.lrx,e.zone.lry]);h.push({ulx:f[0],uly:f[1],lrx:f[2],lry:f[3]});g.push(e)});e.push(h)});
a=JSON.stringify({nids:d.join(","),bbs:e});console.log("POST "+b.prefix+"/edit/"+b.fileName+"/ungroup");$.post(b.prefix+"/edit/"+b.fileName+"/ungroup",{data:a,csrfmiddlewaretoken:b.csrf_token},function(a){var b=JSON.parse(a).nids,b=$.map(b,function(a){return a});$.each(g,function(a,c){c.id=b[a]})}).error(function(){$("#alert > p").text("Server failed to ungroup selected neumes. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});b.rendEng.canvas.discardActiveObject();
b.rendEng.canvas.discardActiveGroup();b.rendEng.repaint()};
Toe.View.GUI.prototype.handleInsert=function(a){var b=a.data.gui,a=a.data.parentDivId;$("#sidebar-edit").remove();$("#btn_delete").unbind("click.edit");$("#btn_neumify").unbind("click.edit");b.rendEng.unObserve("mouse:down");b.rendEng.unObserve("mouse:up");b.rendEng.unObserve("object:moving");b.rendEng.unObserve("object:selected");b.rendEng.unObserve("selection:cleared");0==$("#sidebar-insert").length&&$(a).append('<span id="sidebar-insert"><br/><li class="divider"></li><li class="nav-header">Insert</li>\n<li><div class="btn-group" data-toggle="buttons-radio"><button id="rad_punctum" class="btn"><i class="icon-bookmark icon-black"></i> Punctum</button>\n<button id="rad_division" class="btn"><b>||</b> Division</button>\n<button id="rad_clef" class="btn">Clef</button>\n</div>\n</li>\n</span>');$("#rad_punctum").unbind("click");
$("#rad_division").unbind("click");$("#rad_clef").unbind("click");$("#rad_punctum").bind("click.insert",{gui:b},b.handleInsertPunctum);$("#rad_division").bind("click.insert",{gui:b},b.handleInsertDivision);$("#rad_clef").bind("click.insert",{gui:b},b.handleInsertClef);$("#rad_punctum").trigger("click")};
Toe.View.GUI.prototype.handleInsertPunctum=function(a){var b=a.data.gui;b.rendEng.unObserve("mouse:move");b.rendEng.unObserve("mouse:up");$("#menu_insertdivision").remove();$("#menu_insertclef").remove();b.divisionDwg&&b.rendEng.canvas.remove(b.divisionDwg);b.clefDwg&&b.rendEng.canvas.remove(b.clefDwg);0==$("#menu_insertpunctum").length&&$("#sidebar-insert").append('<span id="menu_insertpunctum"><br/><li class="nav-header">Ornamentation</li>\n<li><div class="btn-group" data-toggle="buttons-checkbox">\n<button id="chk_dot" class="btn">&#149; Dot</button>\n<button id="chk_horizepisema" class="btn"><i class="icon-resize-horizontal"></i> Episema</button>\n<button id="chk_vertepisema" class="btn"><i class="icon-resize-vertical"></i> Episema</button>\n</div></li></span>');
var c=!1,d=function(a){var d={modify:[],fixed:[]},f=null,m=b.rendEng.getGlyph("punctum");a?f={left:-50,top:-50}:(f={left:b.punctDwg.left,top:b.punctDwg.top},c&&(a=b.rendEng.getGlyph("dot").clone().set({left:f.left+b.punctWidth,top:f.top,opacity:0.6}),d.modify.push(a)));f=m.clone().set({left:f.left,top:f.top,opacity:0.6});d.modify.push(f);b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.punctDwg=b.rendEng.draw(d,{group:!0,selectable:!1,repaint:!0})[0]};d(!0);b.rendEng.canvas.observe("mouse:move",
function(a){a=b.rendEng.canvas.getPointer(a.memo.e);b.punctDwg.left=a.x-b.punctDwg.currentWidth/4;b.punctDwg.top=a.y-b.punctDwg.currentHeight/4;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(){var a={x:b.punctDwg.left,y:b.punctDwg.top},d=b.page.getClosestStaff(a),f=new Toe.Model.Neume,a=d.ohSnap(a,b.punctDwg.currentWidth),m=a.x-b.punctDwg.currentWidth/2,h=a.y-b.punctDwg.currentHeight/2;f.setBoundingBox([m,h,m+b.punctDwg.currentWidth,h+b.punctDwg.currentHeight]);var a=d.calcPitchFromCoords(a),
m=a.pname,h=a.oct,a={pname:m,oct:h,csrfmiddlewaretoken:b.csrf_token},i=[];c&&(i.push(new Toe.Model.Ornament("dot",{form:"aug"})),a.dotform="aug");f.addComponent("punctum",m,h,{ornaments:i});i=new Toe.View.NeumeView(b.rendEng);new Toe.Ctrl.NeumeController(f,i);i=d.addNeume(f);if(1==i){var k=b.page.getPreviousStaff(d);k&&b.handleUpdatePrevCustos(m,h,k)}m=b.getOutputBoundingBox([f.zone.ulx,f.zone.uly,f.zone.lrx,f.zone.lry]);a.ulx=m[0];a.uly=m[1];a.lrx=m[2];a.lry=m[3];if(i+1<d.elements.length)a.beforeid=
d.elements[i+1].id;else if(d=b.page.getNextStaff(d))a.beforeid=d.id;console.log("POST "+b.prefix+"/edit/"+b.fileName+"/insert/neume");$.post(b.prefix+"/edit/"+b.fileName+"/insert/neume",a,function(a){f.id=JSON.parse(a).id}).error(function(){$("#alert > p").text("Server failed to insert neume. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})});$("#chk_dot").bind("click.insert",function(){c=c?!1:!0;d(!1)})};
Toe.View.GUI.prototype.handleInsertDivision=function(a){var b=a.data.gui;b.rendEng.unObserve("mouse:move");b.rendEng.unObserve("mouse:up");b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.clefDwg&&b.rendEng.canvas.remove(b.clefDwg);$("#menu_insertpunctum").remove();$("#menu_insertclef").remove();0==$("#menu_insertdivision").length&&$("#sidebar-insert").append('<span id="menu_insertdivision"><br/>\n<li class="nav-header">Division Type</li>\n<li><div class="btn-group" data-toggle="buttons-radio">\n<button id="rad_small" class="btn">Small</button>\n<button id="rad_minor" class="btn">Minor</button>\n<button id="rad_major" class="btn">Major</button>\n<button id="rad_final" class="btn">Final</button>\n</div>\n</li>\n</span>');
var c=null,d=null;b.rendEng.canvas.observe("mouse:move",function(a){a=b.rendEng.canvas.getPointer(a.memo.e);d=b.page.getClosestStaff(a);var g={strokeWidth:4,opacity:0.6};switch(c){case "div_small":a.y=d.zone.uly;if(!b.divisionDwg){var f=d.zone.uly-d.delta_y/2,m=d.zone.uly+d.delta_y/2,h=a.x;b.divisionDwg=b.rendEng.createLine([h,f,h,m],g);b.rendEng.draw({fixed:[b.divisionDwg],modify:[]},{selectable:!1,opacity:0.6})}break;case "div_minor":a.y=d.zone.uly+(d.zone.lry-d.zone.uly)/2;b.divisionDwg||(f=d.zone.uly+
d.delta_y/2,m=f+2*d.delta_y,h=a.x,b.divisionDwg=b.rendEng.createLine([h,f,h,m],g),b.rendEng.draw({fixed:[b.divisionDwg],modify:[]},{selectable:!1,opacity:0.6}));break;case "div_major":a.y=d.zone.uly+(d.zone.lry-d.zone.uly)/2;b.divisionDwg||(f=d.zone.uly,m=d.zone.lry,h=a.x,b.divisionDwg=b.rendEng.createLine([h,f,h,m],g),b.rendEng.draw({fixed:[b.divisionDwg],modify:[]},{selectable:!1,opacity:0.6}));break;case "div_final":if(a.y=d.zone.uly+(d.zone.lry-d.zone.uly)/2,!b.divisionDwg){var f=d.zone.uly,m=
d.zone.lry,h=a.x,i=a.x+b.punctWidth,h=b.rendEng.createLine([h,f,h,m],g),g=b.rendEng.createLine([i,f,i,m],g);b.divisionDwg=b.rendEng.draw({fixed:[h,g],modify:[]},{group:!0,selectable:!1,opacity:0.6})[0]}}g=a.x-b.divisionDwg.currentWidth/2;f=a.x+b.divisionDwg.currentWidth/2;d.elements[0]instanceof Toe.Model.Clef&&g<=d.elements[0].zone.lrx?a.x=d.elements[0].zone.lrx+b.divisionDwg.currentWidth/2+1:g<=d.zone.ulx&&(a.x=d.zone.ulx+b.divisionDwg.currentWidth/2+1);d.custos&&f>=d.custos.zone.ulx?a.x=d.custos.zone.ulx-
b.divisionDwg.currentWidth/2-3:f>=d.zone.lrx&&(a.x=d.zone.lrx-b.divisionDwg.currentWidth/2-3);b.divisionDwg.left=a.x;b.divisionDwg.top=a.y;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(){var a=d.ohSnap({x:b.divisionDwg.left,y:b.divisionDwg.top},b.divisionDwg.currentWidth),g=new Toe.Model.Division(c),f=a.x-b.divisionDwg.currentWidth/2,a=a.y-b.divisionDwg.currentHeight/2,a=[f,a,f+b.divisionDwg.currentWidth,a+b.divisionDwg.currentHeight];g.setBoundingBox(a);f=new Toe.View.DivisionView(b.rendEng);
new Toe.Ctrl.DivisionController(g,f);f=d.addDivision(g);a=b.getOutputBoundingBox(a);a={type:g.key.slice(4),ulx:a[0],uly:a[1],lrx:a[2],lry:a[3],csrfmiddlewaretoken:b.csrf_token};f+1<d.elements.length?a.beforeid=d.elements[f+1].id:(f=b.page.getNextStaff(d),a.beforeid=f.id);console.log("POST "+b.prefix+"/edit/"+b.fileName+"/insert/division");$.post(b.prefix+"/edit/"+b.fileName+"/insert/division",a,function(a){g.id=JSON.parse(a).id}).error(function(){$("#alert > p").text("Server failed to insert division. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)})});$("#rad_small").bind("click.insert",function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);c="div_small"});$("#rad_minor").bind("click.insert",function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);c="div_minor"});$("#rad_major").bind("click.insert",function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);c="div_major"});$("#rad_final").bind("click.insert",function(){b.divisionDwg&&
(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);c="div_final"});$("#rad_small").trigger("click")};
Toe.View.GUI.prototype.handleInsertClef=function(a){var b=a.data.gui;b.rendEng.unObserve("mouse:move");b.rendEng.unObserve("mouse:up");b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.divisionDwg&&b.rendEng.canvas.remove(b.divisionDwg);$("#menu_insertpunctum").remove();$("#menu_insertdivision").remove();0==$("#menu_insertclef").length&&$("#sidebar-insert").append('<span id="menu_insertclef"><br/>\n<li class="nav-header">Clef Type</li>\n<li><div class="btn-group" data-toggle="buttons-radio">\n<button id="rad_doh" class="btn">Doh</button>\n<button id="rad_fah" class="btn">Fah</button>\n</div>\n</li>\n</span>');var c=
null;b.rendEng.canvas.observe("mouse:move",function(a){var a=b.rendEng.canvas.getPointer(a.memo.e),e=0,g=0;"c"==c?e=b.clefDwg.currentWidth/4:(e=b.clefDwg.currentWidth/8,g=b.clefDwg.currentHeight/8);b.clefDwg.left=a.x-e;b.clefDwg.top=a.y+g;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(){var a={x:b.clefDwg.left,y:b.clefDwg.top};"f"==c&&(a.x-=b.clefDwg.currentWidth/8,a.y-=b.clefDwg.currentHeight/8);var e=b.page.getClosestStaff(a),g=e.ohSnap(a,b.clefDwg.currentWidth),a=Math.round((e.zone.uly-
g.y)/(e.delta_y/2)),f=new Toe.Model.Clef(c,{staffPos:a}),m=g.x-b.clefDwg.currentWidth/2,g=g.y-b.clefDwg.currentHeight/2;f.setBoundingBox([m,g,m+b.clefDwg.currentWidth,g+b.clefDwg.currentHeight]);m=new Toe.View.ClefView(b.rendEng);new Toe.Ctrl.ClefController(f,m);m=e.addClef(f);a=e.props.numLines+a/2;g=b.getOutputBoundingBox([f.zone.ulx,f.zone.uly,f.zone.lrx,f.zone.lry]);a={shape:c,line:a,ulx:g[0],uly:g[1],lrx:g[2],lry:g[3]};m+1<e.elements.length?a.beforeid=e.elements[m+1].id:(m=b.page.getNextStaff(e),
a.beforeid=m.id);m=e.getPitchedElements({neumes:!0,custos:!1});0<m.length&&e.getActingClefByEle(m[0])==f&&(g=b.page.getPreviousStaff(e))&&b.handleUpdatePrevCustos(m[0].components[0].pname,m[0].components[0].oct,g);a.pitchInfo=$.map(e.getPitchedElements({clef:f}),function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,function(a,b){c.push({pname:b.pname,oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var d=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,
a.zone.lry]);console.log("POST "+b.prefix+"/edit/"+b.fileName+"/move/custos");$.post(b.prefix+"/edit/"+b.fileName+"/move/custos",{id:a.id,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3],csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}});console.log("POST "+b.prefix+"/edit/"+b.fileName+"/insert/clef");$.post(b.prefix+"/edit/"+b.fileName+"/insert/clef",{data:JSON.stringify(a),
csrfmiddlewaretoken:b.csrf_token},function(a){f.id=JSON.parse(a).id}).error(function(){$("#alert > p").text("Server failed to insert clef. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})});$("#rad_doh").unbind("click");$("#rad_fah").unbind("click");$("#rad_doh").bind("click.insert",function(){if(!$(this).hasClass("active")){var a={left:-50,top:-50};b.clefDwg&&(b.rendEng.canvas.remove(b.clefDwg),a={left:b.clefDwg.left,top:b.clefDwg.top});a=b.rendEng.getGlyph("c_clef").clone().set($.extend(a,
{opacity:0.6}));b.clefDwg=b.rendEng.draw({fixed:[],modify:[a]},{opacity:0.6,selectable:!1,repaint:!0})[0];c="c"}});$("#rad_fah").bind("click.insert",function(){if(!$(this).hasClass("active")){var a={left:-50,top:-50};b.clefDwg&&(b.rendEng.canvas.remove(b.clefDwg),a={left:b.clefDwg.left,top:b.clefDwg.top});a=b.rendEng.getGlyph("f_clef").clone().set($.extend(a,{opacity:0.6}));b.clefDwg=b.rendEng.draw({fixed:[],modify:[a]},{opacity:0.6,selectable:!1,repaint:!0})[0];c="f"}});$("#rad_doh").trigger("click")};
Toe.View.GUI.prototype.handleUpdatePrevCustos=function(a,b,c){var d=c.custos;if(d){d.setRootNote(a,b);var e=c.getActingClefByEle(d);d.setRootStaffPos(c.calcStaffPosFromPitch(a,b,e));e=this.getOutputBoundingBox([d.zone.ulx,d.zone.uly,d.zone.lrx,d.zone.lry]);console.log("POST"+this.prefix+"/edit/"+this.fileName+"/move/custos");$.post(this.prefix+"/edit/"+this.fileName+"/move/custos",{id:d.id,pname:a,oct:b,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3],csrfmiddlewaretoken:gui.csrf_token}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)})}else{var g=new Toe.Model.Custos(a,b),d=c.zone.lrx-gui.punctWidth/2,e=c.zone.uly;g.setBoundingBox([d,e,d+gui.punctWidth,e+gui.punctHeight]);d=new Toe.View.CustosView(gui.rendEng);new Toe.Ctrl.CustosController(g,d);c.setCustos(g);e=this.getOutputBoundingBox([g.zone.ulx,g.zone.uly,g.zone.lrx,g.zone.lry]);a={id:g.id,pname:a,oct:b,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3],csrfmiddlewaretoken:gui.csrf_token};if(c=gui.page.getNextStaff(c))a.beforeid=c.id;console.log("POST "+
this.prefix+"/edit/"+this.fileName+"/insert/custos");$.post(this.prefix+"/edit/"+this.fileName+"/insert/custos",a,function(a){g.id=JSON.parse(a).id}).error(function(){$("#alert > p").text("Server failed to insert custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}};Toe.View.GUI.prototype.getOutputBoundingBox=function(a){gui=this;return $.map(a,function(a){return Math.round(a/gui.page.scale)})};Toe.Model.NeumeComponent=function(a,b,c){this.props={type:"punctum",ornaments:[],interact:!0};$.extend(this.props,c);this.setHeadShape(this.props.type);this.setPitchInfo(a,b);this.pitchDiff=null};Toe.Model.NeumeComponent.prototype.constructor=Toe.Model.NeumeComponent;Toe.Model.NeumeComponent.Type={punctum:"Punctum",virga:"Virga",cavum:"Cavum",punctum_inclinatum:"Punctum Inclinatum",punctum_inclinatum_parvum:"Punctum Inclinatum Parva",quilisma:"Quilisma"};
Toe.Model.NeumeComponent.prototype.setHeadShape=function(a){this.props.type=a.toLowerCase();this.props.name=Toe.Model.NeumeComponent.Type[this.props.type];if(void 0==this.props.name)throw Error("NeumeComponent: undefined head shape");};Toe.Model.NeumeComponent.prototype.setPitchDifference=function(a){this.pitchDiff=a};Toe.Model.NeumeComponent.prototype.setPitchInfo=function(a,b){this.pname=a;this.oct=b};
Toe.Model.NeumeComponent.prototype.hasOrnament=function(a){return $.grep(this.props.ornaments,function(b){return b.key==a.toLowerCase()}).length};Toe.Model.NeumeComponent.prototype.addOrnament=function(a){if(!(a instanceof Toe.Model.Ornament))throw Error("NeumeComponent: Invalid ornament");this.hasOrnament(a.key)||this.props.ornaments.push(a)};Toe.Model.NeumeComponent.prototype.removeOrnament=function(a){this.props.ornaments=$.grep(this.props.ornaments,function(b){return b.key==a.toLowerCase()},!0)};(function(a){var b=function(b,d){var e=a(b),g,f,m,h,i,k=a.extend({},{autoLoad:!0,debug:!1,prefix:"neon",pageid:null,meipath:null,bgimgpath:null,glyphpath:null,width:1E3,height:1024,backgroundImageOpacity:0},d);a.extend(k,{canvasid:"neon-canvas"});var j=function(b){function c(d){var e=parseInt(a(d).attr("ulx")),f=parseInt(a(d).attr("uly")),g=parseInt(a(d).attr("lrx")),d=parseInt(a(d).attr("lry"));return a.map([e,f,g,d],function(a){return Math.round(b.scale*a)})}var d=a("clef, sb",g),e=[];a(d).each(function(b,
c){a(c).is("sb")&&e.push(b)});var f=a("neume, sb",g),i=[];a(f).each(function(b,c){a(c).is("sb")&&i.push(b)});var j=a("division, sb",g),m=[];a(j).each(function(b,c){a(c).is("sb")&&m.push(b)});var l=a("custos, sb",g),o=[];a(l).each(function(b,c){a(c).is("sb")&&o.push(b)});a("sb",g).each(function(n,p){k.debug&&console.log("system "+(n+1));var q=a(p).attr("systemref"),q=a(a(g).find("system[xml\\:id="+q+"]")[0]).attr("facs"),q=a(g).find("zone[xml\\:id="+q+"]")[0],q=c(q);k.debug&&h.outlineBoundingBox(q,
{fill:"blue"});var r=new Toe.Model.Staff(q);r.setID(a(p).attr("xml:id"));0==n&&h.calcScaleFromStaff(r,{overwrite:!0});q=new Toe.View.StaffView(h);new Toe.Ctrl.StaffController(r,q);b.addStaff(r);a(d).slice(e[n]+1,e[n+1]).each(function(b,d){var e=a(d).attr("shape"),f=parseInt(a(d).attr("line")),f=2*-(r.props.numLines-f),i=a(d).attr("facs"),i=a(g).find("zone[xml\\:id="+i+"]")[0],i=c(i);k.debug&&h.outlineBoundingBox(i,{fill:"red"});e=new Toe.Model.Clef(e,{staffPos:f});e.setID(a(d).attr("xml:id"));e.setBoundingBox(i);
f=new Toe.View.ClefView(h);new Toe.Ctrl.ClefController(e,f);r.addClef(e);k.debug&&console.log("clef: "+e.name)});a(f).slice(i[n]+1,i[n+1]).each(function(b,d){var e=new Toe.Model.Neume,f=a(g).find("zone[xml\\:id="+a(d).attr("facs")+"]")[0],f=c(f);k.debug&&h.outlineBoundingBox(f,{fill:"green"});e.neumeFromMei(d,f,r);f=new Toe.View.NeumeView(h);new Toe.Ctrl.NeumeController(e,f);r.addNeume(e);k.debug&&console.log("neume: "+e.name)});a(j).slice(m[n]+1,m[n+1]).each(function(b,d){var e=a(g).find("zone[xml\\:id="+
a(d).attr("facs")+"]")[0],f=c(e);k.debug&&h.outlineBoundingBox(f,{fill:"yellow"});var e="div_"+a(d).attr("form"),i=new Toe.Model.Division(e);i.setBoundingBox(f);i.setID(a(d).attr("xml:id"));f=new Toe.View.DivisionView(h);new Toe.Ctrl.DivisionController(i,f);r.addDivision(i);k.debug&&console.log("division: "+e)});a(l).slice(o[n]+1,o[n+1]).each(function(b,d){var e=a(g).find("zone[xml\\:id="+a(d).attr("facs")+"]")[0],e=c(e);k.debug&&h.outlineBoundingBox(e,{fill:"purple"});var f=a(d).attr("pname"),i=
parseInt(a(d).attr("oct")),f=new Toe.Model.Custos(f,i);f.setBoundingBox(e);f.setID(a(d).attr("xml:id"));e=new Toe.View.CustosView(h);new Toe.Ctrl.CustosController(f,e);r.setCustos(f);k.debug&&console.log("custos")})});h.repaint()},l=function(b){console.log("loading SVG glyphs ...");return a.get(k.glyphpath,function(c){var d={};a(c).find("svg").each(function(b,c){var e=a("<lol>").append(a(c).clone()).remove().html();fabric.loadSVGFromString(e,function(b){gID=a(c).find("path").attr("id");d[gID]=new Toe.Model.Glyph(gID,
b[0])})});b.setGlyphs(d)})},n=function(){console.log("loading background image ...");var b=a.Deferred();k.autoLoad&&k.bgimgpath?fabric.Image.fromURL(k.bgimgpath,function(a){f=a.width;m=a.height;b.resolve()}):b.resolve();return b.promise()},o=function(){var b=a.Deferred();k.autoLoad&&k.meipath?a.get(k.meipath,function(a){console.log("loading MEI file ...");g=a;b.resolve()}):b.resolve();return b.promise()},p=function(){var b=new Toe.Model.Page,c=a("<canvas>").attr("id",k.canvasid),d=[k.width,k.height];
k.autoLoad&&(d=k.backgroundImage?[f,m]:b.calcDimensions(a(g).find("zone")),b.setPageScale(k.width/d[0]));b.setDimensions(Math.round(d[0]),Math.round(d[1]));c.attr("width",b.width);c.attr("height",b.height);c.attr("style","border: 4px black solid;");e.prepend(c);c={renderOnAddition:!1};k.bgimgpath&&a.extend(c,{backgroundImage:k.bgimgpath,backgroundImageOpacity:k.backgroundImageOpacity,backgroundImageStretch:!1});h.setCanvas(new fabric.Canvas(k.canvasid,c));if(k.debug){var l=a("<div>").attr("id","fps");
l.attr("style","color: red; font-size: 200%");e.prepend(l);h.canvas.onFpsUpdate=function(b){a(l).html("FPS: "+b)}}c=new Toe.View.PageView(h);new Toe.Ctrl.PageController(b,c);k.autoLoad&&g&&j(b);new Toe.View.GUI(k.prefix,k.pageid,h,b,k.csrf_token,{sldr_bgImgOpacity:k.backgroundImage,initBgImgOpacity:k.backgroundImageOpacity});console.log("Neon.js ready ("+(new Date-i)+"ms)")};(function(){i=new Date;h=new Toe.View.RenderEngine;a.when(l(h),o(),n()).then(p,function(){console.log("Failure to load the mei file, glyphs, or background image")})})()};
a.fn.neon=function(c){return this.each(function(){var d=a(this);if(!d.data("neon")){var e=new b(this,c);d.data("neon",e)}})}})(jQuery);function SearchTree(){this.rootNode=null;this.numNodes=0}function SearchTreeNode(a){this.payload=a;this.children={};this.numChildren=0}
SearchTree.prototype={setRootNode:function(a){this.rootNode=a},insert:function(a,b){if(!this.rootNode)if(a.length)this.setRootNode(new SearchTreeNode(null)),this.numNodes++;else{this.setRootNode(new SearchTreeNode(b));this.numNodes++;return}this.rootNode.insert(a,b)},remove:function(a){this.rootNode.remove(a)},destroyTree:function(){this.rootNode=null;this.numNodes=0},search:function(a,b){for(var c=this.rootNode,d=0;d<a.length;d++){var e=a[d];if(e in c.children)c=c.children[e];else return b?{result:c.payload,
prefix:!0}:null}return{result:c.payload,prefix:!1}},stringify:function(){return JSON.stringify(this)},populateFromJSON:function(a){a=JSON.parse(a);this.rootNode=a.rootNode;this.numNodes=a.numNodes}};
SearchTreeNode.prototype={insert:function(a,b){var c=a.splice(0,1);a.length?(c in this.children||(this.children[c]=new SearchTreeNode(null),this.numChildren++),this.children[c].insert(a,b)):c in this.children?this.children[c].payload=b:(this.children[c]=new SearchTreeNode(b),this.numChildren++)},remove:function(a){var b=a.splice(0,1);a.length?b in this.children&&this.children[b].remove(a):b in this.children&&(this.children[b].numChildren?this.children[b].payload=null:(delete this.children[b],this.numChildren--))}};Toe.Model.Neume=function(a){this.zone={};this.props={modifier:null,interact:!0};$.extend(this.props,a);this.props.modifier=Toe.Model.Neume.Modifier[this.props.modifier];void 0==this.props.modifier&&(this.props.modifier=null);this.staff=this.id=this.rootStaffPos=this.neumePrefix=this.typeid=this.name=null;this.components=[]};Toe.Model.Neume.prototype.constructor=Toe.Model.Neume;Toe.Model.Neume.Modifier={alt:"liquescence",shift:"variant 2",ctrl:"variant 3",ctrl_shift:"variant 4"};
Toe.Model.Neume.SearchTree=new SearchTree;Toe.Model.Neume.SearchTree.populateFromJSON('{"rootNode":{"payload":{"typeid":"punctum","name":"Punctum"},"children":{"0":{"payload":{"typeid":"distropha","name":"Distropha"},"children":{"0":{"payload":{"typeid":"tristropha","name":"Tristropha"},"children":{},"numChildren":0}},"numChildren":1},"1":{"payload":{"typeid":"podatus","name":"Podatus"},"children":{"1":{"payload":{"typeid":"scandicus.1","name":"Scandicus"},"children":{"1":{"payload":{"typeid":"scandicus.2","name":"Scandicus"},"children":{"1":{"payload":{"typeid":"scandicus.3","name":"Scandicus"},"children":{"1":{"payload":{"typeid":"scandicus.4","name":"Scandicus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"scandicus.flexus.3","name":"Scandicus Flexus"},"children":{},"numChildren":0}},"numChildren":2},"-1":{"payload":{"typeid":"scandicus.flexus.2","name":"Scandicus Flexus"},"children":{},"numChildren":0}},"numChildren":2},"-1":{"payload":{"typeid":"scandicus.flexus.1","name":"Scandicus Flexus"},"children":{"-1":{"payload":{"typeid":"scandicus.subpunctis.1","name":"Scandicus Subpunctis"},"children":{"-1":{"payload":{"typeid":"scandicus.subpunctis.2","name":"Scandicus Subpunctis"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":1}},"numChildren":2},"-1":{"payload":{"typeid":"torculus","name":"Torculus"},"children":{"1":{"payload":{"typeid":"torculus.resupinus.1","name":"Torculus Resupinus"},"children":{"-1":{"payload":{"typeid":"torculus.resupinus.2","name":"Torculus Resupinus"},"children":{"-1":{"payload":{"typeid":"torculus.resupinus.3","name":"Torculus Resupinus"},"children":{"-1":{"payload":{"typeid":"torculus.resupinus.4","name":"Torculus Resupinus"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":1}},"numChildren":1},"-1":{"payload":{"typeid":"podatus.subpunctis.1","name":"Podatus Subpunctis"},"children":{"1":{"payload":{"typeid":"podatus.subpunctis.resupinus.1","name":"Podatus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"podatus.subpunctis.2","name":"Podatus Subpunctis"},"children":{"1":{"payload":{"typeid":"podatus.subpunctis.resupinus.2","name":"Podatus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"podatus.subpunctis.3","name":"Podatus Subpunctis"},"children":{"1":{"payload":{"typeid":"podatus.resupinus.3","name":"Podatus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"podatus.subpunctis.4","name":"Podatus Subpunctis"},"children":{},"numChildren":0}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":2},"-1":{"payload":{"typeid":"clivis","name":"Clivis"},"children":{"1":{"payload":{"typeid":"porrectus","name":"Porrectus"},"children":{"1":{"payload":{"typeid":"compound.2","name":"Compound Neume 2"},"children":{"-1":{"payload":{"typeid":"compound.1","name":"Compound"},"children":{},"numChildren":0}},"numChildren":1},"-1":{"payload":{"typeid":"porrectus.flexus","name":"Porrectus Flexus"},"children":{"-1":{"payload":{"typeid":"porrectus.subpunctis.1","name":"Porrectus Subpunctis"},"children":{"1":{"payload":{"typeid":"porrectus.subpunctis.resupinus.1","name":"Porrectus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"porrectus.subpunctis.2","name":"Porrectus Subpunctis"},"children":{"1":{"payload":{"typeid":"porrectus.subpunctis.resupinus.2","name":"Porrectus Subpunctis Resupinus"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":2}},"numChildren":1}},"numChildren":2},"-1":{"payload":{"typeid":"climacus.1","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.1","name":"Climacus Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"climacus.2","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.2","name":"Climacus Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"climacus.3","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.3","name":"Climacus Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"climacus.4","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.4","name":"Climacus Resupinus"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":3},"numNodes":1}');
Toe.Model.Neume.prototype.setID=function(a){this.id=a};Toe.Model.Neume.prototype.setStaff=function(a){if(!(a instanceof Toe.Model.Staff))throw Error("Neume: invalid staff reference");this.staff=a};Toe.Model.Neume.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Neume: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};
Toe.Model.Neume.prototype.getRootPitchInfo=function(){var a=null,b=null;0<this.components.length&&(a=this.components[0].pname,b=this.components[0].oct);return{pname:a,oct:b}};Toe.Model.Neume.prototype.setRootStaffPos=function(a){this.rootStaffPos=a};
Toe.Model.Neume.prototype.neumeFromMei=function(a,b){if("neume"!=a.nodeName.toLowerCase())throw Error("neumeFromMei: invalid neume data");this.id=$(a).attr("xml:id");var c=$(a).attr("name").toLowerCase();"epiphonus"==c?(c="podatus",this.props.modifier=Toe.Model.Neume.Modifier.alt):"cephalicus"==c&&(c="clivis",this.props.modifier=Toe.Model.Neume.Modifier.alt);this.setBoundingBox(b);var d=this;$(a).find("note").each(function(a,b){var f=$(b).attr("pname"),m=parseInt($(b).attr("oct")),h="punctum";$(this).parent().attr("inclinatum")==
"true"?h=$(this).parent().attr("deminutus")=="true"?"punctum_inclinatum_parvum":"punctum_inclinatum":$(this).parent().attr("quilisma")=="true"?h="quilisma":c=="virga"?h="virga":c=="cavum"&&(h="cavum");var i=[],k=$("> dot",this).attr("form");k&&i.push(new Toe.Model.Ornament("dot",{form:k}));d.addComponent(h,f,m,{ornaments:i})});return this};
Toe.Model.Neume.prototype.addComponent=function(a,b,c,d){opts={ncInd:this.components.length,ornaments:[]};$.extend(opts,d);a=new Toe.Model.NeumeComponent(b,c,{type:a,ornaments:opts.ornaments});this.components.splice(opts.ncInd,0,a)};Toe.Model.Neume.prototype.getDifferences=function(){for(var a=[],b=1;b<this.components.length;b++)a.push(this.components[b].pitchDiff);return a};
Toe.Model.Neume.prototype.diffToMelodicMove=function(){var a=this.getDifferences(),b=0;return a=$.map(a,function(a){var d=0;a>b?d=1:a<b&&(d=-1);b=a;return d})};
Toe.Model.Neume.prototype.deriveName=function(a){var b={enforceHeadShapes:!0};$.extend(b,a);if(0==this.components.length)return"unknown";a=this.diffToMelodicMove();a=Toe.Model.Neume.SearchTree.search(a,!0);a.prefix?(this.neumePrefix=a.result.typeid,this.name="Compound",this.typeid="compound"):(this.neumePrefix=null,this.name=a.result.name,this.typeid=a.result.typeid);"punctum"==this.typeid&&"virga"==this.components[0].props.type?(this.name="Virga",this.typeid="virga"):"distropha"==this.typeid&&"virga"==
this.components[0].props.type?(this.name="Bivirga",this.typeid="bivirga"):"tristropha"==this.typeid&&"virga"==this.components[0].props.type?(this.name="Trivirga",this.typeid="trivirga"):"Punctum"==this.name&&"cavum"==this.components[0].props.type?(this.name="Cavum",this.typeid="cavum"):"Podatus"==this.name&&this.props.modifier==Toe.Model.Neume.Modifier.alt?(this.name="Epiphonus",this.typeid="epiphonus"):"Clivis"==this.name&&this.props.modifier==Toe.Model.Neume.Modifier.alt&&(this.name="Cephalicus",
this.typeid="cephalicus");b.enforceHeadShapes&&this.enforceHeadShapes();return this.name};
Toe.Model.Neume.prototype.enforceHeadShapes=function(){switch(this.typeid){case "climacus.1":case "climacus.2":case "climacus.3":case "climacus.4":for(var a=1;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "climacus.resupinus.1":case "climacus.resupinus.2":case "climacus.resupinus.3":case "climacus.resupinus.4":for(a=1;a<this.components.length-1;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "podatus.subpunctis.1":case "podatus.subpunctis.2":case "podatus.subpunctis.3":case "podatus.subpunctis.4":for(a=
2;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "podatus.subpunctis.resupinus.1":case "podatus.subpunctis.resupinus.2":case "podatus.subpunctis.resupinus.3":for(a=2;a<this.components.length-1;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "scandicus.subpunctis.1":case "scandicus.subpunctis.2":for(a=3;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "porrectus.subpunctis.1":case "porrectus.subpunctis.2":for(a=
3;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "porrectus.subpunctis.resupinus.1":case "porrectus.subpunctis.resupinus.2":for(a=3;a<this.components.length-1;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "torculus.resupinus.3":case "torculus.resupinus.4":for(a=4;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum")}};
Toe.Model.Neume.prototype.syncDrawing=function(){this.deriveName();$(this).trigger("vUpdateDrawing",[this])};Toe.Ctrl.NeumeController=function(a,b){$(a).bind("mUpdateBoundingBox",function(b,d){var e=d.left-d.currentWidth/2,g=d.top-d.currentHeight/2;a.setBoundingBox([e,g,e+d.currentWidth,g+d.currentHeight])});$(a).bind("vRenderNeume",function(a,d){d.typeid||d.deriveName();b.render(d)});$(a).bind("vUpdateDrawing",function(a,d){b.updateDrawing(d)});$(a).bind("vEraseDrawing",function(){b.eraseDrawing()});$(a).bind("vSelectDrawing",function(){b.selectDrawing()})};
Toe.Ctrl.NeumeController.prototype.constructor=Toe.Ctrl.NeumeController;Toe.View.NeumeView=function(a){this.rendEng=a;this.ledgerLines=this.drawing=null};Toe.View.NeumeView.prototype.constructor=Toe.View.NeumeView;Toe.View.NeumeView.prototype.calcNoteYPos=function(a){var b=a.staff,c=[];c.push(b.zone.uly-a.rootStaffPos*b.delta_y/2);for(var d=1;d<a.components.length;d++)c.push(c[0]+-a.components[d].pitchDiff*b.delta_y/2);return c};
Toe.View.NeumeView.prototype.bestDotPlacements=function(a,b,c){var d=[],e=a.zone.uly+a.delta_y/2,g=ypos=b[c],f=Math.round(2*(g-e)/a.delta_y);0==f%2&&d.push(g);var m=ypos-a.delta_y/2,f=Math.round(2*(m-e)/a.delta_y),g=!1;if(0<=c-1&&ypos-a.delta_y/2==b[c-1]||c+1<b.length&&ypos-a.delta_y/2==b[c+1])g=!0;0==f%2&&!g&&d.push(m);m=ypos+a.delta_y/2;f=Math.round(2*(m-e)/a.delta_y);g=!1;if(c+1<b.length&&ypos+a.delta_y/2==b[c+1]||0<=c-1&&ypos+a.delta_y/2==b[c-1])g=!0;0==f%2&&!g&&d.push(m);return d};
Toe.View.NeumeView.prototype.drawLedgerLines=function(a,b,c,d){var c=0.75*c,e=this,g=[],f=2*(1-d.props.numLines);$.each(a,function(a,h){if(0<h)for(var i=0;i<=h;i+=2){var k=d.zone.uly-i*d.delta_y/2;g.push(e.rendEng.createLine([b[a]-c,k,b[a]+c,k]))}else if(h<f)for(i=f;i>=h;i-=2)k=d.zone.uly-i*d.delta_y/2,g.push(e.rendEng.createLine([b[a]-c,k,b[a]+c,k]))});this.ledgerLines=this.rendEng.draw({fixed:g,modify:[]},{group:!0,selectable:!1})[0]};
Toe.View.NeumeView.prototype.drawNeume=function(a){if(!this.rendEng)throw Error("Neume: Invalid render context");this.ledgerLines&&this.rendEng.canvas.remove(this.ledgerLines);for(var b=this.calcNoteYPos(a),c=a.staff,d=this,e=[],g=0;g<a.components.length;g++){var f=null;switch(a.components[g].props.name){case Toe.Model.NeumeComponent.Type.punctum:f="punctum";break;case Toe.Model.NeumeComponent.Type.virga:f="punctum";break;case Toe.Model.NeumeComponent.Type.cavum:f="whitepunct";break;case Toe.Model.NeumeComponent.Type.punctum_inclinatum:f=
"diamond";break;case Toe.Model.NeumeComponent.Type.punctum_inclinatum_parvum:f="diamond_small";break;case Toe.Model.NeumeComponent.Type.quilisma:f="quilisma"}e.push(this.rendEng.getGlyph(f))}var m=this.rendEng.getGlyph("dot"),h={fixed:[],modify:[]};switch(a.typeid){case "punctum":var i=a.zone.ulx+e[0].centre[0],f=e[0].clone().set({left:i,top:b[0]});h.modify.push(f);if(a.components[0].hasOrnament("dot")){var k=this.bestDotPlacements(c,b,0);h.modify.push(m.clone().set({left:f.left+2*e[0].centre[0],
top:k[0]}))}this.drawLedgerLines([a.rootStaffPos],[i],2*e[0].centre[0],c);break;case "cavum":i=a.zone.ulx+e[0].centre[0];f=e[0].clone().set({left:i,top:b[0]});h.modify.push(f);a.components[0].hasOrnament("dot")&&(k=this.bestDotPlacements(c,b,0),h.modify.push(m.clone().set({left:f.left+2*e[0].centre[0],top:k[0]})));this.drawLedgerLines([a.rootStaffPos],[i],2*e[0].centre[0],c);break;case "virga":i=a.zone.ulx+e[0].centre[0];f=e[0].clone().set({left:i,top:b[0]});h.modify.push(f);a.components[0].hasOrnament("dot")&&
(k=this.bestDotPlacements(c,b,0),h.modify.push(m.clone().set({left:f.left+2*e[0].centre[0],top:k[0]})));var j=f.left+e[0].centre[0]-1,j=this.rendEng.createLine([j,b[0],j,b[0]+1.5*c.delta_y],{strokeWidth:2,interact:!0});h.fixed.push(j);this.drawLedgerLines([a.rootStaffPos],[i],2*e[0].centre[0],c);break;case "clivis":var l=[];l.push(a.zone.ulx+e[0].centre[0]);var n=e[0].clone().set({left:l[0],top:b[0]});h.modify.push(n);f=l[0]-e[0].centre[0]+1;j=this.rendEng.createLine([f,b[0],f,a.zone.lry],{strokeWidth:2,
interact:!0});h.fixed.push(j);j=n.left+e[0].centre[0]-1;j=this.rendEng.createLine([j,b[0],j,b[1]],{strokeWidth:2,interact:!0});h.fixed.push(j);l.push(l[0]+2*e[1].centre[0]);var o=e[1].clone().set({left:l[1],top:b[1]});h.modify.push(o);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&h.modify.push(m.clone().set({left:o.left+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),l,
2*e[0].centre[0],c);break;case "cephalicus":l=[];i=this.rendEng.getGlyph("cephalicus");l.push(a.zone.ulx+i.centre[0]);n=i.clone().set({left:l[0],top:b[0]-i.centre[1]/2});h.modify.push(n);f=l[0]-i.centre[0]+1;j=this.rendEng.createLine([f,b[0],f,a.zone.lry],{strokeWidth:2,interact:!0});h.fixed.push(j);j=n.left+i.centre[0]-2;j=this.rendEng.createLine([j,b[0],j,b[1]],{strokeWidth:2,interact:!0});h.fixed.push(j);f=this.rendEng.getGlyph("liques_up");l.push(l[0]+i.centre[0]-f.centre[0]);o=f.clone().set({left:l[1],
top:b[1]-f.centre[1]/2});h.modify.push(o);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&h.modify.push(m.clone().set({left:o.left+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),l,2*e[0].centre[0],c);break;case "climacus.1":case "climacus.2":case "climacus.3":case "climacus.4":l=[];l.push(a.zone.ulx+e[0].centre[0]);k=e[0].centre[0];f=e[0].clone().set({left:l[0],top:b[0]});
h.modify.push(f);j=f.left+e[0].centre[0]-1;j=this.rendEng.createLine([j,b[0],j,b[0]+1.5*c.delta_y],{strokeWidth:2,interact:!0});h.fixed.push(j);for(f=1;f<a.components.length;f++)l.push(l[f-1]+2*e[f-1].centre[0]-1),1==f&&(l[1]+=k),j=e[f].clone().set({left:l[f],top:b[f]}),h.modify.push(j);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&h.modify.push(m.clone().set({left:l[a]+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,
function(b){return a.rootStaffPos+b.pitchDiff}),l,2*e[0].centre[0],c);break;case "torculus":l=[];l.push(a.zone.ulx+e[0].centre[0]);l.push(l[0]+2*e[0].centre[0]-1);l.push(l[1]+2*e[1].centre[0]-1);n=e[0].clone().set({left:l[0],top:b[0]});h.modify.push(n);j=n.left+e[0].centre[0]-1;j=this.rendEng.createLine([j,b[0],j,b[1]],{strokeWidth:2,interact:!0});h.fixed.push(j);o=e[1].clone().set({left:l[1],top:b[1]});h.modify.push(o);j=o.left+e[1].centre[0]-1;j=this.rendEng.createLine([j,b[1],j,b[2]],{strokeWidth:2,
interact:!0});h.fixed.push(j);f=e[2].clone().set({left:l[2],top:b[2]});h.modify.push(f);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&h.modify.push(m.clone().set({left:l[a]+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),l,2*e[0].centre[0],c);break;case "torculus.resupinus.1":case "torculus.resupinus.2":case "torculus.resupinus.3":case "torculus.resupinus.4":l=[];l.push(a.zone.ulx+
e[0].centre[0]);n=e[0].clone().set({left:l[0],top:b[0]});h.modify.push(n);k=this.rendEng.getGlyph("porrect_1");i=k.clone().set({left:l[0]+e[0].centre[0]+k.centre[0]-1,top:b[1]+k.centre[1]/2});h.modify.push(i);var f=i.left-k.centre[0],j=b[0],p=i.top+k.centre[1],j=this.rendEng.createLine([f,b[1],f,j],{strokeWidth:2,interact:!0});h.fixed.push(j);"torculus.resupinus.1"==a.typeid?l.push(i.left+k.centre[0]-e[3].centre[0]):l.push(i.left+k.centre[0]+e[3].centre[0]);f=e[3].clone().set({left:l[1],top:b[3]});
h.modify.push(f);j=i.left+k.centre[0]-1;j=this.rendEng.createLine([j,b[3],j,b[2]],{strokeWidth:2,interact:!0});h.fixed.push(j);"torculus.resupinus.2"==a.typeid&&(j=f.left+e[3].centre[0]-1,j=this.rendEng.createLine([j,b[4],j,b[3]],{strokeWidth:2,interact:!0}),h.fixed.push(j));for(f=4;f<a.components.length;f++)l.push(l[l.length-1]+2*e[f].centre[0]-1),j=e[f].clone().set({left:l[l.length-1],top:b[f]}),h.modify.push(j);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,
b,a);g.length>0&&h.modify.push(m.clone().set({left:l[a]+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),l,2*e[0].centre[0],c);break;case "podatus":l=[];k=0;1==Math.abs(a.components[1].pitchDiff)&&(k=1);i=this.rendEng.getGlyph("pes");l.push(a.zone.ulx+i.centre[0]);n=i.clone().set({left:l[0],top:b[0]-i.centre[1]/2+k});h.modify.push(n);j=n.left+i.centre[0]-1;j=this.rendEng.createLine([j,b[0],j,b[1]],{strokeWidth:2,interact:!0});
h.fixed.push(j);l.push(l[0]);o=e[1].clone().set({left:l[1],top:b[1]-k});h.modify.push(o);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&h.modify.push(m.clone().set({left:n.left+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),l,2*e[0].centre[0],c);break;case "epiphonus":l=[];i=this.rendEng.getGlyph("podatus_ep");l.push(a.zone.ulx+i.centre[0]);n=i.clone().set({left:l[0],top:b[0]});
h.modify.push(n);j=n.left+i.centre[0]-2;j=this.rendEng.createLine([j,b[0],j,b[1]],{strokeWidth:2,interact:!0});h.fixed.push(j);f=this.rendEng.getGlyph("liques_down");l.push(l[0]+i.centre[0]-f.centre[0]);o=f.clone().set({left:l[1],top:b[1]+f.centre[1]/2});h.modify.push(o);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&h.modify.push(m.clone().set({left:n.left+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+
b.pitchDiff}),l,2*e[0].centre[0],c);break;case "porrectus":k=this.rendEng.getGlyph("porrect_1");i=k.clone().set({left:a.zone.ulx+k.centre[0],top:b[0]+k.centre[1]/2});h.modify.push(i);f=i.left-k.centre[0]+1;j=a.zone.lry;p=i.top+k.centre[1];a.zone.lry<i.top+p&&(j=p);j=this.rendEng.createLine([f,b[0],f,j],{strokeWidth:2,interact:!0});h.fixed.push(j);l=i.left+k.centre[0]-e[2].centre[0];f=e[2].clone().set({left:l,top:b[2]});j=f.left+e[2].centre[0]-1;j=this.rendEng.createLine([j,b[2],j,b[1]],{strokeWidth:2,
interact:!0});h.fixed.push(j);h.modify.push(f);a.components[2].hasOrnament("dot")&&(k=this.bestDotPlacements(c,b,2),0<k.length&&h.modify.push(m.clone().set({left:f.left+2*e[2].centre[0],top:k[0]})));this.drawLedgerLines([a.rootStaffPos+a.components[2].pitchDiff],[l],2*e[2].centre[0],c);break;case "scandicus.1":case "scandicus.2":case "scandicus.3":case "scandicus.4":j=a.components.length;p=this.rendEng.getGlyph("pes");i=a.zone.ulx-e[0].centre[0];l=[];for(f=0;f<j-1;f+=2){k=0;1==Math.abs(a.components[f+
1].pitchDiff-a.components[f].pitchDiff)&&(k=1);i+=2*p.centre[0]-1;l.push(i);g=p.clone().set({left:i,top:b[f]-p.centre[1]/2+k});h.modify.push(g);g=i+p.centre[0]-1;g=this.rendEng.createLine([g,b[f],g,b[f+1]],{strokeWidth:2,interact:!0});h.fixed.push(g);l.push(i);o=e[f+1].clone().set({left:i,top:b[f+1]-k});h.modify.push(o);for(g=f;g<f+2;g++)a.components[g].hasOrnament("dot")&&(k=this.bestDotPlacements(c,b,g),0<k.length&&h.modify.push(m.clone().set({left:o.left+2*e[g].centre[0],top:k[0]})))}1==a.components.length%
2&&(i+=2*e[j-1].centre[0]-1,l.push(i),f=e[j-1].clone().set({left:i,top:b[j-1]}),h.modify.push(f),a.components[j-1].hasOrnament("dot")&&(k=this.bestDotPlacements(c,b,j-1),0<k.length&&h.modify.push(m.clone().set({left:f.left+2*e[j-1].centre[0],top:k[0]}))),f=i+e[j-1].centre[0]-2,f=this.rendEng.createLine([f,b[j-1],f,a.zone.lry-(a.zone.lry-a.zone.uly)/2],{strokeWidth:2,interact:!0}),h.fixed.push(f));this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),l,2*e[0].centre[0],
c)}this.drawing=this.rendEng.draw(h,{group:!0,selectable:a.props.interact,eleRef:a})[0];$(a).trigger("mUpdateBoundingBox",this.drawing)};Toe.View.NeumeView.prototype.render=function(a){this.drawNeume(a)};Toe.View.NeumeView.prototype.updateDrawing=function(a){this.drawing&&this.rendEng.canvas.remove(this.drawing);this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);this.drawNeume(a);this.selectDrawing();this.rendEng.repaint()};
Toe.View.NeumeView.prototype.eraseDrawing=function(){this.drawing&&this.rendEng.canvas.remove(this.drawing);this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);this.rendEng.repaint()};Toe.View.NeumeView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Model.Ornament=function(a,b){this.key=a.toLowerCase();this.type=Toe.Model.Ornament.Type[this.key];if(void 0==this.type)throw Error("Ornament: undefined ornament type");oForm="episema"==a?"horizontal":"dot"==a?"aug":null;this.props={form:oForm,interact:!1};$.extend(this.props,b)};Toe.Model.Ornament.prototype.constructor=Toe.Model.Ornament;Toe.Model.Ornament.Type={episema:"Episema",dot:"Dot"};Toe.Model.Page=function(){this.staves=[];this.scale=1};Toe.Model.Page.prototype.constructor=Toe.Model.Page;Toe.Model.Page.prototype.setDimensions=function(a,b){this.width=this.scale*a;this.height=this.scale*b};Toe.Model.Page.prototype.calcDimensions=function(a){var b=0,c=0;$(a).each(function(a,e){var g=parseInt($(e).attr("lrx")),f=parseInt($(e).attr("lry"));g>b&&(b=g);f>c&&(c=f)});return[b,c]};Toe.Model.Page.prototype.setPageScale=function(a){this.scale=a};
Toe.Model.Page.prototype.getClosestStaff=function(a){for(var b=this.staves.length-1,c=0;c<this.staves.length-1;c++)if(a.y<this.staves[c].zone.lry+(this.staves[c+1].zone.uly-this.staves[c].zone.lry)/2){b=c;break}return this.staves[b]};Toe.Model.Page.prototype.getNextStaff=function(a){a=$.inArray(a,this.staves);return-1!=a&&a+1<this.staves.length?this.staves[a+1]:null};Toe.Model.Page.prototype.getPreviousStaff=function(a){a=$.inArray(a,this.staves);return 0<=a-1?this.staves[a-1]:null};
Toe.Model.Page.prototype.addStaff=function(a){this.staves.push(a);$(a).trigger("vRenderStaff",[a]);return this};Toe.Ctrl.PageController=function(a,b){$(b).bind("mSetDimensions.ui",function(b,d,e){a.setDimensions(d,e)});$(a).bind("vSetDimensions",function(a,d,e){b.setDimensions(d,e)})};Toe.Ctrl.PageController.prototype.constructor=Toe.Ctrl.PageController;Toe.View.PageView=function(a){this.rendEng=a};Toe.View.PageView.prototype.constructor=Toe.View.PageView;Toe.View.PageView.prototype.setDimensions=function(a,b){this.canvas.setDimensions({width:a,height:b})};Toe.View.RenderEngine=function(a){this.options={globScale:0.08};$.extend(this.options,a)};Toe.View.RenderEngine.prototype.constructor=Toe.View.RenderEngine;Toe.View.RenderEngine.prototype.setGlyphs=function(a){this.glyphs=a};Toe.View.RenderEngine.prototype.setCanvas=function(a){this.canvas=a;this.canvas.HOVER_CURSOR="pointer"};Toe.View.RenderEngine.prototype.setGlobalScale=function(a){this.options.globScale=a;$.each(this.glyphs,function(b,c){c.centre=[c.centre[0]*a,c.centre[1]*a]})};
Toe.View.RenderEngine.prototype.getGlobalScale=function(){return this.options.globScale};Toe.View.RenderEngine.prototype.getGlyph=function(a){return this.glyphs[a]};Toe.View.RenderEngine.prototype.calcScaleFromStaff=function(a,b){opts={overwrite:!1};$.extend(opts,b);var c=(a.zone.lry-a.zone.uly)/(a.props.numLines-1),c=2*c-0.65*c,d=this.getGlyph("c_clef").clone().height;scale=Math.abs(c/d);opts.overwrite&&this.setGlobalScale(scale);return scale};
Toe.View.RenderEngine.prototype.createLine=function(a,b){var c={fill:"rgb(0,0,0)",strokeWidth:3,opacity:1,interact:!1};$.extend(c,b);return new fabric.Line(a,{fill:c.fill,strokeWidth:c.strokeWidth,opacity:c.opacity,selectable:c.interact})};
Toe.View.RenderEngine.prototype.outlineBoundingBox=function(a,b){var c={fill:"rgb(0,255,0)",opacity:0.65,interact:!1};$.extend(c,b);var d=a[2]-a[0],e=a[3]-a[1],a=new fabric.Rect({width:d,height:e,left:a[0]+d/2,top:a[1]+e/2,fill:c.fill,opacity:c.opacity}),d={fixed:[],modify:[]};d.fixed.push(a);this.draw(d,{selectable:c.interact,opacity:c.opacity})};
Toe.View.RenderEngine.prototype.draw=function(a,b){var c={modify:!0,repaint:!1,group:!1,selectable:!0,hasControls:!1,hasBorders:!1,lockMovementX:!1,lockMovementY:!1,opacity:1,eleRef:null};$.extend(c,b);a.modify=this.preprocess(a.modify);a=$.merge($.merge([],a.modify),a.fixed);c.group&&(a=[new fabric.Group(a)]);$.map(a,function(a){a.selectable=c.selectable;a.hasControls=c.hasControls;a.lockRotation=!0;a.lockScale=!0;a.lockMovementX=c.lockMovementX;a.lockMovementY=c.lockMovementY;a.opacity=c.opacity;
a.eleRef=c.eleRef});for(var d=0;d<a.length;d++)this.canvas.add(a[d]);c.repaint&&this.repaint();return a};Toe.View.RenderEngine.prototype.unObserve=function(a){delete this.canvas.__eventListeners[a]};Toe.View.RenderEngine.prototype.repaint=function(){this.canvas.renderAll()};Toe.View.RenderEngine.prototype.preprocess=function(a){for(var b=0;b<a.length;b++)a[b]=a[b].scale(this.options.globScale),a[b].currentWidth*=this.options.globScale,a[b].currentHeight*=this.options.globScale;return a};Toe.Model.Staff=function(a,b){if(!Toe.validBoundingBox(a))throw Error("Staff: invalid bounding box");this.zone={};this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3];this.props={numLines:4,interact:!1};$.extend(this.props,b);this.delta_y=Math.abs(this.zone.lry-this.zone.uly)/(this.props.numLines-1);this.custos=this.id=null;this.elements=[]};Toe.Model.Staff.prototype.constructor=Toe.Model.Staff;Toe.Model.Staff.prototype.setID=function(a){this.id=a};
Toe.Model.Staff.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Staff: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3];this.delta_y=Math.abs(this.zone.lry-this.zone.uly)/(this.props.numLines-1)};
Toe.Model.Staff.prototype.getPitchedElements=function(a){var b={clef:null,neumes:!0,custos:!0};$.extend(b,a);if(b.clef){for(var a=[],c=$.inArray(b.clef,this.elements)+1;c<this.elements.length&&!(this.elements[c]instanceof Toe.Model.Clef);c++){var d=this.elements[c];(d instanceof Toe.Model.Neume&&b.neumes||d instanceof Toe.Model.Custos&&b.custos)&&a.push(d)}return a}return $.grep(this.elements,function(a){if(a instanceof Toe.Model.Neume&&b.neumes||a instanceof Toe.Model.Custos&&b.custos)return a})};
Toe.Model.Staff.prototype.calcPitchFromStaffPos=function(a,b){var c=a-b.props.staffPos,d=Toe.neumaticChroma.length,e=$.inArray(b.shape,Toe.neumaticChroma),g=(e+c)%d;0>g&&(g+=d);var f=Toe.neumaticChroma[g],m=$.inArray("c",Toe.neumaticChroma),d=$.truncateFloat(c/d);0<c&&g>=m&&g<e?d++:0>c&&(g<m||g>e)&&d--;c=4;"f"==b.shape&&(c=3);return{pname:f,oct:c+d}};
Toe.Model.Staff.prototype.calcStaffPosFromPitch=function(a,b,c){var d=4;"f"==c.shape&&(d=3);var e=Toe.neumaticChroma.length,g=$.inArray(c.shape,Toe.neumaticChroma),a=$.inArray(a,Toe.neumaticChroma),f=$.inArray("c",Toe.neumaticChroma),b=a-g+e*(b-d);a<f&&(b+=e);return c.props.staffPos+b};Toe.Model.Staff.prototype.calcPitchFromCoords=function(a){var b=Math.round((this.zone.uly-a.y)/(this.delta_y/2)),a=this.getActingClefByCoords(a);return this.calcPitchFromStaffPos(b,a)};
Toe.Model.Staff.prototype.updatePitchedElements=function(a){var b={clef:null,neumes:!0,custos:!1};$.extend(b,a);var c=this;if(b.clef)a=this.getPitchedElements({clef:b.clef}),this.custos&&(a[a.length-1]==this.custos&&!b.custos)&&(this.custos.setRootStaffPos(this.calcStaffPosFromPitch(this.custos.pname,this.custos.oct,b.clef)),a.pop()),$.each(a,function(a,d){c.updateElePitchInfo(d,{clef:b.clef})});else{var d=null;$.each(this.elements,function(a,g){g instanceof Toe.Model.Clef?d=g:d&&(g instanceof Toe.Model.Neume&&
b.neumes||g==this.custos&&b.custos)?c.updateElePitchInfo(g,{clef:d}):this.custos&&(g==this.custos&&!b.custos)&&this.custos.setRootStaffPos(this.calcStaffPosFromPitch(this.custos.pname,this.custos.oct,d))})}};
Toe.Model.Staff.prototype.updateElePitchInfo=function(a,b){var c={clef:null};$.extend(c,b);c.clef||(c.clef=this.getActingClefByEle(a));var d=this;if(a instanceof Toe.Model.Neume)$.each(a.components,function(b,e){var m=d.calcPitchFromStaffPos(a.rootStaffPos+e.pitchDiff,c.clef);e.setPitchInfo(m.pname,m.oct)});else if(a instanceof Toe.Model.Custos){var e=this.calcPitchFromStaffPos(a.rootStaffPos,c.clef);a.setRootNote(e.pname,e.oct)}};Toe.Model.Staff.prototype.calcPitchDifference=function(){};
Toe.Model.Staff.prototype.sortElements=function(){this.elements.sort(function(a,b){return a.zone.ulx-b.zone.ulx})};Toe.Model.Staff.prototype.insertElement=function(a){for(var b=this.elements.length,c=0;c<this.elements.length;c++)if(a.zone.ulx<=this.elements[c].zone.ulx){b=c;break}this.elements.splice(b,0,a);return b};
Toe.Model.Staff.prototype.removeElementByID=function(a){for(var b=this.elements.length-1;0<=b;b--)this.elements[b].id==a&&($(this.elements[b]).trigger("vEraseDrawing"),this.elements.splice(b,1))};Toe.Model.Staff.prototype.removeElementByRef=function(a){a=$.inArray(a,this.elements);0<=a&&($(this.elements[a]).trigger("vEraseDrawing"),this.elements.splice(a,1))};Toe.Model.Staff.prototype.getActingClefByEle=function(a){for(a=$.inArray(a,this.elements);0<=a;a--){var b=this.elements[a];if(b instanceof Toe.Model.Clef)return b}return null};
Toe.Model.Staff.prototype.getActingClefByCoords=function(a){for(var b=this.elements.length;0<=b;b--){var c=this.elements[b];if(c instanceof Toe.Model.Clef&&a.x>c.zone.lrx)return c}return null};Toe.Model.Staff.prototype.getPreviousClef=function(a){a=$.inArray(a,this.elements);if(0<a)for(a-=1;0<=a;a--)if(this.elements[a]instanceof Toe.Model.Clef)return this.elements[a];return null};
Toe.Model.Staff.prototype.addClef=function(a,b){if(!(a instanceof Toe.Model.Clef))throw Error("Staff: Invalid clef");var c={justPush:!1};$.extend(c,b);var d=null;c.justPush?(this.elements.push(a),d=this.elements.length-1):d=this.insertElement(a);a.setStaff(this);this.updatePitchedElements({clef:a,custos:!1});$(a).trigger("vRenderClef",[a]);return d};
Toe.Model.Staff.prototype.setCustos=function(a){if(!(a instanceof Toe.Model.Custos))throw Error("Staff: Invalid Custos");var b=this.getActingClefByCoords({x:a.zone.ulx});b&&(a.rootStaffPos=this.calcStaffPosFromPitch(a.pname,a.oct,b),0<this.elements.length&&this.elements[this.elements.length-1]instanceof Toe.Model.Custos?this.elements[this.elements.length-1]=a:this.elements.push(a),a.setStaff(this),this.custos=a,$(a).trigger("vRenderCustos",[a]));return this.elements.length-1};
Toe.Model.Staff.prototype.addNeume=function(a,b){if(!(a instanceof Toe.Model.Neume))throw Error("Staff: Invalid neume");var c={justPush:!1};$.extend(c,b);var d=this.getActingClefByCoords({x:a.zone.ulx});if(d){a.getRootPitchInfo();a.rootStaffPos=this.calcStaffPosFromPitch(a.components[0].pname,a.components[0].oct,d);a.components[0].setPitchDifference(0);for(var e=1;e<a.components.length;e++){var g=a.components[e];g.setPitchDifference(this.calcStaffPosFromPitch(g.pname,g.oct,d)-a.rootStaffPos)}d=null;
c.justPush?(this.elements.push(a),d=this.elements.length-1):d=this.insertElement(a);a.setStaff(this);$(a).trigger("vRenderNeume",[a]);return d}return null};Toe.Model.Staff.prototype.addDivision=function(a,b){if(!(a instanceof Toe.Model.Division))throw Error("Staff: invalid division");var c={justPush:!1};$.extend(c,b);var d=null;c.justPush?(this.elements.push(a),d=this.elements.length-1):d=this.insertElement(a);a.setStaff(this);$(a).trigger("vRenderDivision",[a]);return d};
Toe.Model.Staff.prototype.ohSnap=function(a,b,c){var d={ignoreEle:null,x:!0,y:!0};$.extend(d,c);if(d.y){var c=this.zone.uly,e=this.zone.uly+this.delta_y/2,g=(a.y-c)/this.delta_y,f=Math.abs(Math.round(Math.abs(g))-Math.abs(g)),m=(a.y-e)/this.delta_y,h=Math.abs(Math.round(Math.abs(m))-Math.abs(m));a.y=Math.min(f,h)==f?c+Math.round(g)*this.delta_y:e+Math.round(m)*this.delta_y}if(d.x){c=a.x-b/2;e=a.x+b/2;for(g=0;g<this.elements.length;g++)if(this.elements[g]!=d.ignoreEle&&(f=this.elements[g].zone.ulx,
m=this.elements[g].zone.lrx,!(c>=m))){a.x=c>=f&&c<m||e>=f&&e<m||f>c&&m<e?a.x<f+(m-f)/2?f-b/2:m+b/2:a.x;break}this.elements.length&&this.elements[0]instanceof Toe.Model.Clef&&c<=this.elements[0].zone.lrx?a.x=this.elements[0].zone.lrx+b/2+1:c<=this.zone.ulx&&(a.x=this.zone.ulx+b/2+1);this.custos&&d.ignoreEle!=this.custos&&e>=this.custos.zone.ulx?a.x=this.custos.zone.ulx-b/2-3:e>=this.zone.lrx&&(a.x=this.zone.lrx-b/2-3)}return a};Toe.Ctrl.StaffController=function(a,b){$(a).bind("vRenderStaff",function(a,d){b.renderStaff(d)})};Toe.Ctrl.StaffController.prototype.constructor=Toe.Ctrl.StaffController;Toe.View.StaffView=function(a){this.rendEng=a};Toe.View.StaffView.prototype.constructor=Toe.View.StaffView;Toe.View.StaffView.prototype.renderStaff=function(a){if(!this.rendEng)throw Error("Staff: Invalid render context");for(var b={fixed:[],modify:[]},c=0;c<a.props.numLines;c++){var d=a.zone.uly+c*a.delta_y;b.fixed.push(this.rendEng.createLine([a.zone.ulx,d,a.zone.lrx,d]))}this.rendEng.draw(b,{selectable:a.props.interact})};
