Toe={Model:{},Ctrl:{},View:{}};(function(a){a.arraysEqual=function(b,c){if(b.length!=c.length)return!1;var d=!0;a.each(b,function(a,b){if(b!=c[a])return d=!1});return d}})(jQuery);(function(a){a.truncateFloat=function(a){return 0<a?Math.floor(a):Math.ceil(a)}})(jQuery);Toe.validBoundingBox=function(a){return a[0]<=a[2]&&a[1]<=a[3]};Toe.neumaticChroma="abcdefg".split("");Toe.Model.Clef=function(a,b){this.shape=a.toLowerCase();this.name=Toe.Model.Clef.Type[this.shape];if(void 0==this.name)throw Error("Clef: unknown clef shape");var c=null;"c"==a?c=0:"f"==a&&(c=2);this.props={staffPos:c,interact:!0};$.extend(this.props,b);this.zone={};this.staff=null};Toe.Model.Clef.Type={c:"Doh Clef",f:"Fah Clef"};Toe.Model.Clef.prototype.constructor=Toe.Model.Clef;Toe.Model.Clef.prototype.setID=function(a){this.id=a};
Toe.Model.Clef.prototype.setStaff=function(a){if(!(a instanceof Toe.Model.Staff))throw Error("Clef: invalid staff reference");this.staff=a};Toe.Model.Clef.prototype.setShape=function(a){this.shape=a.toLowerCase();this.name=Toe.Model.Clef.Type[this.shape];if(void 0==this.name)throw Error("Clef: unknown clef shape");this.staff.updatePitchedElements({clef:this,custos:!1});$(this).trigger("vUpdateShape",[this])};
Toe.Model.Clef.prototype.setStaffPosition=function(a){this.props.staffPos!=a&&(this.props.staffPos=a,this.staff.updatePitchedElements({clef:this,custos:!1}),$(this).trigger("vUpdateStaffPosition",[this]))};Toe.Model.Clef.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Clef: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};Toe.Model.Clef.prototype.selectDrawing=function(){$(this).trigger("vSelectDrawing")};Toe.Ctrl.ClefController=function(a,b){$(a).bind("mUpdateBoundingBox",function(b,d){var e=d.left-d.currentWidth/2,g=d.top-d.currentHeight/2;a.setBoundingBox([e,g,e+d.currentWidth,g+d.currentHeight])});$(a).bind("vRenderClef",function(a,d){b.renderClef(d)});$(a).bind("vUpdateShape",function(a,d){b.updateShape(d)});$(a).bind("vUpdateStaffPosition",function(a,d){b.updateStaffPosition(d)});$(a).bind("vSelectDrawing",function(){b.selectDrawing()})};Toe.Ctrl.ClefController.prototype.constructor=Toe.Ctrl.ClefController;Toe.View.ClefView=function(a){this.rendEng=a;this.drawing=null};Toe.View.ClefView.prototype.constructor=Toe.View.ClefView;
Toe.View.ClefView.prototype.drawClef=function(a){if(!this.rendEng)throw Error("Clef: Invalid render context");var b=a.staff,c=null;switch(a.shape){case "c":c="c_clef";break;case "f":c="f_clef"}var c=this.rendEng.getGlyph(c),d=a.zone.ulx+c.centre[0],b=b.zone.uly-a.props.staffPos*b.delta_y/2;"f"==a.shape&&(b+=0.34*c.centre[1]);this.drawing=this.rendEng.draw({fixed:[],modify:[c.clone().set({left:d,top:b})]},{selectable:a.props.interact,eleRef:a})[0];$(a).trigger("mUpdateBoundingBox",this.drawing)};
Toe.View.ClefView.prototype.renderClef=function(a){this.drawClef(a)};Toe.View.ClefView.prototype.updateShape=function(a){if(this.drawing)this.rendEng.canvas.remove(this.drawing);else throw Error("Clef: update method called, but there exists no drawing to update.");this.drawClef(a);this.selectDrawing();this.rendEng.repaint()};
Toe.View.ClefView.prototype.updateStaffPosition=function(a){if(!this.drawing)throw Error("Clef: update method called, but there exists no drawing to update.");var b=a.staff.zone.uly-a.props.staffPos*a.staff.delta_y/2;"f"==a.shape&&(b+=0.34*this.drawing.currentHeight/2);this.drawing.top=b;this.rendEng.repaint();$(a).trigger("mUpdateBoundingBox",this.drawing)};Toe.View.ClefView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Model.Custos=function(a,b,c){this.props={interact:!1};$.extend(this.props,c);this.pname=a;this.oct=b;this.rootStaffPos=null;this.zone={};this.staff=this.id=null};Toe.Model.Custos.prototype.constructor=Toe.Model.Custos;Toe.Model.Custos.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Division: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};
Toe.Model.Custos.prototype.setID=function(a){this.id=a};Toe.Model.Custos.prototype.setStaff=function(a){if(!(a instanceof Toe.Model.Staff))throw Error("Custos: invalid staff reference");this.staff=a};Toe.Model.Custos.prototype.setRootNote=function(a,b){this.pname=a;this.oct=b};Toe.Model.Custos.prototype.setRootStaffPos=function(a){this.rootStaffPos!=a&&(this.rootStaffPos=a,$(this).trigger("vUpdateStaffPosition",[this]))};Toe.Model.Custos.prototype.selectDrawing=function(){$(this).trigger("vSelectDrawing")};
Toe.Model.Custos.prototype.eraseDrawing=function(){$(this).trigger("vEraseDrawing")};Toe.Ctrl.CustosController=function(a,b){$(a).bind("mUpdateBoundingBox",function(b,d){var e=d.left-d.currentWidth/2,g=d.top-d.currentHeight/2;a.setBoundingBox([e,g,e+d.currentWidth,g+d.currentHeight])});$(a).bind("vRenderCustos",function(a,d){b.renderCustos(d)});$(a).bind("vUpdateStaffPosition",function(a,d){b.updateStaffPosition(d)});$(a).bind("vEraseDrawing",function(){b.eraseDrawing()});$(a).bind("vSelectDrawing",function(){b.selectDrawing()})};Toe.Ctrl.CustosController.prototype.constructor=Toe.Ctrl.CustosController;Toe.View.CustosView=function(a){this.rendEng=a;this.ledgerLines=this.drawing=null};Toe.View.CustosView.prototype.constructor=Toe.View.CustosView;
Toe.View.CustosView.prototype.drawLedgerLines=function(a,b,c,d){var c=0.75*c,e=[],g=2*(1-d.props.numLines);if(0<a)for(g=0;g<=a;g+=2){var f=d.zone.uly-g*d.delta_y/2;e.push(this.rendEng.createLine([b-c,f,b+c,f]))}else if(a<g)for(;g>=a;g-=2)f=d.zone.uly-g*d.delta_y/2,e.push(this.rendEng.createLine([b-c,f,b+c,f]));this.ledgerLines=this.rendEng.draw({fixed:e,modify:[]},{group:!0,selectable:!1})[0]};
Toe.View.CustosView.prototype.renderCustos=function(a){if(!this.rendEng)throw Error("Custos: Invalid render context");var b=a.staff,c=this.rendEng.getGlyph("custos"),d=b.zone.uly-a.rootStaffPos*b.delta_y/2,e=a.zone.ulx+c.centre[0],d=c.clone().set({left:e,top:d-c.centre[1]/2});this.drawLedgerLines(a.rootStaffPos,e,4*c.centre[0],b);this.drawing=this.rendEng.draw({fixed:[],modify:[d]},{selectable:a.props.interact,eleRef:a})[0]};
Toe.View.CustosView.prototype.updateStaffPosition=function(a){if(!this.drawing)throw Error("Custos: update method called, but there exists no drawing to update.");this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);var b=a.staff;this.drawing.set({top:b.zone.uly-a.rootStaffPos*b.delta_y/2-this.drawing.currentHeight/4});this.drawLedgerLines(a.rootStaffPos,this.drawing.left,1.5*this.drawing.currentWidth,b);this.rendEng.repaint();$(a).trigger("mUpdateBoundingBox",this.drawing)};
Toe.View.CustosView.prototype.eraseDrawing=function(){this.drawing&&this.rendEng.canvas.remove(this.drawing);this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);this.rendEng.repaint()};Toe.View.CustosView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Model.Division=function(a,b){this.key=a.toLowerCase();this.type=Toe.Model.Division.Type[this.key];if(void 0==this.type)throw Error("Division: undefined division type");this.props={interact:!0};$.extend(this.props,b);this.zone={};this.staff=this.id=null};Toe.Model.Division.prototype.constructor=Toe.Model.Division;
Toe.Model.Division.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Division: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};Toe.Model.Division.prototype.setID=function(a){this.id=a};Toe.Model.Division.prototype.setStaff=function(a){if(!(a instanceof Toe.Model.Staff))throw Error("Division: invalid staff reference");this.staff=a};
Toe.Model.Division.Type={div_small:"Small Division",div_minor:"Minor Division",div_major:"Major Division",div_final:"Final Division"};Toe.Model.Division.prototype.selectDrawing=function(){$(this).trigger("vSelectDrawing")};Toe.Ctrl.DivisionController=function(a,b){$(a).bind("vRenderDivision",function(a,d){b.renderDivision(d)});$(a).bind("vSelectDrawing",function(){b.selectDrawing()})};Toe.Ctrl.DivisionController.prototype.constructor=Toe.Ctrl.DivisionController;Toe.View.DivisionView=function(a){this.rendEng=a};Toe.View.DivisionView.prototype.constructor=Toe.View.DivisionView;
Toe.View.DivisionView.prototype.renderDivision=function(a){if(!this.rendEng)throw Error("Division: Invalid render context");var b=a.staff,c={fixed:[],modify:[]},d=a.zone.ulx,e={strokeWidth:4};switch(a.type){case Toe.Model.Division.Type.div_small:var g=b.zone.uly-b.delta_y/2,b=b.zone.uly+b.delta_y/2;c.fixed.push(this.rendEng.createLine([d,g,d,b],e));break;case Toe.Model.Division.Type.div_minor:g=b.zone.uly+b.delta_y/2;b=g+2*b.delta_y;c.fixed.push(this.rendEng.createLine([d,g,d,b],e));break;case Toe.Model.Division.Type.div_major:g=
b.zone.uly;b=b.zone.lry;c.fixed.push(this.rendEng.createLine([d,g,d,b],e));break;case Toe.Model.Division.Type.div_final:g=b.zone.uly,b=b.zone.lry,c.fixed.push(this.rendEng.createLine([d,g,d,b],e)),d=a.zone.lrx,c.fixed.push(this.rendEng.createLine([d,g,d,b],e))}this.drawing=this.rendEng.draw(c,{group:!0,selectable:a.props.interact,eleRef:a})[0]};Toe.View.DivisionView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Model.Glyph=function(a,b){this.key=a;this.obj=b;this.centre=[this.obj.width/2,this.obj.height/2]};Toe.Model.Glyph.prototype.constructor=Toe.Glyph;Toe.Model.Glyph.prototype.clone=function(){return this.obj.clone()};Toe.View.GUI=function(a,b,c,d,e,g){var f={sldr_bgImgOpacity:!0,initBgImgOpacity:0.6,initMode:"edit"};$.extend(f,g);this.rendEng=c;this.page=d;this.csrf_token=e;this.prefix=a;this.fileName=b;this.clefDwg=this.divisionDwg=this.punctDwg=null;a=c.getGlyph("punctum").clone();this.punctWidth=a.width*c.getGlobalScale();this.punctHeight=a.height*c.getGlobalScale();this.objMoving=!1;gui=this;this.setupNavBar();this.setupSideBar("#gui-sidebar",f);$("#btn_"+f.initMode).trigger("click")};
Toe.View.GUI.prototype.constructor=Toe.View.GUI;Toe.View.GUI.prototype.setupNavBar=function(){};
Toe.View.GUI.prototype.setupSideBar=function(a,b){var c=this;b.sldr_bgImgOpacity&&($(a).prepend('<span id="sidebar-bg"><li class="nav-header">Background</li>\n<li>\n<label for="sldr_bgImgOpacity"><b>Image Opacity</b>:</label>\n<input id="sldr_bgImgOpacity" style="width: 95%;" type="range" name="bgImgOpacity" min="0.0" max="1.0" step="0.05" value="'+b.initBgImgOpacity+'" />\n</li></span>'),$("#sldr_bgImgOpacity").bind("change",function(){c.rendEng.canvas.backgroundImageOpacity=$(this).val();c.rendEng.repaint();
return!1}));$("#btn_edit").bind("click.edit",{gui:c,parentDivId:a},c.handleEdit);$("#btn_insert").bind("click.insert",{gui:c,parentDivId:a},c.handleInsert)};
Toe.View.GUI.prototype.handleEdit=function(a){var b=a.data.gui,c=a.data.parentDivId;a.preventDefault();a.stopPropagation();$("#sidebar-insert").remove();b.rendEng.unObserve("mouse:move");b.rendEng.unObserve("mouse:up");b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.divisionDwg&&b.rendEng.canvas.remove(b.divisionDwg);b.clefDwg&&b.rendEng.canvas.remove(b.clefDwg);b.rendEng.repaint();0==$("#sidebar-edit").length&&$(c).append('<span id="sidebar-edit"><br/><li class="divider"></li><li class="nav-header">Edit</li>\n<li>\n<button id="btn_delete" class="btn"><i class="icon-remove"></i> Delete</button>\n</li>\n<li>\n<div class="btn-group">\n<button id="btn_neumify" class="btn"><i class="icon-magnet"></i> Neumify</button>\n<button id="btn_modifier" class="btn dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>\n<ul class="dropdown-menu"><li><a id="btn_neumify_liquescence">liquescence</a></li></ul></li>\n<li><button id="btn_ungroup" class="btn"><i class="icon-share"></i> Ungroup</button></li>\n</div>\n</span>');
b.rendEng.canvas.observe("mouse:down",function(a){b.downCoords=b.rendEng.canvas.getPointer(a.memo.e);return!1});b.rendEng.canvas.observe("object:moving",function(){b.objMoving=!0;return!1});b.rendEng.canvas.observe("object:selected",function(){var a=b.rendEng.canvas.getActiveObject().eleRef;a instanceof Toe.Model.Neume?($("#info > p").html("Selected: "+a.name+"<br/> Pitche(s): "+$.map(a.components,function(a){return a.pname.toUpperCase()+a.oct}).join(", ")),$("#info").animate({opacity:1},100),$("#menu_editclef").remove(),
"punctum"==a.typeid||"cavum"==a.typeid||"virga"==a.typeid?(0==$("#menu_editpunctum").length&&$("#sidebar-edit").append('<span id="menu_editpunctum"><br/><li class="nav-header">Ornamentation</li>\n<li><div class="btn-group" data-toggle="buttons-checkbox">\n<button id="edit_chk_dot" class="btn">&#149; Dot</button>\n<button id="edit_chk_horizepisema" class="btn"><i class="icon-resize-horizontal"></i> Episema</button>\n<button id="edit_chk_vertepisema" class="btn"><i class="icon-resize-vertical"></i> Episema</button>\n</div></li>\n<br/><li class="nav-header">Attributes</li>\n<li><div class="btn-group"><a class="btn dropdown-toggle" data-toggle="dropdown">\nHead shape <span class="caret"></span></a><ul class="dropdown-menu">\n<li><a id="head_punctum">punctum</a></li>\n<li><a id="head_punctum_inclinatum">punctum inclinatum</a></li>\n<li><a id="head_punctum_inclinatum_parvum">punctum inclinatum parvum</a></li>\n<li><a id="head_cavum">cavum</a></li>\n<li><a id="head_virga">virga</a></li>\n<li><a id="head_quilisma">quilisma</a></li>\n</ul></div></span>'),
a.components[0].hasOrnament("dot")?$("#edit_chk_dot").toggleClass("active",!0):$("#edit_chk_dot").toggleClass("active",!1),$("#edit_chk_dot").unbind("click"),$("#edit_chk_dot").bind("click.edit",{gui:b,punctum:a},b.handleDotToggle),$("#head_punctum").unbind("click"),$("#head_cavum").unbind("click"),$("#head_virga").unbind("click"),$("#head_quilisma").unbind("click"),$("#head_punctum_inclinatum").unbind("click"),$("#head_punctum_inclinatum_parvum").unbind("click"),$("#head_punctum").bind("click.edit",
{gui:b,punctum:a,shape:"punctum"},b.handleHeadShapeChange),$("#head_cavum").bind("click.edit",{gui:b,punctum:a,shape:"cavum"},b.handleHeadShapeChange),$("#head_virga").bind("click.edit",{gui:b,punctum:a,shape:"virga"},b.handleHeadShapeChange),$("#head_quilisma").bind("click.edit",{gui:b,punctum:a,shape:"quilisma"},b.handleHeadShapeChange),$("#head_punctum_inclinatum").bind("click.edit",{gui:b,punctum:a,shape:"punctum_inclinatum"},b.handleHeadShapeChange),$("#head_punctum_inclinatum_parvum").bind("click.edit",
{gui:b,punctum:a,shape:"punctum_inclinatum_parvum"},b.handleHeadShapeChange)):$("#menu_editpunctum").remove()):a instanceof Toe.Model.Clef?($("#info > p").text("Selected: "+a.name),$("#info").animate({opacity:1},100),0==$("#menu_editclef").length&&$("#sidebar-edit").append('<span id="menu_editclef"><br/><li class="nav-header">Clef</li>\n<li><div class="btn-group" data-toggle="buttons-radio">\n<button id="edit_rad_c" class="btn">Doh</button>\n<button id="edit_rad_f" class="btn">Fah</button>\n</div></li></span>'),
"c"==a.shape?$("#edit_rad_c").toggleClass("active",!0):$("#edit_rad_f").toggleClass("active",!0),$("#edit_rad_c").unbind("click"),$("#edit_rad_f").unbind("click"),$("#edit_rad_c").bind("click.edit",{gui:b,clef:a,shape:"c"},b.handleClefShapeChange),$("#edit_rad_f").bind("click.edit",{gui:b,clef:a,shape:"f"},b.handleClefShapeChange)):(a instanceof Toe.Model.Division?($("#info > p").text("Selected: "+a.type),$("#info").animate({opacity:1},100)):a instanceof Toe.Model.Custos&&($("#info > p").html("Selected: Custos <br/> Pitch: "+
a.pname.toUpperCase()+a.oct),$("#info").animate({opacity:1},100)),$("#menu_editpunctum").remove(),$("#menu_editclef").remove());return!1});b.rendEng.canvas.observe("selection:cleared",function(){$("#info").animate({opacity:0},100);$("#menu_editpunctum").remove();$("#menu_editclef").remove();return!1});b.rendEng.canvas.observe("mouse:up",function(a){var a=b.rendEng.canvas.getPointer(a.memo.e),c=b.downCoords.y-a.y;if(b.objMoving){var g=b.rendEng.canvas.getActiveObject();if(g){var f=[];g.eleRef?f.push(g):
$.each(g.objects,function(a,b){f.push(b)});$.each(f,function(a,d){var h=d.eleRef;if(h instanceof Toe.Model.Clef){var i=d.left,k=d.top;1<f.length&&(i=g.left+d.left,k=g.top+d.top);i=h.staff.ohSnap({x:i,y:k},null,{ignoreEle:h});i=-Math.round((i.y-h.staff.zone.uly)/(h.staff.delta_y/2));h.setStaffPosition(i);var m=h.staff.getPitchedElements({neumes:!0,custos:!1});0<m.length&&h.staff.getActingClefByEle(m[0])==h&&(i=b.page.getPreviousStaff(h.staff))&&b.handleUpdatePrevCustos(m[0].components[0].pname,m[0].components[0].oct,
i);var i=$.map(h.staff.getPitchedElements({clef:h}),function(a){if(a instanceof Toe.Model.Neume){var d=[];$.each(a.components,function(a,b){d.push({pname:b.pname,oct:b.oct})});return{id:a.id,noteInfo:d}}if(a instanceof Toe.Model.Custos){var c=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);$.post(b.prefix+"/edit/"+b.fileName+"/move/custos",{id:a.id,ulx:c[0],uly:c[1],lrx:c[2],lry:c[3],csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)})}}),k=h.staff.props.numLines+h.props.staffPos/2,m=b.getOutputBoundingBox([h.zone.ulx,h.zone.uly,h.zone.lrx,h.zone.lry]),n={id:h.id,line:k,ulx:m[0],uly:m[1],lrx:m[2],lry:m[3],pitchInfo:i};$.post(b.prefix+"/edit/"+b.fileName+"/move/clef",{data:JSON.stringify(n),csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move clef. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}else if(h instanceof
Toe.Model.Neume){i=d.left;k=d.top;1<f.length&&(i=g.left+d.left,k=g.top+d.top);var o={x:i,y:h.staff.zone.uly-h.rootStaffPos*h.staff.delta_y/2-c},p=b.page.getClosestStaff(o),q=p.ohSnap(o,d.currentWidth,{ignoreEle:h}),i=Math.round((p.zone.uly-q.y)/(p.delta_y/2)),m=q.x-d.currentWidth/2,k=k-d.currentHeight/2-(o.y-q.y),m=[m,k,m+d.currentWidth,k+d.currentHeight];h.setBoundingBox(m);o=h.rootStaffPos;$.each(h.components,function(a,b){var c=p.calcPitchFromCoords({x:q.x,y:q.y-p.delta_y/2*b.pitchDiff});b.setPitchInfo(c.pname,
c.oct)});$(h).trigger("vEraseDrawing");h.staff.removeElementByRef(h);k=p.addNeume(h);1==f.length&&$(h).trigger("vSelectDrawing");m=b.getOutputBoundingBox([h.zone.ulx,h.zone.uly,h.zone.lrx,h.zone.lry]);n={id:h.id,ulx:m[0],uly:m[1],lrx:m[2],lry:m[3]};o!=i?(n.pitchInfo=[],$.each(h.components,function(a,b){n.pitchInfo.push({pname:b.pname,oct:b.oct})}),h==p.elements[1]&&(i=b.page.getPreviousStaff(p))&&b.handleUpdatePrevCustos(h.components[0].pname,h.components[0].oct,i)):n.pitchInfo=null;k+1<p.elements.length?
n.beforeid=p.elements[k+1].id:(i=b.page.getNextStaff(p),n.beforeid=i.id);$.post(b.prefix+"/edit/"+b.fileName+"/move/neume",{data:JSON.stringify(n),csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move neume. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}else if(h instanceof Toe.Model.Division){i=d.left;k=d.top;1<f.length&&(i+=g.left,k+=g.top);o={x:i,y:k};i=b.page.getClosestStaff(o);q=i.ohSnap(o,d.currentWidth,{x:!0,y:!1});
switch(h.type){case Toe.Model.Division.Type.div_small:q.y=i.zone.uly;break;case Toe.Model.Division.Type.div_minor:q.y=i.zone.uly+(i.zone.lry-i.zone.uly)/2;break;case Toe.Model.Division.Type.div_major:q.y=i.zone.uly+(i.zone.lry-i.zone.uly)/2;break;case Toe.Model.Division.Type.div_final:q.y=i.zone.uly+(i.zone.lry-i.zone.uly)/2}h.staff.removeElementByRef(h);b.rendEng.canvas.remove(d);b.rendEng.repaint();m=q.x-d.currentWidth/2;k=q.y-d.currentHeight/2;m=[m,k,m+d.currentWidth,k+d.currentHeight];h.setBoundingBox(m);
m=i.addDivision(h);1==f.length&&h.selectDrawing();k=null;m+1<i.elements.length?k=i.elements[m+1].id:(i=b.page.getNextStaff(p),k=i.id);m=b.getOutputBoundingBox([h.zone.ulx,h.zone.uly,h.zone.lrx,h.zone.lry]);$.post(b.prefix+"/edit/"+b.fileName+"/move/division",{id:h.id,ulx:m[0],uly:m[1],lrx:m[2],lry:m[3],beforeid:k,csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move division. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}});
1<f.length&&b.rendEng.canvas.discardActiveGroup();b.rendEng.repaint()}return b.objMoving=!1}});$("#btn_delete").unbind("click");$("#btn_neumify").unbind("click");$("#btn_neumify_liquescence").unbind("click");$("#btn_ungroup").unbind("click");$("#btn_modifier").unbind("click");$("#btn_modifier").bind("click.edit",function(){return!1});$("#btn_delete").bind("click.edit",{gui:b},b.handleDelete);$("#btn_neumify").bind("click.edit",{gui:b},b.handleNeumify);$("#btn_neumify_liquescence").bind("click.edit",
{gui:b,modifier:"alt"},b.handleNeumify);$("#btn_ungroup").bind("click.edit",{gui:b},b.handleUngroup)};
Toe.View.GUI.prototype.handleDotToggle=function(a){var b=a.data.gui,c=a.data.punctum;a.preventDefault();a.stopPropagation();if(a=c.components[0].hasOrnament("dot"))c.components[0].removeOrnament("dot");else{var d=new Toe.Model.Ornament("dot",{form:"aug"});c.components[0].addOrnament(d)}c.syncDrawing();d=b.getOutputBoundingBox([c.zone.ulx,c.zone.uly,c.zone.lrx,c.zone.lry]);c={id:c.id,dotform:"aug",ulx:d[0],uly:d[1],lrx:d[2],lry:d[3],csrfmiddlewaretoken:b.csrf_token};a?$.post(b.prefix+"/edit/"+b.fileName+
"/delete/dot",c).error(function(){$("#alert > p").text("Server failed to remove dot from the punctum. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)}):$.post(b.prefix+"/edit/"+b.fileName+"/insert/dot",c).error(function(){$("#alert > p").text("Server failed to add a dot to the punctum. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});$(this).toggleClass("active");return!1};
Toe.View.GUI.prototype.handleHeadShapeChange=function(a){var b=a.data.gui,c=a.data.shape,d=a.data.punctum;a.preventDefault();a.stopPropagation();d.components[0].setHeadShape(c);"virga"==c?(d.name="Virga",d.typeid="virga"):"cavum"==c&&(d.name="Cavum",d.typeid="cavum");d.syncDrawing();a=b.getOutputBoundingBox([d.zone.ulx,d.zone.uly,d.zone.lrx,d.zone.lry]);$.post(b.prefix+"/edit/"+b.fileName+"/update/neume/headshape",{id:d.id,shape:c,ulx:a[0],uly:a[1],lrx:a[2],lry:a[3],csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to change note head shape. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)});return!1};
Toe.View.GUI.prototype.handleClefShapeChange=function(a){var b=a.data.gui,c=a.data.clef,d=a.data.shape;a.preventDefault();a.stopPropagation();if(c.shape!=d){c.setShape(d);a=c.staff.getPitchedElements({neumes:!0,custos:!1});if(0<a.length&&c.staff.getActingClefByEle(a[0])==c){var e=b.page.getPreviousStaff(c.staff);e&&b.handleUpdatePrevCustos(a[0].components[0].pname,a[0].components[0].oct,e)}a=$.map(c.staff.getPitchedElements({clef:c}),function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,
function(a,b){c.push({pname:b.pname,oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var d=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);$.post(b.prefix+"/edit/"+b.fileName+"/move/custos",{id:a.id,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3],csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}});e=b.getOutputBoundingBox([c.zone.ulx,
c.zone.uly,c.zone.lrx,c.zone.lry]);$.post(b.prefix+"/edit/"+b.fileName+"/update/clef/shape",{data:JSON.stringify({id:c.id,shape:d,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3],pitchInfo:a,csrfmiddlewaretoken:b.csrf_token}),csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to update clef shape. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});$(this).toggleClass("active")}return!1};
Toe.View.GUI.prototype.handleDelete=function(a){var b=a.data.gui;a.preventDefault();a.stopPropagation();toDelete={clefs:[],nids:[],dids:[]};var c=function(a){var c=a.eleRef,d=c.staff,e=d.getPreviousClef(c),h=d.getPitchedElements(c);d.removeElementByRef(c);d.updatePitchedElements(e);d=$.map(h,function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,function(a,b){c.push({pname:b.pname,oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var d=b.getOutputBoundingBox([a.zone.ulx,
a.zone.uly,a.zone.lrx,a.zone.lry]);$.post(b.prefix+"/edit/"+b.fileName+"/move/custos",{id:a.id,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3],csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}});toDelete.clefs.push({id:c.id,pitchInfo:d});b.rendEng.canvas.remove(a);b.rendEng.canvas.discardActiveObject()},d=function(a){var a=a.eleRef,d=a.staff.getPitchedElements({neumes:!0,custos:!1});
a.staff.removeElementByRef(a);toDelete.nids.push(a.id);b.rendEng.canvas.discardActiveObject();if(1==d.length){var c=b.page.getPreviousStaff(a.staff);c&&c.custos&&(c.custos.eraseDrawing(),c.removeElementByRef(c.custos),$.post(b.prefix+"/edit/"+b.fileName+"/delete/custos",{id:c.custos.id,csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to delete custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)}),c.custos=null)}else if(a==d[0]&&
(c=b.page.getPreviousStaff(a.staff))&&c.custos){var a=c.custos,e=d[1],d=e.components[0].pname,e=e.components[0].oct,h=c.getActingClefByEle(a),c=c.calcStaffPosFromPitch(d,e,h);a.pname=d;a.oct=e;a.setRootStaffPos(c);c=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,a.zone.lry]);$.post(b.prefix+"/edit/"+b.fileName+"/move/custos",{id:a.id,pname:d,oct:e,ulx:c[0],uly:c[1],lrx:c[2],lry:c[3],csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)})}},e=function(a){var c=a.eleRef;c.staff.removeElementByRef(c);toDelete.dids.push(c.id);b.rendEng.canvas.remove(a);b.rendEng.canvas.discardActiveObject()};if(a=b.rendEng.canvas.getActiveObject())a.eleRef instanceof Toe.Model.Clef&&a.eleRef.staff.elements[0]!=a.eleRef?c(a):a.eleRef instanceof Toe.Model.Neume?d(a):a.eleRef instanceof Toe.Model.Division&&e(a),b.rendEng.repaint();else if(a=b.rendEng.canvas.getActiveGroup())$.each(a.getObjects(),function(a,b){b.eleRef instanceof
Toe.Model.Clef&&b.eleRef.staff.elements[0]!=b.eleRef?c(b):b.eleRef instanceof Toe.Model.Neume?d(b):b.eleRef instanceof Toe.Model.Division&&e(b)}),b.rendEng.canvas.discardActiveGroup(),b.rendEng.repaint();0<toDelete.clefs.length&&$.post(b.prefix+"/edit/"+b.fileName+"/delete/clef",{data:JSON.stringify(toDelete.clefs),csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to delete clef. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});
0<toDelete.nids.length&&$.post(b.prefix+"/edit/"+b.fileName+"/delete/neume",{ids:toDelete.nids.join(","),csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to delete neume. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});0<toDelete.dids.length&&$.post(b.prefix+"/edit/"+b.fileName+"/delete/division",{ids:toDelete.dids.join(","),csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to delete division. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)});return!1};
Toe.View.GUI.prototype.handleNeumify=function(a){var b=a.data.gui,c=a.data.modifier;a.preventDefault();a.stopPropagation();var d=b.rendEng.canvas.getActiveGroup();if(d){var e=[],g=null;$.each(d.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.Neume&&(g||(g=b.eleRef.staff),b.eleRef.staff==g&&e.push(b))});if(2>e.length)return;e.sort(function(a,b){return a.eleRef.zone.ulx-b.eleRef.zone.ulx});var f=new Toe.Model.Neume({modifier:c});numPunct=0;var l=[],j=Number.MAX_VALUE,h=Number.MAX_VALUE,i=Number.MIN_VALUE;
$.each(e,function(a,c){$.merge(f.components,c.eleRef.components);numPunct+=c.eleRef.components.length;l.push(c.eleRef.id);var e=d.top+c.top;j=Math.min(j,d.left+c.left-c.currentHeight/2);h=Math.min(h,e-c.currentHeight/2);i=Math.max(i,e+c.currentHeight/2);g.removeElementByRef(c.eleRef);b.rendEng.canvas.remove(c)});f.setBoundingBox([j,h,j+numPunct*b.punctWidth,i]);a=new Toe.View.NeumeView(b.rendEng);new Toe.Ctrl.NeumeController(f,a);g.addNeume(f);var a=b.getOutputBoundingBox([f.zone.ulx,f.zone.uly,f.zone.lrx,
f.zone.lry]),c=f.typeid,k=$.map(f.components,function(a){return a.props.type}),a=JSON.stringify({nids:l.join(","),typeid:c,headShapes:k,ulx:a[0],uly:a[1],lrx:a[2],lry:a[3]});$.post(b.prefix+"/edit/"+b.fileName+"/neumify",{data:a,csrfmiddlewaretoken:b.csrf_token},function(a){f.id=a.id}).error(function(){$("#alert > p").text("Server failed to neumify selected neumes. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});b.rendEng.canvas.discardActiveGroup();$(f).trigger("vSelectDrawing");
b.rendEng.repaint()}return!1};
Toe.View.GUI.prototype.handleUngroup=function(a){var b=a.data.gui;a.preventDefault();a.stopPropagation();var c=[];(a=b.rendEng.canvas.getActiveObject())?a.eleRef instanceof Toe.Model.Neume&&1<a.eleRef.components.length&&c.push(a):(a=b.rendEng.canvas.getActiveGroup())&&$.each(a.getObjects(),function(a,b){b.eleRef instanceof Toe.Model.Neume&&1<b.eleRef.components.length&&c.push(b)});var d=[],e=[],g=[];$.each(c,function(a,c){d.push(c.eleRef.id);var j=[],h=c.eleRef.zone.ulx;c.eleRef.staff.removeElementByRef(c.eleRef);
b.rendEng.canvas.remove(c);$.each(c.eleRef.components,function(a,d){var e=new Toe.Model.Neume;e.components.push(d);var f=c.eleRef.staff.zone.uly-(c.eleRef.rootStaffPos+d.pitchDiff)*c.eleRef.staff.delta_y/2-b.punctHeight/2;e.setBoundingBox([h+a*b.punctWidth,f,h+(a+1)*b.punctWidth,f+b.punctHeight]);f=new Toe.View.NeumeView(b.rendEng);new Toe.Ctrl.NeumeController(e,f);c.eleRef.staff.addNeume(e);f=b.getOutputBoundingBox([e.zone.ulx,e.zone.uly,e.zone.lrx,e.zone.lry]);j.push({ulx:f[0],uly:f[1],lrx:f[2],
lry:f[3]});g.push(e)});e.push(j)});a=JSON.stringify({nids:d.join(","),bbs:e});$.post(b.prefix+"/edit/"+b.fileName+"/ungroup",{data:a,csrfmiddlewaretoken:b.csrf_token},function(a){var b=a.nids,b=$.map(b,function(a){return a});$.each(g,function(a,c){c.id=b[a]})}).error(function(){$("#alert > p").text("Server failed to ungroup selected neumes. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)});b.rendEng.canvas.discardActiveObject();b.rendEng.canvas.discardActiveGroup();
b.rendEng.repaint();return!1};
Toe.View.GUI.prototype.handleInsert=function(a){var b=a.data.gui,c=a.data.parentDivId;a.preventDefault();a.stopPropagation();$("#sidebar-edit").remove();$("#btn_delete").unbind("click.edit");$("#btn_neumify").unbind("click.edit");b.rendEng.unObserve("mouse:down");b.rendEng.unObserve("mouse:up");b.rendEng.unObserve("object:moving");b.rendEng.unObserve("object:selected");b.rendEng.unObserve("selection:cleared");0==$("#sidebar-insert").length&&$(c).append('<span id="sidebar-insert"><br/><li class="divider"></li><li class="nav-header">Insert</li>\n<li><div class="btn-group" data-toggle="buttons-radio"><button id="rad_punctum" class="btn"><i class="icon-bookmark icon-black"></i> Punctum</button>\n<button id="rad_division" class="btn"><b>||</b> Division</button>\n<button id="rad_clef" class="btn">Clef</button>\n</div>\n</li>\n</span>');$("#rad_punctum").unbind("click");
$("#rad_division").unbind("click");$("#rad_clef").unbind("click");$("#rad_punctum").bind("click.insert",{gui:b},b.handleInsertPunctum);$("#rad_division").bind("click.insert",{gui:b},b.handleInsertDivision);$("#rad_clef").bind("click.insert",{gui:b},b.handleInsertClef);$("#rad_punctum").trigger("click");return!1};
Toe.View.GUI.prototype.handleInsertPunctum=function(a){var b=a.data.gui;a.preventDefault();a.stopPropagation();b.rendEng.unObserve("mouse:move");b.rendEng.unObserve("mouse:up");$("#menu_insertdivision").remove();$("#menu_insertclef").remove();b.divisionDwg&&b.rendEng.canvas.remove(b.divisionDwg);b.clefDwg&&b.rendEng.canvas.remove(b.clefDwg);0==$("#menu_insertpunctum").length&&$("#sidebar-insert").append('<span id="menu_insertpunctum"><br/><li class="nav-header">Ornamentation</li>\n<li><div class="btn-group" data-toggle="buttons-checkbox">\n<button id="chk_dot" class="btn">&#149; Dot</button>\n<button id="chk_horizepisema" class="btn"><i class="icon-resize-horizontal"></i> Episema</button>\n<button id="chk_vertepisema" class="btn"><i class="icon-resize-vertical"></i> Episema</button>\n</div></li></span>');
var c=!1,d=function(a){var d={modify:[],fixed:[]},f=null,l=b.rendEng.getGlyph("punctum");a?f={left:-50,top:-50}:(f={left:b.punctDwg.left,top:b.punctDwg.top},c&&(a=b.rendEng.getGlyph("dot").clone().set({left:f.left+b.punctWidth,top:f.top,opacity:0.6}),d.modify.push(a)));f=l.clone().set({left:f.left,top:f.top,opacity:0.6});d.modify.push(f);b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.punctDwg=b.rendEng.draw(d,{group:!0,selectable:!1,repaint:!0})[0]};d(!0);b.rendEng.canvas.observe("mouse:move",
function(a){a=b.rendEng.canvas.getPointer(a.memo.e);b.punctDwg.left=a.x-b.punctDwg.currentWidth/4;b.punctDwg.top=a.y-b.punctDwg.currentHeight/4;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(){var a={x:b.punctDwg.left,y:b.punctDwg.top},d=b.page.getClosestStaff(a),f=new Toe.Model.Neume,a=d.ohSnap(a,b.punctDwg.currentWidth),l=a.x-b.punctDwg.currentWidth/2,j=a.y-b.punctDwg.currentHeight/2;f.setBoundingBox([l,j,l+b.punctDwg.currentWidth,j+b.punctDwg.currentHeight]);var a=d.calcPitchFromCoords(a),
l=a.pname,j=a.oct,a={pname:l,oct:j,csrfmiddlewaretoken:b.csrf_token},h=[];c&&(h.push(new Toe.Model.Ornament("dot",{form:"aug"})),a.dotform="aug");f.addComponent("punctum",l,j,{ornaments:h});h=new Toe.View.NeumeView(b.rendEng);new Toe.Ctrl.NeumeController(f,h);h=d.addNeume(f);if(1==h){var i=b.page.getPreviousStaff(d);i&&b.handleUpdatePrevCustos(l,j,i)}l=b.getOutputBoundingBox([f.zone.ulx,f.zone.uly,f.zone.lrx,f.zone.lry]);a.ulx=l[0];a.uly=l[1];a.lrx=l[2];a.lry=l[3];if(h+1<d.elements.length)a.beforeid=
d.elements[h+1].id;else if(d=b.page.getNextStaff(d))a.beforeid=d.id;$.post(b.prefix+"/edit/"+b.fileName+"/insert/neume",a,function(a){f.id=a.id}).error(function(){$("#alert > p").text("Server failed to insert neume. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})});$("#chk_dot").bind("click.insert",function(){c=c?!1:!0;d(!1);return!1});return!1};
Toe.View.GUI.prototype.handleInsertDivision=function(a){var b=a.data.gui;a.preventDefault();a.stopPropagation();b.rendEng.unObserve("mouse:move");b.rendEng.unObserve("mouse:up");b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.clefDwg&&b.rendEng.canvas.remove(b.clefDwg);$("#menu_insertpunctum").remove();$("#menu_insertclef").remove();0==$("#menu_insertdivision").length&&$("#sidebar-insert").append('<span id="menu_insertdivision"><br/>\n<li class="nav-header">Division Type</li>\n<li><div class="btn-group" data-toggle="buttons-radio">\n<button id="rad_small" class="btn">Small</button>\n<button id="rad_minor" class="btn">Minor</button>\n<button id="rad_major" class="btn">Major</button>\n<button id="rad_final" class="btn">Final</button>\n</div>\n</li>\n</span>');
var c=null,d=null;b.rendEng.canvas.observe("mouse:move",function(a){a=b.rendEng.canvas.getPointer(a.memo.e);d=b.page.getClosestStaff(a);var g={strokeWidth:4,opacity:0.6};switch(c){case "div_small":a.y=d.zone.uly;if(!b.divisionDwg){var f=d.zone.uly-d.delta_y/2,l=d.zone.uly+d.delta_y/2,j=a.x;b.divisionDwg=b.rendEng.createLine([j,f,j,l],g);b.rendEng.draw({fixed:[b.divisionDwg],modify:[]},{selectable:!1,opacity:0.6})}break;case "div_minor":a.y=d.zone.uly+(d.zone.lry-d.zone.uly)/2;b.divisionDwg||(f=d.zone.uly+
d.delta_y/2,l=f+2*d.delta_y,j=a.x,b.divisionDwg=b.rendEng.createLine([j,f,j,l],g),b.rendEng.draw({fixed:[b.divisionDwg],modify:[]},{selectable:!1,opacity:0.6}));break;case "div_major":a.y=d.zone.uly+(d.zone.lry-d.zone.uly)/2;b.divisionDwg||(f=d.zone.uly,l=d.zone.lry,j=a.x,b.divisionDwg=b.rendEng.createLine([j,f,j,l],g),b.rendEng.draw({fixed:[b.divisionDwg],modify:[]},{selectable:!1,opacity:0.6}));break;case "div_final":if(a.y=d.zone.uly+(d.zone.lry-d.zone.uly)/2,!b.divisionDwg){var f=d.zone.uly,l=
d.zone.lry,j=a.x,h=a.x+b.punctWidth,j=b.rendEng.createLine([j,f,j,l],g),g=b.rendEng.createLine([h,f,h,l],g);b.divisionDwg=b.rendEng.draw({fixed:[j,g],modify:[]},{group:!0,selectable:!1,opacity:0.6})[0]}}g=a.x-b.divisionDwg.currentWidth/2;f=a.x+b.divisionDwg.currentWidth/2;d.elements[0]instanceof Toe.Model.Clef&&g<=d.elements[0].zone.lrx?a.x=d.elements[0].zone.lrx+b.divisionDwg.currentWidth/2+1:g<=d.zone.ulx&&(a.x=d.zone.ulx+b.divisionDwg.currentWidth/2+1);d.custos&&f>=d.custos.zone.ulx?a.x=d.custos.zone.ulx-
b.divisionDwg.currentWidth/2-3:f>=d.zone.lrx&&(a.x=d.zone.lrx-b.divisionDwg.currentWidth/2-3);b.divisionDwg.left=a.x;b.divisionDwg.top=a.y;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(){var a=d.ohSnap({x:b.divisionDwg.left,y:b.divisionDwg.top},b.divisionDwg.currentWidth),g=new Toe.Model.Division(c),f=a.x-b.divisionDwg.currentWidth/2,a=a.y-b.divisionDwg.currentHeight/2,a=[f,a,f+b.divisionDwg.currentWidth,a+b.divisionDwg.currentHeight];g.setBoundingBox(a);f=new Toe.View.DivisionView(b.rendEng);
new Toe.Ctrl.DivisionController(g,f);f=d.addDivision(g);a=b.getOutputBoundingBox(a);a={type:g.key.slice(4),ulx:a[0],uly:a[1],lrx:a[2],lry:a[3],csrfmiddlewaretoken:b.csrf_token};f+1<d.elements.length?a.beforeid=d.elements[f+1].id:(f=b.page.getNextStaff(d),a.beforeid=f.id);$.post(b.prefix+"/edit/"+b.fileName+"/insert/division",a,function(a){g.id=a.id}).error(function(){$("#alert > p").text("Server failed to insert division. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})});
$("#rad_small").bind("click.insert",function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);c="div_small";return!1});$("#rad_minor").bind("click.insert",function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);c="div_minor";return!1});$("#rad_major").bind("click.insert",function(){b.divisionDwg&&(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);c="div_major";return!1});$("#rad_final").bind("click.insert",function(){b.divisionDwg&&
(b.rendEng.canvas.remove(b.divisionDwg),b.divisionDwg=null);c="div_final";return!1});$("#rad_small").trigger("click");return!1};
Toe.View.GUI.prototype.handleInsertClef=function(a){var b=a.data.gui;a.preventDefault();a.stopPropagation();b.rendEng.unObserve("mouse:move");b.rendEng.unObserve("mouse:up");b.punctDwg&&b.rendEng.canvas.remove(b.punctDwg);b.divisionDwg&&b.rendEng.canvas.remove(b.divisionDwg);$("#menu_insertpunctum").remove();$("#menu_insertdivision").remove();0==$("#menu_insertclef").length&&$("#sidebar-insert").append('<span id="menu_insertclef"><br/>\n<li class="nav-header">Clef Type</li>\n<li><div class="btn-group" data-toggle="buttons-radio">\n<button id="rad_doh" class="btn">C</button>\n<button id="rad_fah" class="btn">F</button>\n</div>\n</li>\n</span>');
var c=null;b.rendEng.canvas.observe("mouse:move",function(a){var a=b.rendEng.canvas.getPointer(a.memo.e),e=0,g=0;"c"==c?e=b.clefDwg.currentWidth/4:(e=b.clefDwg.currentWidth/8,g=b.clefDwg.currentHeight/8);b.clefDwg.left=a.x-e;b.clefDwg.top=a.y+g;b.rendEng.repaint()});b.rendEng.canvas.observe("mouse:up",function(){var a={x:b.clefDwg.left,y:b.clefDwg.top};"f"==c&&(a.x-=b.clefDwg.currentWidth/8,a.y-=b.clefDwg.currentHeight/8);var e=b.page.getClosestStaff(a),g=e.ohSnap(a,b.clefDwg.currentWidth),a=Math.round((e.zone.uly-
g.y)/(e.delta_y/2)),f=new Toe.Model.Clef(c,{staffPos:a}),l=g.x-b.clefDwg.currentWidth/2,g=g.y-b.clefDwg.currentHeight/2;f.setBoundingBox([l,g,l+b.clefDwg.currentWidth,g+b.clefDwg.currentHeight]);l=new Toe.View.ClefView(b.rendEng);new Toe.Ctrl.ClefController(f,l);l=e.addClef(f);a=e.props.numLines+a/2;g=b.getOutputBoundingBox([f.zone.ulx,f.zone.uly,f.zone.lrx,f.zone.lry]);a={shape:c,line:a,ulx:g[0],uly:g[1],lrx:g[2],lry:g[3]};l+1<e.elements.length?a.beforeid=e.elements[l+1].id:(l=b.page.getNextStaff(e),
a.beforeid=l.id);l=e.getPitchedElements({neumes:!0,custos:!1});0<l.length&&e.getActingClefByEle(l[0])==f&&(g=b.page.getPreviousStaff(e))&&b.handleUpdatePrevCustos(l[0].components[0].pname,l[0].components[0].oct,g);a.pitchInfo=$.map(e.getPitchedElements({clef:f}),function(a){if(a instanceof Toe.Model.Neume){var c=[];$.each(a.components,function(a,b){c.push({pname:b.pname,oct:b.oct})});return{id:a.id,noteInfo:c}}if(a instanceof Toe.Model.Custos){var d=b.getOutputBoundingBox([a.zone.ulx,a.zone.uly,a.zone.lrx,
a.zone.lry]);$.post(b.prefix+"/edit/"+b.fileName+"/move/custos",{id:a.id,ulx:d[0],uly:d[1],lrx:d[2],lry:d[3],csrfmiddlewaretoken:b.csrf_token}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}});$.post(b.prefix+"/edit/"+b.fileName+"/insert/clef",{data:JSON.stringify(a),csrfmiddlewaretoken:b.csrf_token},function(a){f.id=a.id}).error(function(){$("#alert > p").text("Server failed to insert clef. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)})});$("#rad_doh").unbind("click");$("#rad_fah").unbind("click");$("#rad_doh").bind("click.insert",function(){if(!$(this).hasClass("active")){var a={left:-50,top:-50};b.clefDwg&&(b.rendEng.canvas.remove(b.clefDwg),a={left:b.clefDwg.left,top:b.clefDwg.top});a=b.rendEng.getGlyph("c_clef").clone().set($.extend(a,{opacity:0.6}));b.clefDwg=b.rendEng.draw({fixed:[],modify:[a]},{opacity:0.6,selectable:!1,repaint:!0})[0];c="c"}return!1});$("#rad_fah").bind("click.insert",
function(){if(!$(this).hasClass("active")){var a={left:-50,top:-50};b.clefDwg&&(b.rendEng.canvas.remove(b.clefDwg),a={left:b.clefDwg.left,top:b.clefDwg.top});a=b.rendEng.getGlyph("f_clef").clone().set($.extend(a,{opacity:0.6}));b.clefDwg=b.rendEng.draw({fixed:[],modify:[a]},{opacity:0.6,selectable:!1,repaint:!0})[0];c="f"}return!1});$("#rad_doh").trigger("click");return!1};
Toe.View.GUI.prototype.handleUpdatePrevCustos=function(a,b,c){var d=c.custos;if(d){d.setRootNote(a,b);var e=c.getActingClefByEle(d);d.setRootStaffPos(c.calcStaffPosFromPitch(a,b,e));e=this.getOutputBoundingBox([d.zone.ulx,d.zone.uly,d.zone.lrx,d.zone.lry]);$.post(this.prefix+"/edit/"+this.fileName+"/move/custos",{id:d.id,pname:a,oct:b,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3],csrfmiddlewaretoken:gui.csrf_token}).error(function(){$("#alert > p").text("Server failed to move custos. Client and server are not synchronized.");
$("#alert").animate({opacity:1},100)})}else{var g=new Toe.Model.Custos(a,b),d=c.zone.lrx-gui.punctWidth/2,e=c.zone.uly;g.setBoundingBox([d,e,d+gui.punctWidth,e+gui.punctHeight]);d=new Toe.View.CustosView(gui.rendEng);new Toe.Ctrl.CustosController(g,d);c.setCustos(g);e=this.getOutputBoundingBox([g.zone.ulx,g.zone.uly,g.zone.lrx,g.zone.lry]);a={id:g.id,pname:a,oct:b,ulx:e[0],uly:e[1],lrx:e[2],lry:e[3],csrfmiddlewaretoken:gui.csrf_token};if(c=gui.page.getNextStaff(c))a.beforeid=c.id;$.post(this.prefix+
"/edit/"+this.fileName+"/insert/custos",a,function(a){g.id=a.id}).error(function(){$("#alert > p").text("Server failed to insert custos. Client and server are not synchronized.");$("#alert").animate({opacity:1},100)})}};Toe.View.GUI.prototype.getOutputBoundingBox=function(a){gui=this;return $.map(a,function(a){return Math.round(a/gui.page.scale)})};Toe.Model.NeumeComponent=function(a,b,c){this.props={type:"punctum",ornaments:[],interact:!0};$.extend(this.props,c);this.setHeadShape(this.props.type);this.setPitchInfo(a,b);this.pitchDiff=null};Toe.Model.NeumeComponent.prototype.constructor=Toe.Model.NeumeComponent;Toe.Model.NeumeComponent.Type={punctum:"Punctum",virga:"Virga",cavum:"Cavum",punctum_inclinatum:"Punctum Inclinatum",punctum_inclinatum_parvum:"Punctum Inclinatum Parva",quilisma:"Quilisma"};
Toe.Model.NeumeComponent.prototype.setHeadShape=function(a){this.props.type=a.toLowerCase();this.props.name=Toe.Model.NeumeComponent.Type[this.props.type];if(void 0==this.props.name)throw Error("NeumeComponent: undefined head shape");};Toe.Model.NeumeComponent.prototype.setPitchDifference=function(a){this.pitchDiff=a};Toe.Model.NeumeComponent.prototype.setPitchInfo=function(a,b){this.pname=a;this.oct=b};
Toe.Model.NeumeComponent.prototype.hasOrnament=function(a){return $.grep(this.props.ornaments,function(b){return b.key==a.toLowerCase()}).length};Toe.Model.NeumeComponent.prototype.addOrnament=function(a){if(!(a instanceof Toe.Model.Ornament))throw Error("NeumeComponent: Invalid ornament");this.hasOrnament(a.key)||this.props.ornaments.push(a)};Toe.Model.NeumeComponent.prototype.removeOrnament=function(a){this.props.ornaments=$.grep(this.props.ornaments,function(b){return b.key==a.toLowerCase()},!0)};(function(a){var b=function(b,d){var e=a(b),g,f,l,j=a.extend({},{autoLoad:!0,debug:!1,prefix:"neon",pageid:"",meipath:"",bgimgpath:"",glyphpath:"",width:1E3,orig_width:1E3,orig_height:1E3,height:1E3,backgroundImageOpacity:0},d);a.extend(j,{canvasid:"neon-canvas"});var h=function(b){function c(d){var e=parseInt(a(d).attr("ulx")),f=parseInt(a(d).attr("uly")),g=parseInt(a(d).attr("lrx")),d=parseInt(a(d).attr("lry"));return a.map([e,f,g,d],function(a){return Math.round(b.scale*a)})}var d=a(g).find("surface")[0],
e=a("clef, sb",g),h=[];a(e).each(function(b,c){a(c).is("sb")&&h.push(b)});var i=a("neume, sb",g),k=[];a(i).each(function(b,c){a(c).is("sb")&&k.push(b)});var l=a("division, sb",g),m=[];a(l).each(function(b,c){a(c).is("sb")&&m.push(b)});var w=a("custos, sb",g),u=[];a(w).each(function(b,c){a(c).is("sb")&&u.push(b)});a("sb",g).each(function(r,v){j.debug&&console.log("system "+(r+1));var s=a(v).attr("systemref"),s=a(a(g).find("system[xml\\:id="+s+"]")[0]).attr("facs"),s=a(d).find("zone[xml\\:id="+s+"]")[0],
s=c(s);j.debug&&f.outlineBoundingBox(s,{fill:"blue"});var t=new Toe.Model.Staff(s);t.setID(a(v).attr("xml:id"));0==r&&f.calcScaleFromStaff(t,{overwrite:!0});s=new Toe.View.StaffView(f);new Toe.Ctrl.StaffController(t,s);b.addStaff(t);a(e).slice(h[r]+1,h[r+1]).each(function(b,e){var g=a(e).attr("shape"),h=parseInt(a(e).attr("line")),h=2*-(t.props.numLines-h),i=a(e).attr("facs"),i=a(d).find("zone[xml\\:id="+i+"]")[0],i=c(i);j.debug&&f.outlineBoundingBox(i,{fill:"red"});g=new Toe.Model.Clef(g,{staffPos:h});
g.setID(a(e).attr("xml:id"));g.setBoundingBox(i);h=new Toe.View.ClefView(f);new Toe.Ctrl.ClefController(g,h);t.addClef(g);j.debug&&console.log("clef: "+g.name)});a(i).slice(k[r]+1,k[r+1]).each(function(b,e){var g=new Toe.Model.Neume,h=a(d).find("zone[xml\\:id="+a(e).attr("facs")+"]")[0],h=c(h);j.debug&&f.outlineBoundingBox(h,{fill:"green"});g.neumeFromMei(e,h,t);h=new Toe.View.NeumeView(f);new Toe.Ctrl.NeumeController(g,h);t.addNeume(g);j.debug&&console.log("neume: "+g.name)});a(l).slice(m[r]+1,m[r+
1]).each(function(b,e){var g=a(d).find("zone[xml\\:id="+a(e).attr("facs")+"]")[0],h=c(g);j.debug&&f.outlineBoundingBox(h,{fill:"yellow"});var g="div_"+a(e).attr("form"),i=new Toe.Model.Division(g);i.setBoundingBox(h);i.setID(a(e).attr("xml:id"));h=new Toe.View.DivisionView(f);new Toe.Ctrl.DivisionController(i,h);t.addDivision(i);j.debug&&console.log("division: "+g)});a(w).slice(u[r]+1,u[r+1]).each(function(b,e){var g=a(d).find("zone[xml\\:id="+a(e).attr("facs")+"]")[0],g=c(g);j.debug&&f.outlineBoundingBox(g,
{fill:"purple"});var h=a(e).attr("pname"),i=parseInt(a(e).attr("oct")),h=new Toe.Model.Custos(h,i);h.setBoundingBox(g);h.setID(a(e).attr("xml:id"));g=new Toe.View.CustosView(f);new Toe.Ctrl.CustosController(h,g);t.setCustos(h);j.debug&&console.log("custos")})});f.repaint()},i=function(b){console.log("loading SVG glyphs ...");return a.get(j.glyphpath,function(c){var d={};a(c).find("svg").each(function(b,c){var e=a("<lol>").append(a(c).clone()).remove().html();fabric.loadSVGFromString(e,function(b){gID=
a(c).find("path").attr("id");d[gID]=new Toe.Model.Glyph(gID,b[0])})});b.setGlyphs(d)})},k=function(){var b=a.Deferred();j.autoLoad&&j.meipath?a.get(j.meipath,function(a){console.log("loading MEI file ...");g=a;b.resolve()}):b.resolve();return b.promise()},m=function(){var b=new Toe.Model.Page,c=a("<canvas>").attr("id",j.canvasid),d=[j.width,j.height];j.autoLoad&&(d=j.bgimgpath?[j.orig_width,j.orig_height]:b.calcDimensions(a(g).find("zone")),b.setPageScale(j.width/j.orig_width));b.setDimensions(Math.round(d[0]),
Math.round(d[1]));c.attr("width",b.width);c.attr("height",b.height);c.attr("style","border: 4px black solid;");e.prepend(c);c={renderOnAddition:!1};j.bgimgpath&&a.extend(c,{backgroundImage:j.bgimgpath,backgroundImageOpacity:j.backgroundImageOpacity,backgroundImageStretch:!1});f.setCanvas(new fabric.Canvas(j.canvasid,c));if(j.debug){var i=a("<div>").attr("id","fps");i.attr("style","color: red; font-size: 200%");e.prepend(i);f.canvas.onFpsUpdate=function(b){a(i).html("FPS: "+b)}}c=new Toe.View.PageView(f);
new Toe.Ctrl.PageController(b,c);j.autoLoad&&g&&h(b);new Toe.View.GUI(j.prefix,j.pageid,f,b,j.csrf_token,{sldr_bgImgOpacity:j.bgimgpath,initBgImgOpacity:j.backgroundImageOpacity});console.log("Neon.js ready ("+(new Date-l)+"ms)")};(function(){l=new Date;f=new Toe.View.RenderEngine;a.when(i(f),k()).then(m,function(){console.log("Failure to load the mei file, glyphs, or background image")})})()};a.fn.neon=function(c){return this.each(function(){var d=a(this);if(!d.data("neon")){var e=new b(this,c);
d.data("neon",e)}})}})(jQuery);function SearchTree(){this.rootNode=null;this.numNodes=0}function SearchTreeNode(a){this.payload=a;this.children={};this.numChildren=0}
SearchTree.prototype={setRootNode:function(a){this.rootNode=a},insert:function(a,b){if(!this.rootNode)if(a.length)this.setRootNode(new SearchTreeNode(null)),this.numNodes++;else{this.setRootNode(new SearchTreeNode(b));this.numNodes++;return}this.rootNode.insert(a,b)},remove:function(a){this.rootNode.remove(a)},destroyTree:function(){this.rootNode=null;this.numNodes=0},search:function(a,b){for(var c=this.rootNode,d=0;d<a.length;d++){var e=a[d];if(e in c.children)c=c.children[e];else return b?{result:c.payload,
prefix:!0}:null}return{result:c.payload,prefix:!1}},stringify:function(){return JSON.stringify(this)},populateFromJSON:function(a){a=JSON.parse(a);this.rootNode=a.rootNode;this.numNodes=a.numNodes}};
SearchTreeNode.prototype={insert:function(a,b){var c=a.splice(0,1);a.length?(c in this.children||(this.children[c]=new SearchTreeNode(null),this.numChildren++),this.children[c].insert(a,b)):c in this.children?this.children[c].payload=b:(this.children[c]=new SearchTreeNode(b),this.numChildren++)},remove:function(a){var b=a.splice(0,1);a.length?b in this.children&&this.children[b].remove(a):b in this.children&&(this.children[b].numChildren?this.children[b].payload=null:(delete this.children[b],this.numChildren--))}};Toe.Model.Neume=function(a){this.zone={};this.props={modifier:null,interact:!0};$.extend(this.props,a);this.props.modifier=Toe.Model.Neume.Modifier[this.props.modifier];void 0==this.props.modifier&&(this.props.modifier=null);this.staff=this.id=this.rootStaffPos=this.neumePrefix=this.typeid=this.name=null;this.components=[]};Toe.Model.Neume.prototype.constructor=Toe.Model.Neume;Toe.Model.Neume.Modifier={alt:"liquescence",shift:"variant 2",ctrl:"variant 3",ctrl_shift:"variant 4"};
Toe.Model.Neume.SearchTree=new SearchTree;Toe.Model.Neume.SearchTree.populateFromJSON('{"rootNode":{"payload":{"typeid":"punctum","name":"Punctum"},"children":{"0":{"payload":{"typeid":"distropha","name":"Distropha"},"children":{"0":{"payload":{"typeid":"tristropha","name":"Tristropha"},"children":{},"numChildren":0}},"numChildren":1},"1":{"payload":{"typeid":"podatus","name":"Podatus"},"children":{"1":{"payload":{"typeid":"scandicus.1","name":"Scandicus"},"children":{"1":{"payload":{"typeid":"scandicus.2","name":"Scandicus"},"children":{"1":{"payload":{"typeid":"scandicus.3","name":"Scandicus"},"children":{"1":{"payload":{"typeid":"scandicus.4","name":"Scandicus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"scandicus.flexus.3","name":"Scandicus Flexus"},"children":{},"numChildren":0}},"numChildren":2},"-1":{"payload":{"typeid":"scandicus.flexus.2","name":"Scandicus Flexus"},"children":{},"numChildren":0}},"numChildren":2},"-1":{"payload":{"typeid":"scandicus.flexus.1","name":"Scandicus Flexus"},"children":{"-1":{"payload":{"typeid":"scandicus.subpunctis.1","name":"Scandicus Subpunctis"},"children":{"-1":{"payload":{"typeid":"scandicus.subpunctis.2","name":"Scandicus Subpunctis"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":1}},"numChildren":2},"-1":{"payload":{"typeid":"torculus","name":"Torculus"},"children":{"1":{"payload":{"typeid":"torculus.resupinus.1","name":"Torculus Resupinus"},"children":{"-1":{"payload":{"typeid":"torculus.resupinus.2","name":"Torculus Resupinus"},"children":{"-1":{"payload":{"typeid":"torculus.resupinus.3","name":"Torculus Resupinus"},"children":{"-1":{"payload":{"typeid":"torculus.resupinus.4","name":"Torculus Resupinus"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":1}},"numChildren":1},"-1":{"payload":{"typeid":"podatus.subpunctis.1","name":"Podatus Subpunctis"},"children":{"1":{"payload":{"typeid":"podatus.subpunctis.resupinus.1","name":"Podatus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"podatus.subpunctis.2","name":"Podatus Subpunctis"},"children":{"1":{"payload":{"typeid":"podatus.subpunctis.resupinus.2","name":"Podatus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"podatus.subpunctis.3","name":"Podatus Subpunctis"},"children":{"1":{"payload":{"typeid":"podatus.resupinus.3","name":"Podatus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"podatus.subpunctis.4","name":"Podatus Subpunctis"},"children":{},"numChildren":0}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":2},"-1":{"payload":{"typeid":"clivis","name":"Clivis"},"children":{"1":{"payload":{"typeid":"porrectus","name":"Porrectus"},"children":{"1":{"payload":{"typeid":"compound.2","name":"Compound Neume 2"},"children":{"-1":{"payload":{"typeid":"compound.1","name":"Compound"},"children":{},"numChildren":0}},"numChildren":1},"-1":{"payload":{"typeid":"porrectus.flexus","name":"Porrectus Flexus"},"children":{"-1":{"payload":{"typeid":"porrectus.subpunctis.1","name":"Porrectus Subpunctis"},"children":{"1":{"payload":{"typeid":"porrectus.subpunctis.resupinus.1","name":"Porrectus Subpunctis Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"porrectus.subpunctis.2","name":"Porrectus Subpunctis"},"children":{"1":{"payload":{"typeid":"porrectus.subpunctis.resupinus.2","name":"Porrectus Subpunctis Resupinus"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":2}},"numChildren":1}},"numChildren":2},"-1":{"payload":{"typeid":"climacus.1","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.1","name":"Climacus Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"climacus.2","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.2","name":"Climacus Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"climacus.3","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.3","name":"Climacus Resupinus"},"children":{},"numChildren":0},"-1":{"payload":{"typeid":"climacus.4","name":"Climacus"},"children":{"1":{"payload":{"typeid":"climacus.resupinus.4","name":"Climacus Resupinus"},"children":{},"numChildren":0}},"numChildren":1}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":2}},"numChildren":3},"numNodes":1}');
Toe.Model.Neume.prototype.setID=function(a){this.id=a};Toe.Model.Neume.prototype.setStaff=function(a){if(!(a instanceof Toe.Model.Staff))throw Error("Neume: invalid staff reference");this.staff=a};Toe.Model.Neume.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Neume: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3]};
Toe.Model.Neume.prototype.getRootPitchInfo=function(){var a=null,b=null;0<this.components.length&&(a=this.components[0].pname,b=this.components[0].oct);return{pname:a,oct:b}};Toe.Model.Neume.prototype.setRootStaffPos=function(a){this.rootStaffPos=a};
Toe.Model.Neume.prototype.neumeFromMei=function(a,b){if("neume"!=a.nodeName.toLowerCase())throw Error("neumeFromMei: invalid neume data");this.id=$(a).attr("xml:id");var c=$(a).attr("name").toLowerCase();"epiphonus"==c?(c="podatus",this.props.modifier=Toe.Model.Neume.Modifier.alt):"cephalicus"==c&&(c="clivis",this.props.modifier=Toe.Model.Neume.Modifier.alt);this.setBoundingBox(b);var d=this;$(a).find("note").each(function(a,b){var f=$(b).attr("pname"),l=parseInt($(b).attr("oct")),j="punctum";$(this).parent().attr("inclinatum")==
"true"?j=$(this).parent().attr("deminutus")=="true"?"punctum_inclinatum_parvum":"punctum_inclinatum":$(this).parent().attr("quilisma")=="true"?j="quilisma":c=="virga"?j="virga":c=="cavum"&&(j="cavum");var h=[],i=$("> dot",this).attr("form");i&&h.push(new Toe.Model.Ornament("dot",{form:i}));d.addComponent(j,f,l,{ornaments:h})});return this};
Toe.Model.Neume.prototype.addComponent=function(a,b,c,d){opts={ncInd:this.components.length,ornaments:[]};$.extend(opts,d);a=new Toe.Model.NeumeComponent(b,c,{type:a,ornaments:opts.ornaments});this.components.splice(opts.ncInd,0,a)};Toe.Model.Neume.prototype.getDifferences=function(){for(var a=[],b=1;b<this.components.length;b++)a.push(this.components[b].pitchDiff);return a};
Toe.Model.Neume.prototype.diffToMelodicMove=function(){var a=this.getDifferences(),b=0;return a=$.map(a,function(a){var d=0;a>b?d=1:a<b&&(d=-1);b=a;return d})};
Toe.Model.Neume.prototype.deriveName=function(a){var b={enforceHeadShapes:!0};$.extend(b,a);if(0==this.components.length)return"unknown";a=this.diffToMelodicMove();a=Toe.Model.Neume.SearchTree.search(a,!0);a.prefix?(this.neumePrefix=a.result.typeid,this.name="Compound",this.typeid="compound"):(this.neumePrefix=null,this.name=a.result.name,this.typeid=a.result.typeid);"punctum"==this.typeid&&"virga"==this.components[0].props.type?(this.name="Virga",this.typeid="virga"):"distropha"==this.typeid&&"virga"==
this.components[0].props.type?(this.name="Bivirga",this.typeid="bivirga"):"tristropha"==this.typeid&&"virga"==this.components[0].props.type?(this.name="Trivirga",this.typeid="trivirga"):"Punctum"==this.name&&"cavum"==this.components[0].props.type?(this.name="Cavum",this.typeid="cavum"):"Podatus"==this.name&&this.props.modifier==Toe.Model.Neume.Modifier.alt?(this.name="Epiphonus",this.typeid="epiphonus"):"Clivis"==this.name&&this.props.modifier==Toe.Model.Neume.Modifier.alt&&(this.name="Cephalicus",
this.typeid="cephalicus");b.enforceHeadShapes&&this.enforceHeadShapes();return this.name};
Toe.Model.Neume.prototype.enforceHeadShapes=function(){switch(this.typeid){case "climacus.1":case "climacus.2":case "climacus.3":case "climacus.4":for(var a=1;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "climacus.resupinus.1":case "climacus.resupinus.2":case "climacus.resupinus.3":case "climacus.resupinus.4":for(a=1;a<this.components.length-1;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "podatus.subpunctis.1":case "podatus.subpunctis.2":case "podatus.subpunctis.3":case "podatus.subpunctis.4":for(a=
2;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "podatus.subpunctis.resupinus.1":case "podatus.subpunctis.resupinus.2":case "podatus.subpunctis.resupinus.3":for(a=2;a<this.components.length-1;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "scandicus.subpunctis.1":case "scandicus.subpunctis.2":for(a=3;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "porrectus.subpunctis.1":case "porrectus.subpunctis.2":for(a=
3;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "porrectus.subpunctis.resupinus.1":case "porrectus.subpunctis.resupinus.2":for(a=3;a<this.components.length-1;a++)this.components[a].setHeadShape("punctum_inclinatum");break;case "torculus.resupinus.3":case "torculus.resupinus.4":for(a=4;a<this.components.length;a++)this.components[a].setHeadShape("punctum_inclinatum")}};
Toe.Model.Neume.prototype.syncDrawing=function(){this.deriveName();$(this).trigger("vUpdateDrawing",[this])};Toe.Ctrl.NeumeController=function(a,b){$(a).bind("mUpdateBoundingBox",function(b,d){var e=d.left-d.currentWidth/2,g=d.top-d.currentHeight/2;a.setBoundingBox([e,g,e+d.currentWidth,g+d.currentHeight])});$(a).bind("vRenderNeume",function(a,d){d.typeid||d.deriveName();b.render(d)});$(a).bind("vUpdateDrawing",function(a,d){b.updateDrawing(d)});$(a).bind("vEraseDrawing",function(){b.eraseDrawing()});$(a).bind("vSelectDrawing",function(){b.selectDrawing()})};
Toe.Ctrl.NeumeController.prototype.constructor=Toe.Ctrl.NeumeController;Toe.View.NeumeView=function(a){this.rendEng=a;this.ledgerLines=this.drawing=null};Toe.View.NeumeView.prototype.constructor=Toe.View.NeumeView;Toe.View.NeumeView.prototype.calcNoteYPos=function(a){var b=a.staff,c=[];c.push(b.zone.uly-a.rootStaffPos*b.delta_y/2);for(var d=1;d<a.components.length;d++)c.push(c[0]+-a.components[d].pitchDiff*b.delta_y/2);return c};
Toe.View.NeumeView.prototype.bestDotPlacements=function(a,b,c){var d=[],e=a.zone.uly+a.delta_y/2,g=ypos=b[c],f=Math.round(2*(g-e)/a.delta_y);0==f%2&&d.push(g);var l=ypos-a.delta_y/2,f=Math.round(2*(l-e)/a.delta_y),g=!1;if(0<=c-1&&ypos-a.delta_y/2==b[c-1]||c+1<b.length&&ypos-a.delta_y/2==b[c+1])g=!0;0==f%2&&!g&&d.push(l);l=ypos+a.delta_y/2;f=Math.round(2*(l-e)/a.delta_y);g=!1;if(c+1<b.length&&ypos+a.delta_y/2==b[c+1]||0<=c-1&&ypos+a.delta_y/2==b[c-1])g=!0;0==f%2&&!g&&d.push(l);return d};
Toe.View.NeumeView.prototype.drawLedgerLines=function(a,b,c,d){var c=0.75*c,e=this,g=[],f=2*(1-d.props.numLines);$.each(a,function(a,j){if(0<j)for(var h=0;h<=j;h+=2){var i=d.zone.uly-h*d.delta_y/2;g.push(e.rendEng.createLine([b[a]-c,i,b[a]+c,i]))}else if(j<f)for(h=f;h>=j;h-=2)i=d.zone.uly-h*d.delta_y/2,g.push(e.rendEng.createLine([b[a]-c,i,b[a]+c,i]))});this.ledgerLines=this.rendEng.draw({fixed:g,modify:[]},{group:!0,selectable:!1})[0]};
Toe.View.NeumeView.prototype.drawNeume=function(a){if(!this.rendEng)throw Error("Neume: Invalid render context");this.ledgerLines&&this.rendEng.canvas.remove(this.ledgerLines);for(var b=this.calcNoteYPos(a),c=a.staff,d=this,e=[],g=0;g<a.components.length;g++){var f=null;switch(a.components[g].props.name){case Toe.Model.NeumeComponent.Type.punctum:f="punctum";break;case Toe.Model.NeumeComponent.Type.virga:f="punctum";break;case Toe.Model.NeumeComponent.Type.cavum:f="whitepunct";break;case Toe.Model.NeumeComponent.Type.punctum_inclinatum:f=
"diamond";break;case Toe.Model.NeumeComponent.Type.punctum_inclinatum_parvum:f="diamond_small";break;case Toe.Model.NeumeComponent.Type.quilisma:f="quilisma"}e.push(this.rendEng.getGlyph(f))}var l=this.rendEng.getGlyph("dot"),j={fixed:[],modify:[]};switch(a.typeid){case "punctum":g=a.zone.ulx+e[0].centre[0];f=e[0].clone().set({left:g,top:b[0]});j.modify.push(f);if(a.components[0].hasOrnament("dot")){var h=this.bestDotPlacements(c,b,0);j.modify.push(l.clone().set({left:f.left+2*e[0].centre[0],top:h[0]}))}this.drawLedgerLines([a.rootStaffPos],
[g],2*e[0].centre[0],c);break;case "cavum":g=a.zone.ulx+e[0].centre[0];f=e[0].clone().set({left:g,top:b[0]});j.modify.push(f);a.components[0].hasOrnament("dot")&&(h=this.bestDotPlacements(c,b,0),j.modify.push(l.clone().set({left:f.left+2*e[0].centre[0],top:h[0]})));this.drawLedgerLines([a.rootStaffPos],[g],2*e[0].centre[0],c);break;case "virga":g=a.zone.ulx+e[0].centre[0];f=e[0].clone().set({left:g,top:b[0]});j.modify.push(f);a.components[0].hasOrnament("dot")&&(h=this.bestDotPlacements(c,b,0),j.modify.push(l.clone().set({left:f.left+
2*e[0].centre[0],top:h[0]})));var i=f.left+e[0].centre[0]-1,i=this.rendEng.createLine([i,b[0],i,b[0]+1.5*c.delta_y],{strokeWidth:2,interact:!0});j.fixed.push(i);this.drawLedgerLines([a.rootStaffPos],[g],2*e[0].centre[0],c);break;case "clivis":var k=[];k.push(a.zone.ulx+e[0].centre[0]);var m=e[0].clone().set({left:k[0],top:b[0]});j.modify.push(m);i=m.left+e[0].centre[0]-1;i=this.rendEng.createLine([i,b[0],i,b[1]],{strokeWidth:2,interact:!0});j.fixed.push(i);k.push(k[0]+2*e[1].centre[0]);var n=e[1].clone().set({left:k[1],
top:b[1]});j.modify.push(n);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&j.modify.push(l.clone().set({left:n.left+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "cephalicus":k=[];h=this.rendEng.getGlyph("cephalicus");k.push(a.zone.ulx+h.centre[0]);m=h.clone().set({left:k[0],top:b[0]-h.centre[1]/2});j.modify.push(m);f=k[0]-h.centre[0]+
1;i=this.rendEng.createLine([f,b[0],f,a.zone.lry],{strokeWidth:2,interact:!0});j.fixed.push(i);i=m.left+h.centre[0]-2;i=this.rendEng.createLine([i,b[0],i,b[1]],{strokeWidth:2,interact:!0});j.fixed.push(i);f=this.rendEng.getGlyph("liques_up");k.push(k[0]+h.centre[0]-f.centre[0]);n=f.clone().set({left:k[1],top:b[1]-f.centre[1]/2});j.modify.push(n);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&j.modify.push(l.clone().set({left:n.left+2*e[1].centre[0],
top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "climacus.1":case "climacus.2":case "climacus.3":case "climacus.4":k=[];k.push(a.zone.ulx+e[0].centre[0]);h=e[0].centre[0];f=e[0].clone().set({left:k[0],top:b[0]});j.modify.push(f);i=f.left+e[0].centre[0]-1;i=this.rendEng.createLine([i,b[0],i,b[0]+1.5*c.delta_y],{strokeWidth:2,interact:!0});j.fixed.push(i);for(f=1;f<a.components.length;f++)k.push(k[f-1]+2*e[f-1].centre[0]-
1),1==f&&(k[1]+=h),i=e[f].clone().set({left:k[f],top:b[f]}),j.modify.push(i);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&j.modify.push(l.clone().set({left:k[a]+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "torculus":k=[];k.push(a.zone.ulx+e[0].centre[0]);k.push(k[0]+2*e[0].centre[0]-1);k.push(k[1]+2*e[1].centre[0]-1);m=e[0].clone().set({left:k[0],
top:b[0]});j.modify.push(m);i=m.left+e[0].centre[0]-1;i=this.rendEng.createLine([i,b[0],i,b[1]],{strokeWidth:2,interact:!0});j.fixed.push(i);n=e[1].clone().set({left:k[1],top:b[1]});j.modify.push(n);i=n.left+e[1].centre[0]-1;i=this.rendEng.createLine([i,b[1],i,b[2]],{strokeWidth:2,interact:!0});j.fixed.push(i);f=e[2].clone().set({left:k[2],top:b[2]});j.modify.push(f);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&j.modify.push(l.clone().set({left:k[a]+
2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "torculus.resupinus.1":case "torculus.resupinus.2":case "torculus.resupinus.3":case "torculus.resupinus.4":k=[];k.push(a.zone.ulx+e[0].centre[0]);m=e[0].clone().set({left:k[0],top:b[0]});j.modify.push(m);h=this.rendEng.getGlyph("porrect_1");g=h.clone().set({left:k[0]+e[0].centre[0]+h.centre[0]-1,top:b[1]+h.centre[1]/2});j.modify.push(g);var f=g.left-
h.centre[0],i=b[0],o=g.top+h.centre[1],i=this.rendEng.createLine([f,b[1],f,i],{strokeWidth:2,interact:!0});j.fixed.push(i);"torculus.resupinus.1"==a.typeid?k.push(g.left+h.centre[0]-e[3].centre[0]):k.push(g.left+h.centre[0]+e[3].centre[0]);f=e[3].clone().set({left:k[1],top:b[3]});j.modify.push(f);i=g.left+h.centre[0]-1;i=this.rendEng.createLine([i,b[3],i,b[2]],{strokeWidth:2,interact:!0});j.fixed.push(i);"torculus.resupinus.2"==a.typeid&&(i=f.left+e[3].centre[0]-1,i=this.rendEng.createLine([i,b[4],
i,b[3]],{strokeWidth:2,interact:!0}),j.fixed.push(i));for(f=4;f<a.components.length;f++)k.push(k[k.length-1]+2*e[f].centre[0]-1),h=e[f].clone().set({left:k[k.length-1],top:b[f]}),j.modify.push(h);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);g.length>0&&j.modify.push(l.clone().set({left:k[a]+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "podatus":k=
[];k.push(a.zone.ulx+e[0].centre[0]);m=e[0].clone().set({left:k[0],top:b[0]});j.modify.push(m);k.push(k[0]+2*e[1].centre[0]);n=e[1].clone().set({left:k[1],top:b[1]});j.modify.push(n);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&j.modify.push(l.clone().set({left:m.left+2*e[1].centre[0],top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "epiphonus":k=[];h=this.rendEng.getGlyph("podatus_ep");
k.push(a.zone.ulx+h.centre[0]);m=h.clone().set({left:k[0],top:b[0]});j.modify.push(m);i=m.left+h.centre[0]-2;i=this.rendEng.createLine([i,b[0],i,b[1]],{strokeWidth:2,interact:!0});j.fixed.push(i);f=this.rendEng.getGlyph("liques_down");k.push(k[0]+h.centre[0]-f.centre[0]);n=f.clone().set({left:k[1],top:b[1]+f.centre[1]/2});j.modify.push(n);$.each(a.components,function(a,f){if(f.hasOrnament("dot")){var g=d.bestDotPlacements(c,b,a);0<g.length&&j.modify.push(l.clone().set({left:m.left+2*e[1].centre[0],
top:g[0]}))}});this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],c);break;case "porrectus":f=a.components[0].pitchDiff+a.components[1].pitchDiff;h=null;switch(f){case -1:h=this.rendEng.getGlyph("porrect_1");break;case -2:h=this.rendEng.getGlyph("porrect_2");break;case -3:h=this.rendEng.getGlyph("porrect_3");break;case -4:h=this.rendEng.getGlyph("porrect_4");break;default:h=this.rendEng.getGlyph("porrect_4")}g=h.clone().set({left:a.zone.ulx+
h.centre[0],top:b[0]+h.centre[1]/2});j.modify.push(g);f=g.left-h.centre[0]+1;i=a.zone.lry;o=g.top+h.centre[1];a.zone.lry<g.top+o&&(i=o);i=this.rendEng.createLine([f,b[0],f,i],{strokeWidth:2,interact:!0});j.fixed.push(i);k=g.left+h.centre[0]-e[2].centre[0];f=e[2].clone().set({left:k,top:b[2]});i=f.left+e[2].centre[0]-1;i=this.rendEng.createLine([i,b[2],i,b[1]],{strokeWidth:2,interact:!0});j.fixed.push(i);j.modify.push(f);a.components[2].hasOrnament("dot")&&(h=this.bestDotPlacements(c,b,2),0<h.length&&
j.modify.push(l.clone().set({left:f.left+2*e[2].centre[0],top:h[0]})));this.drawLedgerLines([a.rootStaffPos+a.components[2].pitchDiff],[k],2*e[2].centre[0],c);break;case "porrectus.flexus":h=this.rendEng.getGlyph("porrect_1");g=h.clone().set({left:a.zone.ulx+h.centre[0],top:b[0]+h.centre[1]/2});j.modify.push(g);f=g.left-h.centre[0]+1;i=a.zone.lry;o=g.top+h.centre[1];a.zone.lry<g.top+o&&(i=o);i=this.rendEng.createLine([f,b[0],f,i],{strokeWidth:2,interact:!0});j.fixed.push(i);k=[];k.push(g.left+h.centre[0]+
e[2].centre[0]);f=e[2].clone().set({left:k[0],top:b[2]});i=k[0]-e[2].centre[0]-1;i=this.rendEng.createLine([i,b[2],i,b[1]],{strokeWidth:2,interact:!0});j.fixed.push(i);j.modify.push(f);for(f=3;f<a.components.length;f++)k.push(k[k.length-1]+2*e[f].centre[0]-1),h=e[f].clone().set({left:k[k.length-1],top:b[f]}),j.modify.push(h);for(f=2;f<a.components.length;f++)a.components[f].hasOrnament("dot")&&(h=d.bestDotPlacements(c,b,it),0<h.length&&j.modify.push(l.clone().set({left:m.left+2*e[1].centre[0],top:h[0]})));
break;case "scandicus.1":case "scandicus.2":case "scandicus.3":case "scandicus.4":i=a.components.length;o=a.zone.ulx-e[0].centre[0];k=[];for(f=0;f<i-1;f+=2){yoffset=0;1==Math.abs(a.components[f+1].pitchDiff-a.components[f].pitchDiff)&&(yoffset=1);o+=2*e[f].centre[0]-1;k.push(o);h=e[f].clone().set({left:k[f],top:b[f]-e[f].centre[1]/2+yoffset});j.modify.push(h);k.push(k[f]+2*e[f+1].centre[0]);n=e[f+1].clone().set({left:k[f+1],top:b[f+1]-yoffset});j.modify.push(n);for(g=f;g<f+2;g++)a.components[g].hasOrnament("dot")&&
(h=this.bestDotPlacements(c,b,g),0<h.length&&j.modify.push(l.clone().set({left:n.left+2*e[g].centre[0],top:h[0]})))}1==a.components.length%2&&(o+=2*e[i-1].centre[0]-1,k.push(o),f=e[i-1].clone().set({left:o,top:b[i-1]}),j.modify.push(f),a.components[i-1].hasOrnament("dot")&&(h=this.bestDotPlacements(c,b,i-1),0<h.length&&j.modify.push(l.clone().set({left:f.left+2*e[i-1].centre[0],top:h[0]}))));this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+b.pitchDiff}),k,2*e[0].centre[0],
c);break;case "scandicus.flexus.1":k=[];k.push(a.zone.ulx+e[0].centre[0]);m=e[0].clone().set({left:k[0],top:b[0]});j.modify.push(m);i=m.left+e[0].centre[0];i=this.rendEng.createLine([i,b[0],i,b[1]],{strokeWidth:2,interact:!0});j.fixed.push(i);k.push(k[0]+2*e[1].centre[0]);n=e[1].clone().set({left:k[1],top:b[1]});j.modify.push(n);for(g=0;2>g;g++)a.components[g].hasOrnament("dot")&&(h=this.bestDotPlacements(c,b,g),0<h.length&&j.modify.push(l.clone().set({left:k[g]+2*e[g].centre[0],top:h[0]})));k.push(k[1]+
2*e[2].centre[0]);f=e[2].clone().set({left:k[2],top:b[2]});j.modify.push(f);i=k[2]+e[2].centre[0]-1;i=this.rendEng.createLine([i,b[2],i,b[3]],{strokeWidth:2,interact:!0});j.fixed.push(i);k.push(k[2]+2*e[3].centre[0]);f=e[3].clone().set({left:k[3],top:b[3]});j.modify.push(f);for(g=2;g<a.components.length;g++)a.components[g].hasOrnament("dot")&&(h=d.bestDotPlacements(c,b,it),0<h.length&&j.modify.push(l.clone().set({left:n.left+2*e[1].centre[0],top:h[0]})));this.drawLedgerLines($.map(a.components,function(b){return a.rootStaffPos+
b.pitchDiff}),k,2*e[0].centre[0],c)}this.drawing=this.rendEng.draw(j,{group:!0,selectable:a.props.interact,eleRef:a})[0];$(a).trigger("mUpdateBoundingBox",this.drawing)};Toe.View.NeumeView.prototype.render=function(a){this.drawNeume(a)};Toe.View.NeumeView.prototype.updateDrawing=function(a){this.drawing&&this.rendEng.canvas.remove(this.drawing);this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);this.drawNeume(a);this.selectDrawing();this.rendEng.repaint()};
Toe.View.NeumeView.prototype.eraseDrawing=function(){this.drawing&&this.rendEng.canvas.remove(this.drawing);this.ledgerLines&&(this.rendEng.canvas.remove(this.ledgerLines),this.ledgerLines=null);this.rendEng.repaint()};Toe.View.NeumeView.prototype.selectDrawing=function(){this.rendEng.canvas.setActiveObject(this.drawing)};Toe.Model.Ornament=function(a,b){this.key=a.toLowerCase();this.type=Toe.Model.Ornament.Type[this.key];if(void 0==this.type)throw Error("Ornament: undefined ornament type");oForm="episema"==a?"horizontal":"dot"==a?"aug":null;this.props={form:oForm,interact:!1};$.extend(this.props,b)};Toe.Model.Ornament.prototype.constructor=Toe.Model.Ornament;Toe.Model.Ornament.Type={episema:"Episema",dot:"Dot"};Toe.Model.Page=function(){this.staves=[];this.scale=1};Toe.Model.Page.prototype.constructor=Toe.Model.Page;Toe.Model.Page.prototype.setDimensions=function(a,b){this.width=this.scale*a;this.height=this.scale*b};Toe.Model.Page.prototype.calcDimensions=function(a){var b=0,c=0;$(a).each(function(a,e){var g=parseInt($(e).attr("lrx")),f=parseInt($(e).attr("lry"));g>b&&(b=g);f>c&&(c=f)});return[b,c]};Toe.Model.Page.prototype.setPageScale=function(a){this.scale=a};
Toe.Model.Page.prototype.getClosestStaff=function(a){for(var b=this.staves.length-1,c=0;c<this.staves.length-1;c++)if(a.y<this.staves[c].zone.lry+(this.staves[c+1].zone.uly-this.staves[c].zone.lry)/2){b=c;break}return this.staves[b]};Toe.Model.Page.prototype.getNextStaff=function(a){a=$.inArray(a,this.staves);return-1!=a&&a+1<this.staves.length?this.staves[a+1]:null};Toe.Model.Page.prototype.getPreviousStaff=function(a){a=$.inArray(a,this.staves);return 0<=a-1?this.staves[a-1]:null};
Toe.Model.Page.prototype.addStaff=function(a){this.staves.push(a);$(a).trigger("vRenderStaff",[a]);return this};Toe.Ctrl.PageController=function(a,b){$(b).bind("mSetDimensions.ui",function(b,d,e){a.setDimensions(d,e)});$(a).bind("vSetDimensions",function(a,d,e){b.setDimensions(d,e)})};Toe.Ctrl.PageController.prototype.constructor=Toe.Ctrl.PageController;Toe.View.PageView=function(a){this.rendEng=a};Toe.View.PageView.prototype.constructor=Toe.View.PageView;Toe.View.PageView.prototype.setDimensions=function(a,b){this.canvas.setDimensions({width:a,height:b})};Toe.View.RenderEngine=function(a){this.options={globScale:0.08};$.extend(this.options,a)};Toe.View.RenderEngine.prototype.constructor=Toe.View.RenderEngine;Toe.View.RenderEngine.prototype.setGlyphs=function(a){this.glyphs=a};Toe.View.RenderEngine.prototype.setCanvas=function(a){this.canvas=a;this.canvas.HOVER_CURSOR="pointer"};Toe.View.RenderEngine.prototype.setGlobalScale=function(a){this.options.globScale=a;$.each(this.glyphs,function(b,c){c.centre=[c.centre[0]*a,c.centre[1]*a]})};
Toe.View.RenderEngine.prototype.getGlobalScale=function(){return this.options.globScale};Toe.View.RenderEngine.prototype.getGlyph=function(a){return this.glyphs[a]};Toe.View.RenderEngine.prototype.calcScaleFromStaff=function(a,b){opts={overwrite:!1};$.extend(opts,b);var c=(a.zone.lry-a.zone.uly)/(a.props.numLines-1),c=2*c-0.65*c,d=this.getGlyph("c_clef").clone().height;scale=Math.abs(c/d);opts.overwrite&&this.setGlobalScale(scale);return scale};
Toe.View.RenderEngine.prototype.createLine=function(a,b){var c={fill:"rgb(0,0,0)",strokeWidth:3,opacity:1,interact:!1};$.extend(c,b);return new fabric.Line(a,{fill:c.fill,strokeWidth:c.strokeWidth,opacity:c.opacity,selectable:c.interact})};
Toe.View.RenderEngine.prototype.outlineBoundingBox=function(a,b){var c={fill:"rgb(0,255,0)",opacity:0.65,interact:!1};$.extend(c,b);var d=a[2]-a[0],e=a[3]-a[1],a=new fabric.Rect({width:d,height:e,left:a[0]+d/2,top:a[1]+e/2,fill:c.fill,opacity:c.opacity}),d={fixed:[],modify:[]};d.fixed.push(a);this.draw(d,{selectable:c.interact,opacity:c.opacity})};
Toe.View.RenderEngine.prototype.draw=function(a,b){var c={modify:!0,repaint:!1,group:!1,selectable:!0,hasControls:!1,hasBorders:!1,lockMovementX:!1,lockMovementY:!1,opacity:1,eleRef:null};$.extend(c,b);a.modify=this.preprocess(a.modify);a=$.merge($.merge([],a.modify),a.fixed);c.group&&(a=[new fabric.Group(a)]);$.map(a,function(a){a.selectable=c.selectable;a.hasControls=c.hasControls;a.lockRotation=!0;a.lockScale=!0;a.lockMovementX=c.lockMovementX;a.lockMovementY=c.lockMovementY;a.opacity=c.opacity;
a.eleRef=c.eleRef});for(var d=0;d<a.length;d++)this.canvas.add(a[d]);c.repaint&&this.repaint();return a};Toe.View.RenderEngine.prototype.unObserve=function(a){delete this.canvas.__eventListeners[a]};Toe.View.RenderEngine.prototype.repaint=function(){this.canvas.renderAll()};Toe.View.RenderEngine.prototype.preprocess=function(a){for(var b=0;b<a.length;b++)a[b]=a[b].scale(this.options.globScale),a[b].currentWidth*=this.options.globScale,a[b].currentHeight*=this.options.globScale;return a};Toe.Model.Staff=function(a,b){if(!Toe.validBoundingBox(a))throw Error("Staff: invalid bounding box");this.zone={};this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3];this.props={numLines:4,interact:!1};$.extend(this.props,b);this.delta_y=Math.abs(this.zone.lry-this.zone.uly)/(this.props.numLines-1);this.custos=this.id=null;this.elements=[]};Toe.Model.Staff.prototype.constructor=Toe.Model.Staff;Toe.Model.Staff.prototype.setID=function(a){this.id=a};
Toe.Model.Staff.prototype.setBoundingBox=function(a){if(!Toe.validBoundingBox(a))throw Error("Staff: invalid bounding box");a=$.map(a,Math.round);this.zone.ulx=a[0];this.zone.uly=a[1];this.zone.lrx=a[2];this.zone.lry=a[3];this.delta_y=Math.abs(this.zone.lry-this.zone.uly)/(this.props.numLines-1)};
Toe.Model.Staff.prototype.getPitchedElements=function(a){var b={clef:null,neumes:!0,custos:!0};$.extend(b,a);if(b.clef){for(var a=[],c=$.inArray(b.clef,this.elements)+1;c<this.elements.length&&!(this.elements[c]instanceof Toe.Model.Clef);c++){var d=this.elements[c];(d instanceof Toe.Model.Neume&&b.neumes||d instanceof Toe.Model.Custos&&b.custos)&&a.push(d)}return a}return $.grep(this.elements,function(a){if(a instanceof Toe.Model.Neume&&b.neumes||a instanceof Toe.Model.Custos&&b.custos)return a})};
Toe.Model.Staff.prototype.calcPitchFromStaffPos=function(a,b){var c=a-b.props.staffPos,d=Toe.neumaticChroma.length,e=$.inArray(b.shape,Toe.neumaticChroma),g=(e+c)%d;0>g&&(g+=d);var f=Toe.neumaticChroma[g],l=$.inArray("c",Toe.neumaticChroma),d=$.truncateFloat(c/d);0<c&&g>=l&&g<e?d++:0>c&&(g<l||g>e)&&d--;c=4;"f"==b.shape&&(c=3);return{pname:f,oct:c+d}};
Toe.Model.Staff.prototype.calcStaffPosFromPitch=function(a,b,c){var d=4;"f"==c.shape&&(d=3);var e=Toe.neumaticChroma.length,g=$.inArray(c.shape,Toe.neumaticChroma),a=$.inArray(a,Toe.neumaticChroma),f=$.inArray("c",Toe.neumaticChroma),b=a-g+e*(b-d);a<f&&(b+=e);return c.props.staffPos+b};Toe.Model.Staff.prototype.calcPitchFromCoords=function(a){var b=Math.round((this.zone.uly-a.y)/(this.delta_y/2)),a=this.getActingClefByCoords(a);return this.calcPitchFromStaffPos(b,a)};
Toe.Model.Staff.prototype.updatePitchedElements=function(a){var b={clef:null,neumes:!0,custos:!1};$.extend(b,a);var c=this;if(b.clef)a=this.getPitchedElements({clef:b.clef}),this.custos&&(a[a.length-1]==this.custos&&!b.custos)&&(this.custos.setRootStaffPos(this.calcStaffPosFromPitch(this.custos.pname,this.custos.oct,b.clef)),a.pop()),$.each(a,function(a,d){c.updateElePitchInfo(d,{clef:b.clef})});else{var d=null;$.each(this.elements,function(a,g){g instanceof Toe.Model.Clef?d=g:d&&(g instanceof Toe.Model.Neume&&
b.neumes||g==this.custos&&b.custos)?c.updateElePitchInfo(g,{clef:d}):this.custos&&(g==this.custos&&!b.custos)&&this.custos.setRootStaffPos(this.calcStaffPosFromPitch(this.custos.pname,this.custos.oct,d))})}};
Toe.Model.Staff.prototype.updateElePitchInfo=function(a,b){var c={clef:null};$.extend(c,b);c.clef||(c.clef=this.getActingClefByEle(a));var d=this;if(a instanceof Toe.Model.Neume)$.each(a.components,function(b,f){var e=d.calcPitchFromStaffPos(a.rootStaffPos+f.pitchDiff,c.clef);f.setPitchInfo(e.pname,e.oct)});else if(a instanceof Toe.Model.Custos){var e=this.calcPitchFromStaffPos(a.rootStaffPos,c.clef);a.setRootNote(e.pname,e.oct)}};Toe.Model.Staff.prototype.calcPitchDifference=function(){};
Toe.Model.Staff.prototype.sortElements=function(){this.elements.sort(function(a,b){return a.zone.ulx-b.zone.ulx})};Toe.Model.Staff.prototype.insertElement=function(a){for(var b=this.elements.length,c=0;c<this.elements.length;c++)if(a.zone.ulx<=this.elements[c].zone.ulx){b=c;break}this.elements.splice(b,0,a);return b};
Toe.Model.Staff.prototype.removeElementByID=function(a){for(var b=this.elements.length-1;0<=b;b--)this.elements[b].id==a&&($(this.elements[b]).trigger("vEraseDrawing"),this.elements.splice(b,1))};Toe.Model.Staff.prototype.removeElementByRef=function(a){a=$.inArray(a,this.elements);0<=a&&($(this.elements[a]).trigger("vEraseDrawing"),this.elements.splice(a,1))};Toe.Model.Staff.prototype.getActingClefByEle=function(a){for(a=$.inArray(a,this.elements);0<=a;a--){var b=this.elements[a];if(b instanceof Toe.Model.Clef)return b}return null};
Toe.Model.Staff.prototype.getActingClefByCoords=function(a){for(var b=this.elements.length;0<=b;b--){var c=this.elements[b];if(c instanceof Toe.Model.Clef&&a.x>c.zone.lrx)return c}return null};Toe.Model.Staff.prototype.getPreviousClef=function(a){a=$.inArray(a,this.elements);if(0<a)for(a-=1;0<=a;a--)if(this.elements[a]instanceof Toe.Model.Clef)return this.elements[a];return null};
Toe.Model.Staff.prototype.addClef=function(a,b){if(!(a instanceof Toe.Model.Clef))throw Error("Staff: Invalid clef");var c={justPush:!1};$.extend(c,b);var d=null;c.justPush?(this.elements.push(a),d=this.elements.length-1):d=this.insertElement(a);a.setStaff(this);this.updatePitchedElements({clef:a,custos:!1});$(a).trigger("vRenderClef",[a]);return d};
Toe.Model.Staff.prototype.setCustos=function(a){if(!(a instanceof Toe.Model.Custos))throw Error("Staff: Invalid Custos");var b=this.getActingClefByCoords({x:a.zone.ulx});b&&(a.rootStaffPos=this.calcStaffPosFromPitch(a.pname,a.oct,b),0<this.elements.length&&this.elements[this.elements.length-1]instanceof Toe.Model.Custos?this.elements[this.elements.length-1]=a:this.elements.push(a),a.setStaff(this),this.custos=a,$(a).trigger("vRenderCustos",[a]));return this.elements.length-1};
Toe.Model.Staff.prototype.addNeume=function(a,b){if(!(a instanceof Toe.Model.Neume))throw Error("Staff: Invalid neume");var c={justPush:!1};$.extend(c,b);var d=this.getActingClefByCoords({x:a.zone.ulx});if(d){a.getRootPitchInfo();a.rootStaffPos=this.calcStaffPosFromPitch(a.components[0].pname,a.components[0].oct,d);a.components[0].setPitchDifference(0);for(var e=1;e<a.components.length;e++){var g=a.components[e];g.setPitchDifference(this.calcStaffPosFromPitch(g.pname,g.oct,d)-a.rootStaffPos)}d=null;
c.justPush?(this.elements.push(a),d=this.elements.length-1):d=this.insertElement(a);a.setStaff(this);$(a).trigger("vRenderNeume",[a]);return d}return null};Toe.Model.Staff.prototype.addDivision=function(a,b){if(!(a instanceof Toe.Model.Division))throw Error("Staff: invalid division");var c={justPush:!1};$.extend(c,b);var d=null;c.justPush?(this.elements.push(a),d=this.elements.length-1):d=this.insertElement(a);a.setStaff(this);$(a).trigger("vRenderDivision",[a]);return d};
Toe.Model.Staff.prototype.ohSnap=function(a,b,c){var d={ignoreEle:null,x:!0,y:!0};$.extend(d,c);if(d.y){var c=this.zone.uly,e=this.zone.uly+this.delta_y/2,g=(a.y-c)/this.delta_y,f=Math.abs(Math.round(Math.abs(g))-Math.abs(g)),l=(a.y-e)/this.delta_y,j=Math.abs(Math.round(Math.abs(l))-Math.abs(l));a.y=Math.min(f,j)==f?c+Math.round(g)*this.delta_y:e+Math.round(l)*this.delta_y}if(d.x){c=a.x-b/2;e=a.x+b/2;for(g=0;g<this.elements.length;g++)if(this.elements[g]!=d.ignoreEle&&(f=this.elements[g].zone.ulx,
l=this.elements[g].zone.lrx,!(c>=l))){a.x=c>=f&&c<l||e>=f&&e<l||f>c&&l<e?a.x<f+(l-f)/2?f-b/2:l+b/2:a.x;break}this.elements.length&&this.elements[0]instanceof Toe.Model.Clef&&c<=this.elements[0].zone.lrx?a.x=this.elements[0].zone.lrx+b/2+1:c<=this.zone.ulx&&(a.x=this.zone.ulx+b/2+1);this.custos&&d.ignoreEle!=this.custos&&e>=this.custos.zone.ulx?a.x=this.custos.zone.ulx-b/2-3:e>=this.zone.lrx&&(a.x=this.zone.lrx-b/2-3)}return a};Toe.Ctrl.StaffController=function(a,b){$(a).bind("vRenderStaff",function(a,d){b.renderStaff(d)})};Toe.Ctrl.StaffController.prototype.constructor=Toe.Ctrl.StaffController;Toe.View.StaffView=function(a){this.rendEng=a};Toe.View.StaffView.prototype.constructor=Toe.View.StaffView;Toe.View.StaffView.prototype.renderStaff=function(a){if(!this.rendEng)throw Error("Staff: Invalid render context");for(var b={fixed:[],modify:[]},c=0;c<a.props.numLines;c++){var d=a.zone.uly+c*a.delta_y;b.fixed.push(this.rendEng.createLine([a.zone.ulx,d,a.zone.lrx,d]))}this.rendEng.draw(b,{selectable:a.props.interact})};
